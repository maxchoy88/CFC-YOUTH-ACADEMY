<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CFC Youth Academy</title>
    
    <!-- æ ·å¼ä¸å›¾æ ‡ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">

    <!-- React æ ¸å¿ƒ -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

    <style>
        body { background-color: #09090b; color: #fff; font-family: sans-serif; -webkit-tap-highlight-color: transparent; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        /* è£å‰ªå™¨å®¹å™¨æ ·å¼ */
        .cropper-container { max-height: 60vh; background-color: #000; }
        #static-loading { position: fixed; inset: 0; display: flex; flex-direction: column; justify-content: center; align-items: center; background: #09090b; z-index: 50; }
        .hidden { display: none !important; }
        /* æ—¥æœŸé€‰æ‹©å™¨æ·±è‰²æ¨¡å¼é€‚é… */
        input[type="date"] { color-scheme: dark; }
        input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(1); cursor: pointer; opacity: 0.8; }
        input[type="date"]:hover::-webkit-calendar-picker-indicator { opacity: 1; }
    </style>
</head>
<body>
    <div id="static-loading">
        <i class="fa-solid fa-shield-halved text-yellow-500 text-5xl fa-beat mb-4"></i>
        <h2 class="text-xl font-bold">CFC ACADEMY</h2>
        <p class="text-zinc-500 text-sm mt-2">System Restored...</p>
    </div>

    <div id="root"></div>

    <script type="text/babel">
        // --- 0. å®‰å…¨æ£€æŸ¥ ---
        if (!window.React || !window.ReactDOM) {
            document.getElementById('static-loading').innerHTML = '<p class="text-red-500 p-4">é”™è¯¯ï¼šReact åŠ è½½å¤±è´¥ã€‚è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ã€‚</p>';
            throw new Error("React æœªåŠ è½½");
        }

        const { useState, useEffect, useRef, useMemo } = React;

        // ç§»é™¤åŠ è½½åŠ¨ç”»
        setTimeout(() => {
            const loader = document.getElementById('static-loading');
            if(loader) loader.classList.add('hidden');
        }, 1000); 

        // --- å¤šè¯­è¨€å­—å…¸ ---
        const TRANSLATIONS = {
            zh: {
                appTitle: "CFC YOUTH ACADEMY",
                systemName: "é’è®­å­¦é™¢ç³»ç»Ÿ",
                localMode: "æœ¬åœ°ç‰ˆ",
                backupRestore: "å¤‡ä»½/æ¢å¤",
                manageSchools: "å­¦æ ¡",
                attendanceTool: "è€ƒå‹¤", 
                register: "æ³¨å†Œ",
                searchPlaceholder: "æœç´¢å§“åã€å­¦æ ¡...",
                noData: "æš‚æ— çƒå‘˜æ•°æ®",
                age: "å¹´é¾„",
                category: "ç»„åˆ«", 
                height: "èº«é«˜",
                weight: "ä½“é‡",
                attendance: "å‡ºå¸­ç‡",
                coachReport: "æ•™ç»ƒæŠ¥å‘Š",
                editReport: "ç¼–è¾‘æŠ¥å‘Š",
                edit: "ç¼–è¾‘",
                delete: "åˆ é™¤",
                aiAnalyze: "æ•™ç»ƒåˆ†æ",
                updateProfile: "æ›´æ–°æ¡£æ¡ˆ",
                newPlayer: "æ–°çƒå‘˜",
                name: "å§“å",
                nationality: "å›½ç±",
                school: "æ‰€å±å­¦æ ¡",
                mainPos: "ä¸»ä½ç½®",
                subPos: "å‰¯ä½ç½®",
                save: "ä¿å­˜",
                cancel: "å–æ¶ˆ",
                addSchool: "æ–°å¢å­¦æ ¡",
                backupTools: "å¤‡ä»½å·¥å…·",
                backupToDrive: "å¤‡ä»½åˆ° Google Drive",
                exportDesc: "ç”Ÿæˆå¤‡ä»½æ–‡ä»¶å¹¶è‡ªåŠ¨æ‰“å¼€ä½ çš„äº‘ç«¯æ–‡ä»¶å¤¹ã€‚",
                restoreData: "æ¢å¤æ•°æ®",
                restoreDesc: "ä»æ‰‹æœºæ–‡ä»¶å¤¹ä¸­é€‰æ‹©ä¹‹å‰çš„å¤‡ä»½æ–‡ä»¶ (.json)ã€‚",
                selectFile: "é€‰æ‹©å¤‡ä»½æ–‡ä»¶",
                shareProfile: "åˆ†äº«æ¡£æ¡ˆ",
                sendToParents: "å‘é€ç»™å®¶é•¿ (å«ç…§ç‰‡)",
                textOnly: "ä»…å‘é€æ–‡å­—æŠ¥å‘Š",
                cropTitle: "è£å‰ªå¤´åƒ",
                rotate: "æ—‹è½¬",
                confirmCrop: "ç¡®è®¤è£å‰ª",
                attTitle: "æ™ºèƒ½è€ƒå‹¤ä¸­å¿ƒ",
                attDate: "è€ƒå‹¤æ—¥æœŸ", 
                attPaste: "ğŸ“„ ç²˜è´´åå•å¯¼å…¥ (WhatsApp/Excel)",
                attPasteDesc: "ç›´æ¥ç²˜è´´æ–‡å­—ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨è¯†åˆ«åå•ä¸­çš„åå­—å¹¶å‹¾é€‰ã€‚",
                attPlaceholder: "ä¾‹å¦‚ï¼šä»Šæ—¥å‡ºå¸­ï¼šArthur, Stella, Money...",
                attConfirm: "æäº¤è€ƒå‹¤è®°å½•",
                attShare: "åˆ†äº«",
                attWhatsapp: "WhatsApp",
                attExcel: "å¯¼å‡º Excel", 
                attTotal: "æ€»åœºæ¬¡",
                attPresent: "å‡ºå¸­",
                stats: { pace: "é€Ÿåº¦", shooting: "å°„é—¨", passing: "ä¼ çƒ", dribbling: "ç›˜å¸¦", defending: "é˜²å®ˆ", physical: "ä½“èƒ½" },
                ai: {
                    analyzing: "æ•™ç»ƒç»„æ­£åœ¨åˆ†æ...",
                    reportTitle: "æ•™ç»ƒæ·±åº¦è¯„ä¼°æŠ¥å‘Š",
                    position: "çƒå‘˜å®šä½",
                    rating: "ç»¼åˆè¯„çº§",
                    strength: "æ ¸å¿ƒç«äº‰åŠ›",
                    suggestion: "æˆ˜æœ¯å»ºè®®",
                    comment: "æ•™ç»ƒè¯„è¯­",
                    template: "å‡è¡¡å‹çƒå‘˜",
                    advice: "éœ€è¿›ä¸€æ­¥è§‚å¯Ÿã€‚",
                    commentText: "æ½œåŠ›ä¸é”™ï¼Œå»ºè®®ç»§ç»­è§‚å¯Ÿã€‚"
                }
            },
            en: {
                appTitle: "CFC YOUTH ACADEMY",
                systemName: "ACADEMY SYSTEM",
                localMode: "Local Mode",
                backupRestore: "Backup",
                manageSchools: "Schools",
                attendanceTool: "Attendance",
                register: "Register",
                searchPlaceholder: "Search name, school...",
                noData: "No player data found",
                age: "Age",
                category: "Category", 
                height: "Height",
                weight: "Weight",
                attendance: "Attendance",
                coachReport: "Coach Report",
                editReport: "Edit Report",
                edit: "Edit",
                delete: "Delete",
                aiAnalyze: "Analysis",
                updateProfile: "Update Profile",
                newPlayer: "New Player",
                name: "Name",
                nationality: "Nationality",
                school: "School",
                mainPos: "Main Pos",
                subPos: "Sub Pos",
                save: "Save",
                cancel: "Cancel",
                addSchool: "Add School",
                backupTools: "Backup Tools",
                backupToDrive: "Backup to Google Drive",
                exportDesc: "Generate backup & open cloud folder.",
                restoreData: "Restore Data",
                restoreDesc: "Select a backup file (.json) to restore.",
                selectFile: "Select File",
                shareProfile: "Share Profile",
                sendToParents: "Send to Parents (w/ Photo)",
                textOnly: "Text Report Only",
                cropTitle: "Crop Photo",
                rotate: "Rotate",
                confirmCrop: "Confirm",
                attTitle: "Smart Attendance",
                attDate: "Date", 
                attPaste: "ğŸ“„ Paste List (WhatsApp/Excel)",
                attPasteDesc: "Auto-check names",
                attPlaceholder: "e.g. Present: Arthur, Stella, Money...",
                attConfirm: "Submit Attendance",
                attShare: "Share",
                attWhatsapp: "WhatsApp",
                attExcel: "Export Excel", 
                attTotal: "Sessions",
                attPresent: "Present",
                stats: { pace: "PAC", shooting: "SHO", passing: "PAS", dribbling: "DRI", defending: "DEF", physical: "PHY" },
                ai: {
                    analyzing: "Coaches analyzing...",
                    reportTitle: "Coach Assessment Report",
                    position: "Role",
                    rating: "Rating",
                    strength: "Key Strength",
                    suggestion: "Tactical Advice",
                    comment: "Coach's Comment",
                    template: "Balanced Player",
                    advice: "Needs further observation.",
                    commentText: "Good potential, keep monitoring."
                }
            },
            ms: {
                appTitle: "AKADEMI BELIA CFC",
                systemName: "SISTEM AKADEMI",
                localMode: "Mod Tempatan",
                backupRestore: "Sandaran",
                manageSchools: "Sekolah",
                attendanceTool: "Kehadiran",
                register: "Daftar",
                searchPlaceholder: "Cari nama, sekolah...",
                noData: "Tiada data pemain",
                age: "Umur",
                category: "Kategori", 
                height: "Tinggi",
                weight: "Berat",
                attendance: "Kehadiran",
                coachReport: "Laporan",
                editReport: "Sunting Laporan",
                edit: "Sunting",
                delete: "Padam",
                aiAnalyze: "Analisis",
                updateProfile: "Kemaskini Profil",
                newPlayer: "Pemain Baru",
                name: "Nama",
                nationality: "Warganegara",
                school: "Sekolah",
                mainPos: "Posisi Utama",
                subPos: "Posisi Kedua",
                save: "Simpan",
                cancel: "Batal",
                addSchool: "Tambah Sekolah",
                backupTools: "Alat Sandaran",
                backupToDrive: "Sandaran ke Google Drive",
                exportDesc: "Jana fail & buka folder awan.",
                restoreData: "Pulihkan Data",
                restoreDesc: "Pilih fail sandaran (.json).",
                selectFile: "Pilih Fail",
                shareProfile: "Kongsi Profil",
                sendToParents: "Hantar ke Ibu Bapa (dgn Foto)",
                textOnly: "Laporan Teks Sahaja",
                cropTitle: "Potong Foto",
                rotate: "Pusing",
                confirmCrop: "Sahkan",
                attTitle: "Pusat Kehadiran",
                attDate: "Tarikh", 
                attPaste: "ğŸ“„ Tampal Senarai (WhatsApp)",
                attPasteDesc: "Tanda nama automatik",
                attPlaceholder: "Contoh: Hadir: Arthur, Stella...",
                attConfirm: "Hantar Kehadiran",
                attShare: "Kongsi",
                attWhatsapp: "WhatsApp",
                attExcel: "Eksport Excel", 
                attTotal: "Sesi",
                attPresent: "Hadir",
                stats: { pace: "Laju", shooting: "Tembak", passing: "Hantar", dribbling: "Gelecek", defending: "Pertahan", physical: "Fizikal" },
                ai: {
                    analyzing: "Jurulatih sedang menganalisis...",
                    reportTitle: "Laporan Penilaian Jurulatih",
                    position: "Peranan",
                    rating: "Penilaian",
                    strength: "Kekuatan Utama",
                    suggestion: "Nasihat Taktikal",
                    comment: "Komen Jurulatih",
                    template: "Pemain Seimbang",
                    advice: "Perlu pemerhatian lanjut.",
                    commentText: "Potensi baik, teruskan memantau."
                }
            }
        };

        const INITIAL_TEAMS = ['çš‡å®¶ä¹¦é™¢', 'æ˜Ÿè€€ä¸­å­¦', 'é›·éœ†ä½“æ ¡', 'è“é¹°å›½é™…', 'åŒ—å¢ƒä¸€ä¸­', 'å—æ´‹å…¬å­¦', 'å…‰è¾‰ä¸­å­¦', 'é£æš´ç«æŠ€', 'é“¶æ²³å®éªŒ', 'æ³°å¦ä¸­å­¦'];
        const CATEGORIES = ['U8', 'U10', 'U12', 'U15', 'U18'];
        const POSITIONS = ['å‰é”‹ (FW)', 'å·¦è¾¹é”‹ (LW)', 'å³è¾¹é”‹ (RW)', 'å‰è…° (CAM)', 'ä¸­åœº (CM)', 'å·¦ä¸­åœº (LM)', 'å³ä¸­åœº (RM)', 'åè…° (CDM)', 'åå« (DF)', 'ä¸­åå« (CB)', 'å·¦åå« (LB)', 'å³åå« (RB)', 'é—¨å°† (GK)'];
        const DEFAULT_IMAGE = 'https://images.unsplash.com/photo-1552667466-07770ae110d0?w=400&h=400&fit=crop';
        const DRIVE_LINK = "https://drive.google.com/drive/folders/1-wJnHTYGLyYLRZ9diEv1yt-eX92099ct";

        const INITIAL_TRAINEES = [
            { id: '1', name: 'Arthur Pendragon', primaryPosition: 'å‰è…° (CAM)', secondaryPosition: 'ä¸­åœº (CM)', age: '17', category: 'U18', height: '182', weight: '76', attendance: 98, totalSessions: 50, attendedSessions: 49, attendanceHistory: [], nationality: 'è‹±å›½', team: 'çš‡å®¶ä¹¦é™¢', image: 'https://images.unsplash.com/photo-1506794778202-cad84cf45f1d?w=400&h=400&fit=crop', stats: { pace: 75, shooting: 82, passing: 95, dribbling: 85, defending: 60, physical: 70 } },
            { id: '2', name: 'Stella Chen', primaryPosition: 'å·¦è¾¹é”‹ (LW)', secondaryPosition: 'å‰é”‹ (FW)', age: '16', category: 'U15', height: '168', weight: '58', attendance: 92, totalSessions: 50, attendedSessions: 46, attendanceHistory: [], nationality: 'æ–°åŠ å¡', team: 'æ˜Ÿè€€ä¸­å­¦', image: 'https://images.unsplash.com/photo-1534528741775-53994a69daeb?w=400&h=400&fit=crop', stats: { pace: 92, shooting: 85, passing: 78, dribbling: 94, defending: 35, physical: 60 } },
            { id: '3', name: 'Thor Odinson', primaryPosition: 'ä¸­åå« (CB)', secondaryPosition: 'åè…° (CDM)', age: '18', category: 'U18', height: '190', weight: '88', attendance: 85, totalSessions: 50, attendedSessions: 42, attendanceHistory: [], nationality: 'ç‘å…¸', team: 'é›·éœ†ä½“æ ¡', image: 'https://images.unsplash.com/photo-1480455624313-e29b44bbfde1?w=400&h=400&fit=crop', stats: { pace: 88, shooting: 95, passing: 65, dribbling: 75, defending: 45, physical: 98 } },
        ];

        const App = () => {
            const [lang, setLang] = useState('zh');
            const t = (key, subKey) => (subKey && TRANSLATIONS[lang][key]) ? TRANSLATIONS[lang][key][subKey] : (TRANSLATIONS[lang][key] || key);

            const [teams, setTeams] = useState(INITIAL_TEAMS);
            const [trainees, setTrainees] = useState([]);
            const [leagueName, setLeagueName] = useState('CFC YOUTH ACADEMY');
            const [appLogo, setAppLogo] = useState(null);

            const [isModalOpen, setIsModalOpen] = useState(false);
            const [isSchoolManagerOpen, setIsSchoolManagerOpen] = useState(false);
            const [isDataToolsOpen, setIsDataToolsOpen] = useState(false); 
            const [isAttendanceOpen, setIsAttendanceOpen] = useState(false);
            const [isEditingReport, setIsEditingReport] = useState(false);
            const [isCropperOpen, setIsCropperOpen] = useState(false);

            const [shareTarget, setShareTarget] = useState(null);
            const [searchTerm, setSearchTerm] = useState('');
            const [selectedPosition, setSelectedPosition] = useState('å…¨éƒ¨');
            const [selectedTeam, setSelectedTeam] = useState('å…¨éƒ¨');
            const [editingTrainee, setEditingTrainee] = useState(null);
            const [isEditingTitle, setIsEditingTitle] = useState(false);
            
            const [formData, setFormData] = useState({ name:'', primaryPosition:'å‰é”‹ (FW)', secondaryPosition:'æ— ', age:'16', category: 'U18', height: '', weight: '', attendance: 100, nationality:'', team:'', image:'', stats:{pace:50,shooting:50,passing:50,dribbling:50,defending:50,physical:50} });
            
            const [renamingTeam, setRenamingTeam] = useState({ original: '', current: '' });
            const [aiResult, setAiResult] = useState(null);
            const [aiLoading, setAiLoading] = useState(false);
            
            // è€ƒå‹¤çŠ¶æ€
            const [attendanceList, setAttendanceList] = useState([]); 
            const [importText, setImportText] = useState("");
            const [attendanceDate, setAttendanceDate] = useState(""); 

            // è£å‰ªå™¨çŠ¶æ€ (è¡¥å›)
            const [tempImage, setTempImage] = useState(null);
            const [isLogoCrop, setIsLogoCrop] = useState(false);

            const fileInputRef = useRef(null);
            const logoInputRef = useRef(null);
            const backupInputRef = useRef(null);
            const cropperRef = useRef(null);
            const cropperImageRef = useRef(null);

            useEffect(() => {
                const localData = JSON.parse(localStorage.getItem('cfc_local_db') || '{}');
                if (localData.trainees) {
                    const sanitizedTrainees = localData.trainees.map(t => ({
                        ...t,
                        totalSessions: t.totalSessions || 10,
                        attendedSessions: t.attendedSessions || Math.round((t.attendance || 100) / 10),
                        attendance: t.attendance || 100,
                        attendanceHistory: t.attendanceHistory || [],
                        stats: t.stats || { pace: 50, shooting: 50, passing: 50, dribbling: 50, defending: 50, physical: 50 }
                    }));
                    setTrainees(sanitizedTrainees);
                } else {
                    setTrainees(INITIAL_TRAINEES);
                }
                if (localData.teams) setTeams(localData.teams);
                if (localData.leagueName) setLeagueName(localData.leagueName);
                if (localData.appLogo) setAppLogo(localData.appLogo);
            }, []);

            const saveToLocal = (newData) => {
                const currentData = {
                    trainees: newData.trainees !== undefined ? newData.trainees : trainees,
                    teams: newData.teams !== undefined ? newData.teams : teams,
                    leagueName: newData.leagueName !== undefined ? newData.leagueName : leagueName,
                    appLogo: newData.appLogo !== undefined ? newData.appLogo : appLogo,
                };
                if (newData.trainees !== undefined) setTrainees(newData.trainees);
                if (newData.teams !== undefined) setTeams(newData.teams);
                if (newData.leagueName !== undefined) setLeagueName(newData.leagueName);
                if (newData.appLogo !== undefined) setAppLogo(newData.appLogo);
                localStorage.setItem('cfc_local_db', JSON.stringify(currentData));
            };

            // æ™ºèƒ½åˆ—è¡¨ï¼šåªå— Team/Position å½±å“ï¼Œä¸å— Search å½±å“
            const reportFiltered = useMemo(() => trainees.filter(trainee => {
                const matchPos = selectedPosition === 'å…¨éƒ¨' || trainee.primaryPosition === selectedPosition || trainee.secondaryPosition === selectedPosition;
                const matchTeam = selectedTeam === 'å…¨éƒ¨' || trainee.team === selectedTeam;
                return matchPos && matchTeam;
            }), [trainees, selectedPosition, selectedTeam]);

            // UI åˆ—è¡¨ï¼šå— Search å½±å“
            const uiFiltered = useMemo(() => reportFiltered.filter(t => 
                t.name.toLowerCase().includes(searchTerm.toLowerCase()) || t.team.toLowerCase().includes(searchTerm.toLowerCase())
            ), [reportFiltered, searchTerm]);

            // --- è£å‰ªåŠŸèƒ½ ---
            const handleFile = (e, isLogo) => { 
                const f = e.target.files?.[0]; 
                if(!f) return; 
                const r = new FileReader(); 
                r.onloadend = () => { 
                    setTempImage(r.result); 
                    setIsLogoCrop(isLogo); 
                    setIsCropperOpen(true); 
                }; 
                r.readAsDataURL(f); 
            };
            
            useEffect(() => { 
                if (isCropperOpen && cropperImageRef.current) { 
                    if (cropperRef.current) cropperRef.current.destroy(); 
                    cropperRef.current = new Cropper(cropperImageRef.current, { aspectRatio: 1, viewMode: 1, background: false, autoCropArea: 0.8 }); 
                } 
            }, [isCropperOpen, tempImage]);

            const handleCropConfirm = () => { 
                if (cropperRef.current) { 
                    const c = cropperRef.current.getCroppedCanvas({ width: 400, height: 400 }); 
                    const u = c.toDataURL('image/jpeg', 0.8); 
                    if (isLogoCrop) { setAppLogo(u); saveToLocal({ appLogo: u }); } 
                    else { setFormData(p => ({ ...p, image: u })); } 
                    setIsCropperOpen(false); 
                    setTempImage(null); 
                    if(fileInputRef.current) fileInputRef.current.value=''; 
                    if(logoInputRef.current) logoInputRef.current.value=''; 
                } 
            };
            const handleRotate = () => { if (cropperRef.current) cropperRef.current.rotate(90); };

            // --- è€ƒå‹¤åŠŸèƒ½ (ä½¿ç”¨ reportFiltered) ---
            const openAttendanceModal = () => {
                const today = new Date().toISOString().slice(0, 10);
                setAttendanceDate(today);
                setAttendanceList(reportFiltered.map(t => t.id)); 
                setImportText("");
                setIsAttendanceOpen(true);
            };

            const toggleAttendance = (id) => {
                if (attendanceList.includes(id)) setAttendanceList(attendanceList.filter(pid => pid !== id));
                else setAttendanceList([...attendanceList, id]);
            };

            const parseImportText = () => {
                if (!importText) return;
                const text = importText.toLowerCase();
                // æœç´¢æ—¶ä»…åœ¨ reportFiltered ä¸­åŒ¹é…
                const matchedIds = reportFiltered.filter(t => text.includes(t.name.toLowerCase())).map(t => t.id);
                if (matchedIds.length > 0) {
                    setAttendanceList(matchedIds);
                    alert(`âœ… æˆåŠŸè¯†åˆ« ${matchedIds.length} åçƒå‘˜ï¼`);
                } else {
                    alert("âš ï¸ æœªè¯†åˆ«åˆ°åŒ¹é…çš„åå­—");
                }
            };

            const submitAttendance = () => {
                if (!confirm(`ç¡®è®¤æäº¤ [${attendanceDate}] è€ƒå‹¤ï¼Ÿ`)) return;
                let skippedCount = 0;
                const newTrainees = trainees.map(t => {
                    if (reportFiltered.some(r => r.id === t.id)) {
                        const history = t.attendanceHistory || [];
                        if (history.includes(attendanceDate)) { skippedCount++; return t; }
                        const isPresent = attendanceList.includes(t.id);
                        const newTotal = (t.totalSessions || 0) + 1;
                        const newAttended = (t.attendedSessions || 0) + (isPresent ? 1 : 0);
                        const newRate = Math.round((newAttended / newTotal) * 100);
                        const newHistory = [...history, attendanceDate];
                        return { ...t, totalSessions: newTotal, attendedSessions: newAttended, attendance: newRate, attendanceHistory: newHistory };
                    }
                    return t;
                });
                saveToLocal({ trainees: newTrainees });
                setIsAttendanceOpen(false);
                if (skippedCount > 0) alert(`âœ… è€ƒå‹¤æ›´æ–°ï¼(è·³è¿‡ ${skippedCount} æ¡é‡å¤è®°å½•)`);
                else alert("âœ… è€ƒå‹¤æˆåŠŸï¼");
            };

            const handleWhatsappShare = () => {
                const date = attendanceDate || new Date().toISOString().slice(0, 10);
                const presentNames = reportFiltered.filter(t => attendanceList.includes(t.id)).map(t => t.name);
                const absentNames = reportFiltered.filter(t => !attendanceList.includes(t.id)).map(t => t.name);

                let text = `ğŸ“… *CFC Attendance - ${date}*\n\n`;
                text += `âœ… *Present (${presentNames.length})*:\n${presentNames.join('\n')}\n\n`;
                text += `âŒ *Absent (${absentNames.length})*:\n${absentNames.join('\n')}`;

                const url = `https://wa.me/?text=${encodeURIComponent(text)}`;
                window.open(url, '_blank');
            };
            
            const handleExportAttendanceExcel = () => {
                const date = attendanceDate || new Date().toISOString().slice(0, 10);
                let csvContent = "\uFEFFName,Team,Category,Status,Date\n";
                reportFiltered.forEach(t => {
                    const status = attendanceList.includes(t.id) ? "Present" : "Absent";
                    csvContent += `${t.name.replace(/,/g," ")},${t.team.replace(/,/g," ")},${t.category||""},${status},${date}\n`;
                });
                const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.href = url;
                link.download = `CFC_Attendance_${date}.csv`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            // ... (Backup, Import, Save logic)
            const handleBackupToDrive = () => { const d=JSON.stringify({trainees,teams,leagueName,appLogo},null,2); const b=new Blob([d],{type:"application/json"}); const u=URL.createObjectURL(b); const l=document.createElement('a'); l.href=u; const dt=new Date().toISOString().slice(0,10); l.download=`CFC_Backup_${dt}.json`; document.body.appendChild(l); l.click(); document.body.removeChild(l); URL.revokeObjectURL(u); setTimeout(() => { if(confirm(`âœ… å¤‡ä»½å·²ç”Ÿæˆï¼å‰å¾€ Google Driveï¼Ÿ`)) window.open(DRIVE_LINK, '_blank'); }, 500); };
            const handleImportFile = (e) => { const f=e.target.files?.[0]; if(!f) return; const r=new FileReader(); r.onload=(ev) => { try { const p=JSON.parse(ev.target.result); if(!p.trainees) throw new Error(); if(confirm(`âš ï¸ è¦†ç›–å½“å‰æ•°æ®ï¼Ÿ`)) { saveToLocal(p); alert(`âœ… æˆåŠŸæ¢å¤ï¼`); setIsDataToolsOpen(false); } } catch (e) { alert("âŒ æ–‡ä»¶é”™è¯¯"); } e.target.value=null; }; r.readAsText(f); };
            const handleSave = () => { if(!formData.name) return; const data = { ...formData, image: formData.image || DEFAULT_IMAGE }; let newTrainees; if(editingTrainee) newTrainees = trainees.map(t => t.id === editingTrainee.id ? { ...data, id: t.id } : t); else newTrainees = [{ ...data, id: Date.now().toString() }, ...trainees]; saveToLocal({ trainees: newTrainees }); setIsModalOpen(false); };
            const deleteTrainee = (id) => { if(confirm("åˆ é™¤æ­¤çƒå‘˜ï¼Ÿ")) { const newT = trainees.filter(t => t.id !== id); saveToLocal({ trainees: newT }); } };
            const handleRenameTeam = (old) => { const n = renamingTeam.current.trim(); if(!n || n===old) return setRenamingTeam({original:'',current:''}); const newTeams = teams.map(t=>t===old?n:t); const newT = trainees.map(t=>t.team===old?{...t,team:n}:t); saveToLocal({teams:newTeams, trainees:newT}); setRenamingTeam({original:'',current:''}); };
            const handleAddTeam = () => { const n=`New School ${teams.length+1}`; saveToLocal({teams:[...teams,n]}); };
            const handleDeleteTeam = (n) => { if(!confirm(`Delete ${n}?`)) return; const newTeams=teams.filter(t=>t!==n); const newT=trainees.map(t=>t.team===n?{...t,team:'Free Agent'}:t); saveToLocal({teams:newTeams,trainees:newT}); };
            const handleRandomPhoto = () => { const arr=['https://images.unsplash.com/photo-1511886929837-354d827aae26?w=400&h=400&fit=crop','https://images.unsplash.com/photo-1519389950473-47ba0277781c?w=400&h=400&fit=crop','https://images.unsplash.com/photo-1504257365157-1496a50d48f2?w=400&h=400&fit=crop']; setFormData(p=>({...p, image:arr[Math.floor(Math.random()*arr.length)]})); };
            const mockAI = (type, trainee) => { setAiLoading(true); setAiResult({ name: trainee.name, content: TRANSLATIONS[lang].ai.analyzing }); setIsEditingReport(false); setTimeout(() => { const stats=trainee.stats||{pace:50}; const sorted=Object.entries(stats).sort((a,b)=>b[1]-a[1]); const best=sorted[0]; const weak=sorted[sorted.length-1]; const d=TRANSLATIONS[lang].ai; const sd=TRANSLATIONS[lang].stats; let rep=`ã€${d.reportTitle}ã€‘\n\nğŸ”¥ ${d.strength}ï¼š${sd[best[0]]} (${best[1]})\nğŸ“ ${d.suggestion}ï¼š${d.advice}\n\nğŸ’¬ ${d.comment}ï¼š\n"${trainee.name} - ${d.commentText}"`; setAiResult({name:trainee.name, content:rep}); setAiLoading(false); }, 1000); };
            const getPositionCode = (s) => (s && s !== 'æ— ') ? s.match(/\((.*?)\)/)?.[1] || s.substring(0,2) : '';
            const getAttendanceColor = (v) => v >= 90 ? 'bg-emerald-500' : (v >= 70 ? 'bg-yellow-500' : 'bg-red-500');
            const generateShareText = (t) => { const L = TRANSLATIONS[lang]; const c = t.category ? `[${t.category}] ` : ''; return `ã€${L.appTitle}ã€‘\n\n${L.name}ï¼š${t.name}\n${L.school}ï¼š${c}${t.team}\n${L.mainPos}ï¼š${t.primaryPosition}\n${L.age}ï¼š${t.age} | ${L.height}ï¼š${t.height||'-'}cm | ${L.weight}ï¼š${t.weight||'-'}kg\n${L.attendance}ï¼š${t.attendance||0}%\n\nğŸ“Š ${L.stats.pace}: ${t.stats.pace} | ${L.stats.shooting}: ${t.stats.shooting}\n${L.stats.passing}: ${t.stats.passing} | ${L.stats.dribbling}: ${t.stats.dribbling}\n${L.stats.defending}: ${t.stats.defending} | ${L.stats.physical}: ${t.stats.physical}`; };
            const handleReportShare = async () => { if(!aiResult) return; const txt = aiResult.content; try { if(navigator.share) await navigator.share({text:txt}); else { const ta=document.createElement("textarea"); ta.value=txt; document.body.appendChild(ta); ta.select(); document.execCommand("copy"); document.body.removeChild(ta); alert("Copied!"); } } catch(e){} };
            const handleSystemShare = async (t) => { try{await navigator.share({title:t.name, text:generateShareText(t)})}catch(e){alert("Use WhatsApp Button");} };

            return (
                <div className="max-w-7xl mx-auto p-4 md:p-8 pb-20 fade-in">
                    <div className="h-1 bg-gradient-to-r from-blue-600 via-indigo-500 to-yellow-500 mb-6"></div>
                    
                    <header className="flex flex-col md:flex-row justify-between items-center gap-6 mb-8">
                        <div className="flex items-center gap-4 w-full md:w-auto">
                            <div className="relative group w-16 h-16 bg-zinc-800 rounded-xl flex items-center justify-center cursor-pointer border border-zinc-700 overflow-hidden shrink-0" onClick={() => logoInputRef.current.click()}>
                                {appLogo ? <img src={appLogo} className="w-full h-full object-cover"/> : <i className="fa-solid fa-shield-halved text-yellow-500 text-3xl"></i>}
                                <input type="file" ref={logoInputRef} className="hidden" accept="image/*" onChange={(e) => handleFile(e, true)} />
                            </div>
                            <div className="flex-1">
                                {isEditingTitle ? (
                                    <input autoFocus className="bg-zinc-800 text-white text-2xl font-black px-2 py-1 rounded w-full border border-zinc-600" 
                                        value={leagueName} onChange={e => setLeagueName(e.target.value)} 
                                        onBlur={() => {setIsEditingTitle(false); saveToLocal({leagueName});}} />
                                ) : (
                                    <h1 className="text-2xl font-black cursor-pointer flex items-center gap-2" onClick={() => setIsEditingTitle(true)}>{leagueName} <i className="fa-solid fa-pen text-xs text-zinc-600"></i></h1>
                                )}
                                <div className="text-xs text-zinc-500 mt-1 flex items-center gap-2">
                                    <span className="bg-zinc-900 text-yellow-500 border border-yellow-500/20 px-2 py-0.5 rounded font-bold">{t('systemName')}</span>
                                    <span className="text-zinc-400 bg-zinc-800 px-2 rounded"><i className="fa-solid fa-hard-drive"></i> {t('localMode')}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div className="flex flex-col md:flex-row gap-2 w-full md:w-auto items-end">
                            <div className="flex bg-zinc-800 rounded-lg p-1 border border-zinc-700">
                                <button onClick={() => setLang('zh')} className={`px-2 py-1 rounded text-lg ${lang==='zh'?'bg-zinc-600':'hover:bg-zinc-700'}`}>ğŸ‡¨ğŸ‡³</button>
                                <button onClick={() => setLang('en')} className={`px-2 py-1 rounded text-lg ${lang==='en'?'bg-zinc-600':'hover:bg-zinc-700'}`}>ğŸ‡¬ğŸ‡§</button>
                                <button onClick={() => setLang('ms')} className={`px-2 py-1 rounded text-lg ${lang==='ms'?'bg-zinc-600':'hover:bg-zinc-700'}`}>ğŸ‡²ğŸ‡¾</button>
                            </div>
                            <div className="flex gap-2 w-full">
                                <button onClick={openAttendanceModal} className="bg-emerald-900 text-emerald-100 px-4 py-3 rounded-xl font-bold border border-emerald-700 whitespace-nowrap"><i className="fa-solid fa-calendar-check mr-2"></i>{t('attendanceTool')}</button>
                                <button onClick={() => setIsDataToolsOpen(true)} className="bg-indigo-900 text-indigo-100 px-4 py-3 rounded-xl font-bold border border-indigo-700 whitespace-nowrap"><i className="fa-solid fa-cloud-arrow-up"></i></button>
                                <button onClick={() => setIsSchoolManagerOpen(true)} className="flex-1 bg-zinc-800 hover:bg-zinc-700 text-zinc-300 px-4 py-3 rounded-xl font-bold border border-zinc-700 whitespace-nowrap"><i className="fa-solid fa-gear"></i>{t('manageSchools')}</button>
                                <button onClick={() => { setEditingTrainee(null); setIsModalOpen(true); }} className="flex-[2] bg-zinc-100 hover:bg-white text-zinc-900 px-6 py-3 rounded-xl font-bold whitespace-nowrap shadow-lg"><i className="fa-solid fa-plus mr-2"></i>{t('register')}</button>
                            </div>
                        </div>
                    </header>

                    {/* AI Result Area */}
                    {aiResult && (
                        <div className="mb-8 bg-zinc-900 border border-zinc-700 rounded-xl p-4 relative fade-in">
                            <div className="flex justify-between items-center mb-3">
                                <h3 className="font-bold text-white flex items-center gap-2"><span className="bg-indigo-600 text-white w-6 h-6 rounded flex items-center justify-center text-xs"><i className="fa-solid fa-clipboard-user"></i></span>{t('coachReport')}: <span className="text-indigo-400">{aiResult.name}</span></h3>
                                <div className="flex gap-2">
                                    <button onClick={handleReportShare} className="text-zinc-400 hover:text-white transition-colors"><i className="fa-solid fa-share-nodes"></i></button>
                                    <button onClick={() => setIsEditingReport(!isEditingReport)} className="text-zinc-400 hover:text-white transition-colors"><i className={`fa-solid ${isEditingReport ? 'fa-floppy-disk text-emerald-500' : 'fa-pen-to-square'}`}></i></button>
                                    <button onClick={() => setAiResult(null)}><i className="fa-solid fa-xmark text-zinc-500 hover:text-white"></i></button>
                                </div>
                            </div>
                            {isEditingReport ? <textarea className="w-full bg-black/40 text-zinc-300 text-sm p-4 rounded-lg border border-zinc-700 outline-none resize-y min-h-[150px]" value={aiResult.content} onChange={(e) => setAiResult({...aiResult, content: e.target.value})}></textarea> : <div className="text-zinc-300 text-sm whitespace-pre-wrap leading-relaxed bg-black/20 p-4 rounded-lg">{aiResult.content}</div>}
                            {aiLoading && <div className="text-xs text-zinc-500 mt-2 flex items-center gap-2"><i className="fa-solid fa-spinner fa-spin"></i> {t('ai', 'analyzing')}</div>}
                        </div>
                    )}

                    <div className="mb-8 space-y-3">
                        <input className="w-full pl-4 pr-4 py-3 bg-zinc-900 border border-zinc-800 rounded-xl text-white focus:border-indigo-500 outline-none placeholder-zinc-600" placeholder={t('searchPlaceholder')} value={searchTerm} onChange={e => setSearchTerm(e.target.value)} />
                        <div className="flex gap-2 overflow-x-auto no-scrollbar pb-1">{['å…¨éƒ¨', ...teams].map(t => <button key={t} onClick={() => setSelectedTeam(t)} className={`px-3 py-1.5 rounded-lg text-xs font-bold whitespace-nowrap border transition-colors ${selectedTeam === t ? 'bg-yellow-500 text-black border-yellow-500' : 'bg-zinc-900 text-zinc-400 border-zinc-800 hover:bg-zinc-800'}`}>{t.split(' (')[0]}</button>)}</div>
                        <div className="flex gap-2 overflow-x-auto no-scrollbar">{['å…¨éƒ¨', ...POSITIONS].map(p => <button key={p} onClick={() => setSelectedPosition(p)} className={`px-3 py-1.5 rounded-lg text-xs font-bold whitespace-nowrap border transition-colors ${selectedPosition === p ? 'bg-zinc-100 text-black' : 'bg-zinc-900 text-zinc-400 border-zinc-800 hover:bg-zinc-800'}`}>{p.replace(/\s*\(.*?\)\s*/g, '')}</button>)}</div>
                    </div>

                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                        {uiFiltered.length === 0 && <div className="col-span-full py-20 text-center text-zinc-600 border-2 border-dashed border-zinc-800 rounded-3xl">{t('noData')}</div>}
                        {uiFiltered.map(trainee => (
                            <div key={trainee.id} className="bg-zinc-900 rounded-2xl border border-zinc-800 flex flex-col hover:border-zinc-600 transition-colors relative group overflow-hidden">
                                <div className="w-full h-48 relative shrink-0">
                                    <img src={trainee.image} className="w-full h-full object-cover bg-zinc-800" onError={e => e.target.src = DEFAULT_IMAGE} />
                                    <div className="absolute inset-0 bg-gradient-to-t from-zinc-900 via-transparent to-transparent opacity-80"></div>
                                    <span className="absolute top-2 left-2 bg-yellow-500 text-black text-[10px] font-black px-2 py-0.5 rounded shadow z-10">{getPositionCode(trainee.primaryPosition)}</span>
                                    {trainee.category && <span className="absolute top-2 right-2 bg-indigo-600 text-white text-[10px] font-bold px-2 py-0.5 rounded shadow z-10">{trainee.category}</span>}
                                    <button onClick={(e) => { e.stopPropagation(); setShareTarget(trainee); }} className="absolute bottom-2 right-2 w-8 h-8 flex items-center justify-center bg-white/20 backdrop-blur rounded-full text-white hover:bg-emerald-600 transition-all z-20 shadow-lg border border-white/20" title={t('shareProfile')}><i className="fa-solid fa-share-nodes text-xs"></i></button>
                                    <div className="absolute bottom-2 left-3 right-12"><h3 className="text-lg font-bold text-white truncate shadow-black drop-shadow-md leading-tight">{trainee.name}</h3><p className="text-[10px] text-zinc-300 flex items-center gap-1 truncate shadow-black drop-shadow-md"><i className="fa-solid fa-school text-yellow-500"></i> {trainee.team.split(' (')[0]}</p></div>
                                </div>
                                <div className="p-4 flex-1 flex flex-col">
                                    <div className="flex justify-between items-center bg-zinc-950 p-2 rounded-lg mb-3 border border-zinc-800">
                                        <div className="text-center flex-1 border-r border-zinc-800"><div className="text-[10px] text-zinc-500 uppercase">{t('age')}</div><div className="text-xs font-bold text-white">{trainee.age}</div></div>
                                        <div className="text-center flex-1 border-r border-zinc-800"><div className="text-[10px] text-zinc-500 uppercase">{t('height')}</div><div className="text-xs font-bold text-white">{trainee.height || '-'} <span className="text-[8px] font-normal">cm</span></div></div>
                                        <div className="text-center flex-1"><div className="text-[10px] text-zinc-500 uppercase">{t('weight')}</div><div className="text-xs font-bold text-white">{trainee.weight || '-'} <span className="text-[8px] font-normal">kg</span></div></div>
                                    </div>
                                    <div className="mb-3 px-1"><div className="flex justify-between text-[10px] text-zinc-500 mb-1 font-bold"><span>{t('attendance')}</span><span className={trainee.attendance >= 90 ? 'text-emerald-500' : 'text-zinc-300'}>{trainee.attendance || 0}%</span></div><div className="h-1.5 w-full bg-zinc-800 rounded-full overflow-hidden"><div className={`h-full ${getAttendanceColor(trainee.attendance || 0)}`} style={{width: `${trainee.attendance || 0}%`}}></div></div></div>
                                    <div className="space-y-1.5 mb-4">{['pace', 'shooting', 'passing'].map(s => { const val = (trainee.stats && trainee.stats[s]) || 0; return (<div key={s} className="flex items-center gap-2"><span className="text-[9px] text-zinc-500 uppercase w-10">{t('stats', s)}</span><div className="flex-1 h-1 bg-zinc-800 rounded-full overflow-hidden"><div className="h-full bg-indigo-500" style={{width: `${val}%`}}></div></div><span className="text-[9px] font-bold text-zinc-400 w-4 text-right">{val}</span></div>); })}</div>
                                    <div className="flex gap-2 mt-auto pt-3 border-t border-zinc-800/50"><button onClick={() => { setEditingTrainee(trainee); setFormData(trainee); setIsModalOpen(true); }} className="p-1.5 text-zinc-500 hover:text-white transition-colors"><i className="fa-solid fa-pen-to-square"></i></button><button onClick={() => deleteTrainee(trainee.id)} className="p-1.5 text-zinc-500 hover:text-red-500 transition-colors"><i className="fa-solid fa-trash"></i></button><div className="flex-1"></div><button onClick={() => mockAI('çƒæ¢', trainee)} className="px-3 py-1 bg-zinc-800 hover:bg-zinc-700 text-zinc-400 text-xs rounded border border-zinc-700 transition-colors flex items-center gap-1"><i className="fa-solid fa-magnifying-glass-chart"></i> {t('aiAnalyze')}</button></div>
                                </div>
                            </div>
                        ))}
                    </div>

                    {isAttendanceOpen && (
                        <div className="fixed inset-0 z-[80] flex items-center justify-center p-4 bg-black/90 backdrop-blur-sm fade-in">
                            <div className="bg-zinc-900 w-full max-w-lg rounded-2xl border border-zinc-800 shadow-2xl p-6 max-h-[90vh] overflow-y-auto flex flex-col">
                                <div className="flex justify-between items-center mb-4">
                                    <h2 className="text-xl font-bold text-white flex items-center gap-2"><i className="fa-solid fa-calendar-check text-emerald-500"></i> {t('attTitle')}</h2>
                                    <div className="flex items-center gap-2">
                                        <input type="date" className="bg-zinc-800 text-white text-xs px-2 py-1 rounded border border-zinc-600 focus:border-emerald-500 outline-none" value={attendanceDate} onChange={(e) => setAttendanceDate(e.target.value)} />
                                        <button onClick={() => setIsAttendanceOpen(false)}><i className="fa-solid fa-xmark text-xl text-zinc-500 hover:text-white"></i></button>
                                    </div>
                                </div>
                                <div className="bg-zinc-950 p-4 rounded-xl border border-zinc-800 mb-4"><label className="text-zinc-400 text-xs font-bold block mb-2">{t('attPaste')}</label><textarea className="w-full bg-black border border-zinc-700 rounded-lg p-3 text-xs text-white h-20 mb-2 focus:border-emerald-500 outline-none" placeholder={t('attPlaceholder')} value={importText} onChange={e => setImportText(e.target.value)}></textarea><button onClick={parseImportText} className="w-full py-2 bg-zinc-800 hover:bg-zinc-700 text-emerald-400 border border-emerald-900/30 rounded-lg text-xs font-bold">{t('attPasteDesc')}</button></div>
                                
                                {/* ä¿®å¤ç‚¹ï¼šæ˜¾ç¤ºå®Œæ•´çš„ reportFilteredï¼Œä½†æ”¯æŒæœç´¢é«˜äº® */}
                                <div className="flex justify-between items-center mb-2 px-1"><span className="text-xs text-zinc-500">Selected {attendanceList.length} / {reportFiltered.length}</span><button onClick={() => setAttendanceList(attendanceList.length === reportFiltered.length ? [] : reportFiltered.map(t => t.id))} className="text-xs text-indigo-400 hover:text-indigo-300">Select All</button></div>
                                
                                <div className="flex-1 overflow-y-auto space-y-2 mb-4 pr-1">
                                    {reportFiltered.map(t => (
                                        <div key={t.id} onClick={() => toggleAttendance(t.id)} className={`flex items-center justify-between p-3 rounded-xl border cursor-pointer transition-all ${attendanceList.includes(t.id) ? 'bg-emerald-900/20 border-emerald-500/50' : 'bg-zinc-800/50 border-zinc-700'}`}>
                                            <div className="flex items-center gap-3">
                                                <div className={`w-5 h-5 rounded-full flex items-center justify-center border ${attendanceList.includes(t.id) ? 'bg-emerald-500 border-emerald-500' : 'border-zinc-500'}`}>{attendanceList.includes(t.id) && <i className="fa-solid fa-check text-black text-xs"></i>}</div>
                                                <div><p className="text-sm font-bold text-white">{t.name}</p><p className="text-[10px] text-zinc-500">{t.team}</p></div>
                                            </div>
                                            <div className="text-xs text-zinc-400">{t.attendance}%</div>
                                        </div>
                                    ))}
                                </div>
                                <div className="flex gap-2">
                                    <button onClick={submitAttendance} className="flex-1 py-3 bg-emerald-600 hover:bg-emerald-500 text-white font-bold rounded-xl shadow-lg shadow-emerald-900/20">{t('attConfirm')}</button>
                                    <button onClick={handleExportAttendanceExcel} className="px-4 py-3 bg-green-700 hover:bg-green-600 text-white font-bold rounded-xl shadow-lg flex items-center gap-2" title={t('attExcel')}><i className="fa-solid fa-file-csv"></i></button>
                                    <button onClick={handleWhatsappShare} className="px-4 py-3 bg-[#25D366] hover:bg-[#1da851] text-white font-bold rounded-xl shadow-lg" title={t('attWhatsapp')}><i className="fa-brands fa-whatsapp text-xl"></i></button>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {/* (å…¶ä»–æ¨¡æ€æ¡†ä»£ç ä¿æŒä¸å˜ï¼Œå·²åŒ…å«åœ¨ä¸Šé¢é€»è¾‘ä¸­) */}
                    {isModalOpen && (<div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm fade-in"><div className="bg-zinc-900 w-full max-w-lg rounded-2xl border border-zinc-800 shadow-2xl max-h-[90vh] overflow-y-auto p-6"><div className="flex justify-between items-center mb-6"><h2 className="text-xl font-bold text-white">{editingTrainee ? t('updateProfile') : t('newPlayer')}</h2><button onClick={() => setIsModalOpen(false)}><i className="fa-solid fa-xmark text-xl text-zinc-500 hover:text-white"></i></button></div><div className="space-y-4 mb-6"><div className="flex items-center gap-4"><div className="w-20 h-20 bg-zinc-800 rounded-xl flex items-center justify-center overflow-hidden border border-zinc-700 shrink-0 cursor-pointer relative" onClick={() => fileInputRef.current.click()}>{formData.image ? <img src={formData.image} className="w-full h-full object-cover"/> : <i className="fa-solid fa-camera text-zinc-600"></i>}<input type="file" ref={fileInputRef} className="hidden" accept="image/*" onChange={handleFile} /></div><div className="flex-1 space-y-2"><input className="w-full bg-zinc-950 border border-zinc-800 rounded px-3 py-2 text-white" placeholder={t('name')} value={formData.name} onChange={e => setFormData({...formData, name: e.target.value})} /><div className="flex gap-2"><input type="number" className="w-1/2 bg-zinc-950 border border-zinc-800 rounded px-3 py-2 text-white" placeholder={t('age')} value={formData.age} onChange={e => setFormData({...formData, age: e.target.value})} /><input className="w-1/2 bg-zinc-950 border border-zinc-800 rounded px-3 py-2 text-white" placeholder={t('nationality')} value={formData.nationality} onChange={e => setFormData({...formData, nationality: e.target.value})} /></div><div className="flex gap-2"><div className="relative w-1/3"><input type="number" className="w-full bg-zinc-950 border border-zinc-800 rounded px-3 py-2 text-white pr-8" placeholder={t('height')} value={formData.height} onChange={e => setFormData({...formData, height: e.target.value})} /><span className="absolute right-3 top-1/2 -translate-y-1/2 text-zinc-500 text-xs">cm</span></div><div className="relative w-1/3"><input type="number" className="w-full bg-zinc-950 border border-zinc-800 rounded px-3 py-2 text-white pr-8" placeholder={t('weight')} value={formData.weight} onChange={e => setFormData({...formData, weight: e.target.value})} /><span className="absolute right-3 top-1/2 -translate-y-1/2 text-zinc-500 text-xs">kg</span></div><div className="w-1/3"><select className="w-full bg-zinc-950 border border-zinc-800 rounded px-3 py-2 text-white text-xs" value={formData.category || 'U18'} onChange={e => setFormData({...formData, category: e.target.value})}>{CATEGORIES.map(c => <option key={c} value={c}>{c}</option>)}</select></div></div></div></div><div className="bg-zinc-950 p-3 rounded-xl border border-zinc-800"><div className="flex justify-between text-xs font-bold text-zinc-400 mb-2"><span>{t('attendance')}</span><span className={formData.attendance >= 90 ? 'text-emerald-500' : 'text-white'}>{formData.attendance || 0}%</span></div><input type="range" min="0" max="100" className="w-full accent-emerald-500 h-1.5 bg-zinc-800 rounded-lg appearance-none cursor-pointer" value={formData.attendance || 0} onChange={e => setFormData({...formData, attendance: parseInt(e.target.value)})} /></div><select className="w-full bg-zinc-950 border border-zinc-800 rounded px-3 py-2 text-white" value={formData.team} onChange={e => setFormData({...formData, team: e.target.value})}>{teams.map(t => <option key={t} value={t}>{t}</option>)}</select><div className="grid grid-cols-2 gap-2"><select className="bg-zinc-950 border border-zinc-800 rounded px-3 py-2 text-white text-xs" value={formData.primaryPosition} onChange={e => setFormData({...formData, primaryPosition: e.target.value})}>{POSITIONS.map(p => <option key={p} value={p}>{p}</option>)}</select><select className="bg-zinc-950 border border-zinc-800 rounded px-3 py-2 text-white text-xs" value={formData.secondaryPosition} onChange={e => setFormData({...formData, secondaryPosition: e.target.value})}><option value="æ— ">æ— </option>{POSITIONS.map(p => <option key={p} value={p}>{p}</option>)}</select></div><div className="grid grid-cols-2 gap-x-4 gap-y-2 bg-zinc-800 p-4 rounded-xl mb-4">{Object.keys(formData.stats).map(s => (<div key={s}><div className="flex justify-between text-[10px] text-zinc-400 uppercase mb-1"><span>{t('stats', s)}</span> <span>{formData.stats[s]}</span></div><input type="range" min="0" max="99" className="w-full accent-white h-1 bg-zinc-600 rounded-lg appearance-none" value={formData.stats[s]} onChange={e => setFormData({...formData, stats: {...formData.stats, [s]: parseInt(e.target.value)}})} /></div>))}</div></div><div className="flex gap-2"><button onClick={handleSave} className="flex-1 py-3 bg-zinc-100 hover:bg-white text-zinc-900 font-bold rounded-xl transition-colors">{t('save')}</button><button onClick={() => setIsModalOpen(false)} className="px-6 py-3 bg-zinc-800 hover:bg-zinc-700 text-zinc-300 font-bold rounded-xl transition-colors">{t('cancel')}</button></div></div></div>)}
                    {isSchoolManagerOpen && (<div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/90 backdrop-blur-sm fade-in"><div className="bg-zinc-900 w-full max-w-md rounded-2xl border border-zinc-800 shadow-2xl p-6"><div className="flex justify-between items-center mb-4"><h2 className="text-lg font-bold text-white">{t('manageSchools')}</h2><button onClick={() => setIsSchoolManagerOpen(false)}><i className="fa-solid fa-xmark text-zinc-500 hover:text-white"></i></button></div><div className="max-h-[50vh] overflow-y-auto space-y-2 mb-4">{teams.map(team => (<div key={team} className="flex items-center justify-between bg-zinc-800 p-3 rounded-lg border border-zinc-700">{renamingTeam.original === team ? (<div className="flex gap-2 flex-1"><input autoFocus className="flex-1 bg-zinc-950 px-2 py-1 text-sm text-white rounded outline-none border border-emerald-500" value={renamingTeam.current} onChange={e => setRenamingTeam({...renamingTeam, current: e.target.value})} /><button onClick={() => handleRenameTeam(team)} className="text-emerald-500"><i className="fa-solid fa-check"></i></button></div>) : (<><span className="text-sm text-zinc-300">{team}</span><div className="flex gap-2"><button onClick={() => setRenamingTeam({original: team, current: team})} className="text-zinc-500 hover:text-white"><i className="fa-solid fa-pen"></i></button><button onClick={() => handleDeleteTeam(team)} className="text-zinc-500 hover:text-red-500"><i className="fa-solid fa-trash"></i></button></div></>)}</div>))}</div><button onClick={handleAddTeam} className="w-full py-2 bg-zinc-800 text-zinc-300 text-sm font-bold rounded border border-zinc-700 hover:bg-zinc-700 transition-colors">{t('addSchool')}</button></div></div>)}
                    {isDataToolsOpen && (<div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/90 backdrop-blur-sm fade-in"><div className="bg-zinc-900 w-full max-w-md rounded-2xl border border-zinc-800 shadow-2xl p-6"><div className="flex justify-between items-center mb-4"><h2 className="text-lg font-bold text-white flex items-center gap-2"><i className="fa-solid fa-cloud-arrow-up text-indigo-500"></i> {t('backupTools')}</h2><button onClick={() => setIsDataToolsOpen(false)}><i className="fa-solid fa-xmark text-zinc-500 hover:text-white"></i></button></div><div className="space-y-4"><div className="bg-zinc-950 p-4 rounded-xl border border-zinc-800 relative group overflow-hidden"><div className="absolute top-0 right-0 p-2 opacity-20"><i className="fab fa-google-drive text-6xl text-white"></i></div><h3 className="text-white font-bold mb-2 flex items-center gap-2 z-10 relative"><i className="fa-solid fa-cloud-upload-alt text-emerald-500"></i> {t('backupToDrive')}</h3><p className="text-zinc-500 text-xs mb-3 relative z-10">{t('exportDesc')}</p><button onClick={handleBackupToDrive} className="w-full py-3 bg-emerald-700 hover:bg-emerald-600 text-white rounded-xl font-bold text-sm shadow-lg transition flex items-center justify-center gap-2 relative z-10 border border-emerald-500"><i className="fab fa-google-drive"></i> {t('save')}</button></div><div className="bg-zinc-950 p-4 rounded-xl border border-zinc-800"><h3 className="text-zinc-300 font-bold mb-2 flex items-center gap-2"><i className="fa-solid fa-file-import text-indigo-500"></i> {t('restoreData')}</h3><p className="text-zinc-500 text-xs mb-3">{t('restoreDesc')}</p><div className="relative group"><button className="w-full py-3 bg-zinc-800 hover:bg-zinc-700 text-indigo-400 border border-indigo-900/50 rounded-xl font-bold text-sm shadow-lg transition flex items-center justify-center gap-2 cursor-pointer" onClick={() => backupInputRef.current.click()}><i className="fa-solid fa-folder-open"></i> {t('selectFile')}</button><input type="file" ref={backupInputRef} className="hidden" accept=".json" onChange={handleImportFile} /></div></div></div><p className="text-center text-zinc-600 text-xs mt-6">{t('dataSafe')}</p></div></div>)}
                    {isCropperOpen && (<div className="fixed inset-0 z-[70] flex items-center justify-center p-4 bg-black/90 backdrop-blur-sm fade-in"><div className="bg-zinc-900 w-full max-w-lg rounded-2xl border border-zinc-800 shadow-2xl p-4"><h3 className="text-white font-bold text-lg mb-4 text-center">{t('cropTitle')}</h3><div className="cropper-container rounded-lg overflow-hidden mb-4 border border-zinc-700"><img ref={cropperImageRef} src={tempImage} alt="Crop" style={{maxWidth: '100%'}} /></div><div className="flex gap-2"><button onClick={handleRotate} className="px-4 py-3 bg-zinc-800 hover:bg-zinc-700 text-white rounded-xl transition-colors"><i className="fa-solid fa-rotate-right"></i></button><button onClick={handleCropConfirm} className="flex-1 py-3 bg-emerald-600 hover:bg-emerald-500 text-white font-bold rounded-xl transition-colors">{t('confirmCrop')}</button><button onClick={() => setIsCropperOpen(false)} className="px-4 py-3 bg-red-600 hover:bg-red-500 text-white rounded-xl transition-colors"><i className="fa-solid fa-xmark"></i></button></div></div></div>)}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
