<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>CFC YOUTH ACADEMY</title>
    
    <!-- PWA Core -->
    <meta name="theme-color" content="#09090b">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="CFCYA">
    
    <!-- Dynamic Icons -->
    <link id="dynamic-favicon" rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/3309/3309991.png">
    <link id="dynamic-apple-icon" rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3309/3309991.png">
    
    <!-- Dynamic Manifest -->
    <link id="dynamic-manifest" rel="manifest" href="data:application/manifest+json;base64,eyJuYW1lIjoiQ0ZDWUEiLCJzaG9ydF9uYW1lIjoiQ0ZDWUEiLCJzdGFydF91cmwiOiIuIiwiZGlzcGxheSI6InN0YW5kYWxvbmUiLCJiYWNrZ3JvdW5kX2NvbG9yIjoiIzA5MDkwYiIsInRoZW1lX2NvbG9yIjoiIzA5MDkwYiIsImljb25zIjpbeyJzcmMiOiJodHRwczovL2N0bi1pY29ucy1wbmcuZmxhdGljb24uY29tLzUxMi8zMzA5LzMzMDk5OTEucG5nIiwic2l6ZXMiOiIxOTJ4MTkyIiwidHlwZSI6ImltYWdlL3BuZyJ9LHsic3JjIjoiaHR0cHM6Ly9jZG4taWNvbnYtcG5nLmZsYXRpY29uLmNvbS81MTIvMzMwOS8zMzA5OTkxLnBuZyIsInNpemVzIjoiNTEyeDUxMiIsInR5cGUiOiJpbWFnZS9wbmcifV19">

    <!-- Libs -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">

    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

    <style>
        body { background-color: #09090b; color: #fff; font-family: sans-serif; -webkit-tap-highlight-color: transparent; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .cropper-container { max-height: 60vh; background-color: #000; }
        #static-loading { position: fixed; inset: 0; display: flex; flex-direction: column; justify-content: center; align-items: center; background: #09090b; z-index: 50; transition: opacity 0.5s; }
        .hidden { opacity: 0; pointer-events: none; }
        input[type="date"], input[type="month"] { color-scheme: dark; }
        #error-box { display: none; position: fixed; top: 0; left: 0; width: 100%; background: #ef4444; color: white; padding: 10px; z-index: 200; text-align: center; font-size: 12px; }
        header { padding-top: env(safe-area-inset-top); }
        .modal-overlay { z-index: 100; }
    </style>
</head>
<body>
    <div id="static-loading">
        <i class="fa-solid fa-shield-halved text-yellow-500 text-5xl fa-beat mb-4"></i>
        <h2 class="text-xl font-bold mt-4 tracking-wider">CFCYA</h2>
        <p id="loading-text" class="text-zinc-500 text-xs mt-2">Checking Buttons...</p>
    </div>
    <div id="error-box"></div>

    <div id="root"></div>

    <script>
        setTimeout(() => {
            const loader = document.getElementById('static-loading');
            const root = document.getElementById('root');
            if (loader && !loader.classList.contains('hidden') && (!root || root.innerHTML.trim() === "")) {
                document.getElementById('loading-text').innerHTML = 
                    `<span style="color:#ef4444">‚ö†Ô∏è Timeout. Please refresh page.</span>`;
            }
        }, 5000);
        window.onerror = function(msg, url, line) {
            const errBox = document.getElementById('error-box');
            errBox.style.display = 'block';
            errBox.innerText = `Error: ${msg} (Line: ${line})`;
            return false; 
        };
    </script>

    <script type="text/babel">
        // =================================================================
        // üîë CONFIG & INITIAL DATA
        // =================================================================
        const MY_MASTER_KEY = "$2a$10$JuGSKsBRirNG95vYP0fbSuotikgzUSy8nphUaCtjGq0qsdCalvBo2"; 
        const JSONBIN_URL = "https://api.jsonbin.io/v3/b";
        const MY_CLOUD_NAME = "dtlsbbj1v"; 
        const PRESET_YEARLY_TOTAL = 52;
        const DEFAULT_MONTHLY_FEE = 150;
        const ADMIN_PIN = "8888"; 

        const BANK_INFO = { bankName: "OCBC BANK", accNum: "7091258844", holder: "CFC YOUTH ACADEMY SB" };
        
        const DEFAULT_FORM_DATA = { 
            name:'', primaryPosition:'ÂâçÈîã (FW)', secondaryPosition:'Êó†', age:'16', category: 'U18', height: '', weight: '', 
            attendance: 0, nationality:'', team:'', image:'', 
            totalSessions: PRESET_YEARLY_TOTAL, attendedSessions: 0, 
            stats:{pace:50,shooting:50,passing:50,dribbling:50,defending:50,physical:50},
            parentName: '', phone: '', email: '', tin: ''
        };

        const INITIAL_COACHES = [
            { id: 'c1', name: 'Coach Mourinho', role: 'Head Coach', rate: 200, phone: '60123456789', attendanceHistory: [], paymentHistory: {} },
            { id: 'c2', name: 'Coach Pep', role: 'Assistant', rate: 100, phone: '60198765432', attendanceHistory: [], paymentHistory: {} }
        ];

        const INITIAL_TRAINEES = [
            { id: '1', name: 'Arthur', primaryPosition: 'ÂâçËÖ∞ (CAM)', secondaryPosition: '‰∏≠Âú∫ (CM)', age: '17', category: 'U18', height: '182', weight: '76', attendance: 0, totalSessions: 52, attendedSessions: 0, attendanceHistory: [], feeHistory: {}, nationality: 'Ëã±ÂõΩ', team: 'ÁöáÂÆ∂‰π¶Èô¢', image: 'https://images.unsplash.com/photo-1506794778202-cad84cf45f1d?w=400&h=400&fit=crop', stats: { pace: 75, shooting: 82, passing: 95, dribbling: 85, defending: 60, physical: 70 }, parentName: 'Uther', phone: '012-3456789', email: 'uther@camelot.com', tin: 'TIN-001' }
        ];

        const INITIAL_TEAMS = ['ÁöáÂÆ∂‰π¶Èô¢', 'ÊòüËÄÄ‰∏≠Â≠¶', 'Èõ∑ÈúÜ‰ΩìÊ†°', 'ËìùÈπ∞ÂõΩÈôÖ', 'ÂåóÂ¢É‰∏Ä‰∏≠', 'ÂçóÊ¥ãÂÖ¨Â≠¶', 'ÂÖâËæâ‰∏≠Â≠¶', 'È£éÊö¥Á´ûÊäÄ', 'Èì∂Ê≤≥ÂÆûÈ™å', 'Ê≥∞Âù¶‰∏≠Â≠¶'];
        const CATEGORIES = ['U8', 'U10', 'U12', 'U15', 'U18'];
        const POSITIONS = ['ÂâçÈîã (FW)', 'Â∑¶ËæπÈîã (LW)', 'Âè≥ËæπÈîã (RW)', 'ÂâçËÖ∞ (CAM)', '‰∏≠Âú∫ (CM)', 'ÂêéËÖ∞ (CDM)', 'ÂêéÂç´ (DF)', '‰∏≠ÂêéÂç´ (CB)', 'Â∑¶ÂêéÂç´ (LB)', 'Âè≥ÂêéÂç´ (RB)', 'Èó®Â∞Ü (GK)'];
        const DEFAULT_IMAGE = 'https://images.unsplash.com/photo-1552667466-07770ae110d0?w=400&h=400&fit=crop';

        // --- MULTI-LANGUAGE DICTIONARY ---
        const TRANSLATIONS = {
            zh: {
                appTitle: "CFC YOUTH ACADEMY", systemName: "ÈùíËÆ≠Â≠¶Èô¢Á≥ªÁªü", localMode: "Êú¨Âú∞Áâà", cloudMode: "‰∫ëÁ´ØÂêåÊ≠•",
                backupRestore: "Â§á‰ªΩ/ÊÅ¢Â§ç", manageSchools: "Â≠¶Ê†°", attendanceTool: "Âá∫Â∏≠Â∫ì", financeTool: "Ë¥¢Âä°", 
                register: "Ê≥®ÂÜå", searchPlaceholder: "ÊêúÁ¥¢ÂßìÂêç„ÄÅÂ≠¶Ê†°...", noData: "ÊöÇÊó†ÁêÉÂëòÊï∞ÊçÆ",
                age: "Âπ¥ÈæÑ", category: "ÁªÑÂà´", height: "Ë∫´È´ò", weight: "‰ΩìÈáç", attendance: "Âá∫Â∏≠Áéá",
                attCount: "Âá∫Â∏≠Ê¨°Êï∞", totalCount: "Âπ¥Â∫¶ÁõÆÊ†á", coachReport: "ÊïôÁªÉÊä•Âëä", editReport: "ÁºñËæëÊä•Âëä",
                edit: "ÁºñËæë", delete: "Âà†Èô§", aiAnalyze: "ÊïôÁªÉÂàÜÊûê", updateProfile: "Êõ¥Êñ∞Ê°£Ê°à", newPlayer: "Êñ∞ÁêÉÂëò",
                name: "ÂßìÂêç", nationality: "ÂõΩÁ±ç", school: "ÊâÄÂ±ûÂ≠¶Ê†°", mainPos: "‰∏ª‰ΩçÁΩÆ", subPos: "ÂâØ‰ΩçÁΩÆ",
                parentName: "ÂÆ∂Èïø", phone: "ÁîµËØù", email: "ÁîµÈÇÆ", tin: "TIN",
                save: "‰øùÂ≠ò", cancel: "ÂèñÊ∂à", addSchool: "Êñ∞Â¢ûÂ≠¶Ê†°", backupTools: "Â§á‰ªΩÂ∑•ÂÖ∑",
                backupToDrive: "Â§á‰ªΩÂà∞ Google Drive", exportDesc: "ÁîüÊàêÂ§á‰ªΩÊñá‰ª∂Âπ∂Ëá™Âä®ÊâìÂºÄ‰Ω†ÁöÑ‰∫ëÁ´ØÊñá‰ª∂Â§π„ÄÇ",
                restoreData: "ÊÅ¢Â§çÊï∞ÊçÆ", restoreDesc: "‰ªéÊâãÊú∫Êñá‰ª∂Â§π‰∏≠ÈÄâÊã©‰πãÂâçÁöÑÂ§á‰ªΩÊñá‰ª∂ (.json)„ÄÇ",
                selectFile: "ÈÄâÊã©Â§á‰ªΩÊñá‰ª∂", shareProfile: "ÂàÜ‰∫´Ê°£Ê°à", sendToParents: "ÂèëÈÄÅÁªôÂÆ∂Èïø (Âê´ÁÖßÁâá)",
                textOnly: "‰ªÖÂèëÈÄÅÊñáÂ≠óÊä•Âëä", cropTitle: "Ë£ÅÂâ™Â§¥ÂÉè", rotate: "ÊóãËΩ¨", confirmCrop: "Á°ÆËÆ§Ë£ÅÂâ™",
                attTitle: "Êô∫ËÉΩÂá∫Â∏≠Â∫ì", attDate: "ËÆ∞ÂΩïÊó•Êúü", attPaste: "üìÑ Á≤òË¥¥ÂêçÂçïÂØºÂÖ• (WhatsApp/Excel)",
                attPasteDesc: "Áõ¥Êé•Á≤òË¥¥ÊñáÂ≠óÔºåÁ≥ªÁªü‰ºöËá™Âä®ËØÜÂà´ÂêçÂçï‰∏≠ÁöÑÂêçÂ≠óÂπ∂ÂãæÈÄâ„ÄÇ",
                attPlaceholder: "‰æãÂ¶ÇÔºö‰ªäÊó•Âá∫Â∏≠ÔºöArthur, Stella, Money...",
                attConfirm: "Êèê‰∫§ / Êõ¥Êñ∞ËÆ∞ÂΩï",
                attShare: "ÂàÜ‰∫´Âá∫Â∏≠Ë°®", attWhatsapp: "WhatsApp", attExcel: "ÂØºÂá∫‰∏ì‰∏öÊä•Ë°®", 
                attTotal: "ÊÄª‰∫∫Êï∞", attPresent: "Âá∫Â∏≠", resetStats: "ÈáçÁΩÆÊï∞ÊçÆ", 
                attSearch: "ÊêúÁ¥¢ËÄÉÂã§ÂêçÂçï...", attToggleAll: "‰∏ÄÈîÆÂÖ®ÈÄâ",
                attTabTrainees: "Â≠¶ÂëòËÄÉÂã§", attTabCoaches: "ÊïôÁªÉËÄÉÂã§", 
                cloudSetup: "‰∫ëÁ´ØÂêåÊ≠•ËÆæÁΩÆ (JSONBin)", cloudKey: "Master Key", cloudBin: "Bin ID",
                cloudConnect: "ËøûÊé•‰∫ëÁ´Ø", cloudCreate: "‚ú® Ëá™Âä®ÂàõÂª∫Êñ∞Êï∞ÊçÆÂ∫ì", 
                cloudDesc: "ËæìÂÖ• Key Âç≥ÂèØËá™Âä®ÂàõÂª∫Âπ∂ËøûÊé•‰∫ëÊï∞ÊçÆÂ∫ìÔºåÂÆûÁé∞Â§öËÆæÂ§áÂêåÊ≠•„ÄÇ",
                finTitle: "Ë¥¢Âä°‰∏≠ÂøÉ", finMonth: "Êúà‰ªΩ", finFee: "ÊúàË¥πÊ†áÂáÜ (RM)", finPaid: "Â∑≤‰∫§", finUnpaid: "Êú™‰∫§",
                finTotal: "ÊÄªÊî∂ÂÖ•", finPending: "ÂæÖÊî∂", finRemind: "ÂÇ¨Ë¥π", finExport: "ÂØºÂá∫Ë¥¢Âä°Ë°®",
                finBank: "Èì∂Ë°åÊà∑Âè£", finCopy: "Â§çÂà∂", finCopied: "Â∑≤Â§çÂà∂ÔºÅ", finToggleAll: "‰∏ÄÈîÆÂÖ®ÈÄâ",
                finSearch: "ÊêúÁ¥¢Ë¥¢Âä°ÂêçÂçï...",
                coachTool: "ÊïôÁªÉ‰∏≠ÂøÉ", coachTitle: "ÊïôÁªÉÁÆ°ÁêÜ‰∏≠ÂøÉ", coachList: "ÂêçÂçï", coachAtt: "ËÄÉÂã§", coachPay: "Ëñ™ËµÑ",
                coachRole: "ËÅå‰Ωç", coachRate: "ÂçïÂú∫Ê¥•Ë¥¥ (RM)", coachSessions: "Âú∫Ê¨°", coachTotal: "Â∫î‰ªòÂ∑•ËµÑ",
                coachPaid: "Â∑≤Âèë", coachUnpaid: "Êú™Âèë", addCoach: "Êñ∞Â¢ûÊïôÁªÉ",
                coachExport: "ÂØºÂá∫Ëñ™ËµÑË°®", coachTotalPayout: "ÊÄªÊîØÂá∫", coachWhatsapp: "ÂèëÊ∂àÊÅØ", coachPayslip: "ÂèëÂ∑•ËµÑÂçï",
                selectSchool: "ÈÄâÊã©ÊâìÂç°Ê†°Âå∫", coachDetails: "Êü•ÁúãÊòéÁªÜ",
                shareAppTitle: "ÂÆâË£Ö CFC App", shareAppDesc: "ËØ∑‰ΩøÁî®ÊµèËßàÂô®‚ÄúÊ∑ªÂä†Âà∞‰∏ªÂ±èÂπï‚ÄùÂäüËÉΩÂÆâË£Ö„ÄÇ",
                copyLink: "Â§çÂà∂ÈìæÊé•", linkCopied: "ÈìæÊé•Â∑≤Â§çÂà∂ÔºÅ", qrLabel: "PWA ÂÆâË£ÖÁ†Å",
                auth: {
                    welcome: "YOUR FUTURE IS NOW!", selectMode: "ËØ∑ÈÄâÊã©ÁôªÂΩïÊ®°Âºè", adminMode: "MASTER MODE", userMode: "PLAYER MODE",
                    enterPin: "ËØ∑ËæìÂÖ•ÁÆ°ÁêÜÂëòÂØÜÁ†Å", wrongPin: "ÂØÜÁ†ÅÈîôËØØ", login: "ÁôªÂΩï", logout: "ÈÄÄÂá∫",
                    adminDesc: "ÂÆåÊï¥ÊùÉÈôêÔºöËÄÉÂã§„ÄÅË¥¢Âä°„ÄÅÁºñËæë„ÄÅÂà†Èô§„ÄÇ", userDesc: "Âè™ËØªÊùÉÈôêÔºöÊü•ÁúãÊï∞ÊçÆ„ÄÅÁä∂ÊÄÅ„ÄÅÊêúÁ¥¢„ÄÇ"
                },
                imgCloudSetup: "üì∑ ÂõæÁâá‰∫ë (Cloudinary)", imgCloudName: "Cloud Name", imgUploadPreset: "Upload Preset", imgSave: "‰øùÂ≠òÂõæÁâáÈÖçÁΩÆ",
                imgCloudDesc: "ÈÖçÁΩÆÂêéÔºåÁÖßÁâáÂ∞ÜËá™Âä®‰∏ä‰º†‰∫ëÁ´Ø (ÈúÄÂºÄÂêØ Unsigned Ê®°Âºè)„ÄÇ", uploading: "‚òÅÔ∏è ‰∏ä‰º†‰∏≠...", imgTest: "ÊµãËØïËøûÊé•",
                msgTemplates: { gentle: "üå∏ Ê∏©ÊüîÊèêÈÜí", friendly: "ü§ù ÊúãÂèãËØ≠Ê∞î", soft: "üçÉ Â©âËΩ¨ÊèêÈÜí", formal: "üëî Ê≠£ÂºèÈÄöÁü•" },
                msgs: {
                    gentle: "Hi ÂÆ∂ÈïøÂ•Ω üëãÔºåÊ∏©È¶®ÊèêÈÜí‰∏Ä‰∏ãÔºå{name} {month} Êúà‰ªΩÁöÑÂ≠¶Ë¥π (RM{amount}) Â∞öÊú™Áº¥‰∫§„ÄÇÊñπ‰æøÁöÑËØùËØ∑ÂÆâÊéíÊ±áÊ¨æÔºåË∞¢Ë∞¢ÊÇ®ÁöÑÊîØÊåÅÔºÅüôèüèª",
                    friendly: "Hello! üëã ËøôÊòØ‰∏Ä‰∏™ÂÖ≥‰∫é {name} {month} ÊúàÂ≠¶Ë¥π (RM{amount}) ÁöÑÂ∞èÂ∞èÊèêÈÜí„ÄÇÂ¶ÇÊûúÂ∑≤ÁªèËΩ¨Ë¥¶ËØ∑ÂøΩÁï•Âì¶ÔºåË∞¢Ë∞¢ÔºÅ‚öΩÔ∏è",
                    soft: "ÂÆ∂ÈïøÂ•Ω üòäÔºåÊúÄËøëÊØîËæÉÂøôÂêßÔºüÂè™ÊòØÊÉ≥Á°ÆËÆ§‰∏Ä‰∏ã {name} {month} ÊúàÁöÑÂ≠¶Ë¥π (RM{amount})„ÄÇÊúâÁ©∫È∫ªÁÉ¶Â§ÑÁêÜ‰∏Ä‰∏ãÂì¶ÔºåÊÑüË∞¢ÔºÅ‚ú®",
                    formal: "„ÄêCFC Ë¥¢Âä°ÈÄöÁü•„ÄëÊÇ®Â•ΩÔºåËØ∑Êü•Êî∂ {name} {month} Êúà‰ªΩÁöÑÂ≠¶Ë¥πÂçï (RM{amount})„ÄÇËØ∑Âú®ËøëÊúüÂÜÖÂÆåÊàêÁº¥Ë¥πÔºåÊÑüË∞¢ÈÖçÂêà„ÄÇ"
                },
                bankDetails: "\n\nüè¶ Ê±áÊ¨æËµÑÊñô:\n{bankName}\n{accNum}\n{holder}\n\nPlease share receipt. Thanks!",
                stats: { pace: "ÈÄüÂ∫¶", shooting: "Â∞ÑÈó®", passing: "‰º†ÁêÉ", dribbling: "ÁõòÂ∏¶", defending: "Èò≤ÂÆà", physical: "‰ΩìËÉΩ" },
                ai: { analyzing: "ÊïôÁªÉÂàÜÊûê‰∏≠...", reportTitle: "ÊïôÁªÉÊ∑±Â∫¶ËØÑ‰º∞Êä•Âëä", position: "ÁêÉÂëòÂÆö‰Ωç", rating: "ÁªºÂêàËØÑÁ∫ß", strength: "Ê†∏ÂøÉÁ´û‰∫âÂäõ", suggestion: "ÊàòÊúØÂª∫ËÆÆ", comment: "ÊïôÁªÉËØÑËØ≠", template: "ÂùáË°°ÂûãÁêÉÂëò", advice: "ÈúÄËøõ‰∏ÄÊ≠•ËßÇÂØü„ÄÇ", commentText: "ÊΩúÂäõ‰∏çÈîôÔºåÂª∫ËÆÆÁªßÁª≠ËßÇÂØü„ÄÇ" },
                status: { syncing: "‚è≥ ÂêåÊ≠•‰∏≠...", ready: "‚úÖ Â∞±Áª™", fail: "‚ùå Â§±Ë¥•", netError: "‚ùå ÁΩëÁªúÈîôËØØ", saving: "‚òÅÔ∏è ‰øùÂ≠ò‰∏≠...", saved: "‚úÖ Â∑≤‰øùÂ≠ò", saveFail: "‚ùå ‰øùÂ≠òÂ§±Ë¥•", creating: "ÂàõÂª∫‰∏≠...", created: "‚úÖ Â∑≤ÂàõÂª∫", error: "‚ùå ÈîôËØØ" },
                alerts: {
                    fillImgConfig: "ËØ∑Â°´ÂÜô Cloud Name Âíå Upload Preset", imgCloudConnected: "‚úÖ ÂõæÁâá‰∫ëÂ∑≤ËøûÊé•ÔºÅ",
                    fillMasterKey: "ËØ∑ÂÖàÂ°´ÂÖ• Master Key", cloudCreated: "‚úÖ ‰∫ëÁ´ØÊï∞ÊçÆÂ∫ìÂàõÂª∫ÊàêÂäüÔºÅ\n\nBin ID: {binId}\n\nËØ∑Âä°ÂøÖÂ§çÂà∂Ëøô‰∏™ IDÔºåÂú®ÂÖ∂‰ªñÊâãÊú∫Â°´ÂÖ•Âç≥ÂèØÂêåÊ≠•Êï∞ÊçÆ„ÄÇ",
                    fillCloudConfig: "ËØ∑Â°´ÂÜô Master Key Âíå Bin ID", backupDownloaded: "‚úÖ Â§á‰ªΩÂ∑≤‰∏ãËΩΩÔºÅ",
                    overwriteConfirm: "‚ö†Ô∏è Ë¶ÜÁõñÂΩìÂâçÊï∞ÊçÆÔºü", fileError: "‚ùå Êñá‰ª∂ÈîôËØØ", deleteConfirm: "Á°ÆÂÆöË¶ÅÂà†Èô§Ê≠§È°πËÆ∞ÂΩïÂêóÔºü",
                    resetConfirm: "‚ö†Ô∏è Á°ÆÂÆöË¶ÅÈáçÁΩÆÊ≠§ÁêÉÂëòÁöÑËÄÉÂã§Êï∞ÊçÆÂêóÔºü", updated: "‚úÖ Êï∞ÊçÆÂ∑≤Êõ¥Êñ∞ÔºÅ", copied: "Â∑≤Â§çÂà∂ÔºÅ", useWhatsapp: "ËØ∑‰ΩøÁî® WhatsApp ÊåâÈíÆ",
                    attConfirmMsg: "Á°ÆËÆ§Êèê‰∫§ËÄÉÂã§Ôºü\n\nüìÖ Êó•Êúü: {date}\nüë¶ Â≠¶ÂëòÂÆûÂà∞: {sCount}\nüë®‚Äçüè´ ÊïôÁªÉÂÆûÂà∞: {cCount}",
                    finConfirmAll: "‚ö†Ô∏è Á°ÆÂÆöË¶ÅÊääÂàóË°®‰∏≠ÁöÑÊâÄÊúâ‰∫∫Ê†áËÆ∞‰∏∫ [{status}] ÂêóÔºü",
                    imgLocalWarning: "‚ö†Ô∏è ÁÖßÁâáÊòØÊú¨Âú∞Êï∞ÊçÆÔºåÊó†Ê≥ïÈÄöËøáÁΩëÈ°µËá™Âä®ÈôÑÂä†„ÄÇÂ∑≤ÊâìÂºÄ WhatsAppÔºåËØ∑ÊâãÂä®ÂèëÈÄÅÁÖßÁâá„ÄÇ"
                }
            },
            en: {
                appTitle: "CFC YOUTH ACADEMY", systemName: "ACADEMY SYSTEM", localMode: "Local", cloudMode: "Cloud Sync",
                backupRestore: "Backup", manageSchools: "Schools", attendanceTool: "Attendance", financeTool: "Finance",
                register: "Register", searchPlaceholder: "Search...", noData: "No Data",
                auth: {
                    welcome: "YOUR FUTURE IS NOW!", selectMode: "Select Mode", adminMode: "MASTER MODE", userMode: "PLAYER MODE",
                    enterPin: "Enter PIN", wrongPin: "Wrong PIN", login: "Login", logout: "Logout",
                    adminDesc: "Full Access.", userDesc: "Read Only."
                }
            }
        };

        // --- PURE HELPER FUNCTIONS ---
        const getStatGrade = (val) => { const v = parseInt(val) || 0; return v >= 85 ? 'A' : v >= 70 ? 'B' : v >= 55 ? 'C' : 'D'; };
        const getGradeColor = (grade) => { return grade === 'A' ? 'text-emerald-400 font-black' : grade === 'B' ? 'text-blue-400 font-bold' : grade === 'C' ? 'text-yellow-400 font-bold' : 'text-zinc-500'; };
        const getAttendanceColor = (v) => v >= 90 ? 'bg-emerald-500' : (v >= 70 ? 'bg-yellow-500' : 'bg-red-500');
        const getPositionCode = (s) => (s && s !== 'Êó†') ? s.match(/\((.*?)\)/)?.[1] || s.substring(0,2) : '';
        const dataURLtoFile = (dataurl, filename) => { try { let arr = dataurl.split(','), mime = arr[0].match(/:(.*?);/)[1], bstr = atob(arr[1]), n = bstr.length, u8arr = new Uint8Array(n); while(n--){ u8arr[n] = bstr.charCodeAt(n); } return new File([u8arr], filename, {type:mime}); } catch(e) { return null; } };

        const { useState, useEffect, useRef, useMemo } = React;

        // --- APP COMPONENT ---
        const App = () => {
            const [lang, setLang] = useState('zh');
            const [userRole, setUserRole] = useState(null); 
            const [pinInput, setPinInput] = useState("");
            const [showPinInput, setShowPinInput] = useState(false);

            const [teams, setTeams] = useState(INITIAL_TEAMS);
            const [trainees, setTrainees] = useState([]);
            const [coaches, setCoaches] = useState(INITIAL_COACHES);
            const [leagueName, setLeagueName] = useState('CFC YOUTH ACADEMY');
            const [appLogo, setAppLogo] = useState(null);

            const [cloudConfig, setCloudConfig] = useState({ key: MY_MASTER_KEY || '', binId: '' });
            const [isCloudConnected, setIsCloudConnected] = useState(false);
            const [cloudStatus, setCloudStatus] = useState("");
            const [imgConfig, setImgConfig] = useState({ cloudName: MY_CLOUD_NAME, uploadPreset: '' });
            const [isImgCloudReady, setIsImgCloudReady] = useState(false);
            const [uploadingStatus, setUploadingStatus] = useState("");

            const [isModalOpen, setIsModalOpen] = useState(false);
            const [isSchoolManagerOpen, setIsSchoolManagerOpen] = useState(false);
            const [isDataToolsOpen, setIsDataToolsOpen] = useState(false); 
            const [isAttendanceOpen, setIsAttendanceOpen] = useState(false);
            const [isFinanceOpen, setIsFinanceOpen] = useState(false); 
            const [isCloudModalOpen, setIsCloudModalOpen] = useState(false);
            const [isEditingReport, setIsEditingReport] = useState(false);
            const [isCropperOpen, setIsCropperOpen] = useState(false);
            const [isCoachOpen, setIsCoachOpen] = useState(false);
            const [coachView, setCoachView] = useState('list');
            const [isLogoCrop, setIsLogoCrop] = useState(false);
            const [expandedCoachId, setExpandedCoachId] = useState(null);
            const [isShareAppOpen, setIsShareAppOpen] = useState(false);

            const [shareTarget, setShareTarget] = useState(null);
            const [searchTerm, setSearchTerm] = useState('');
            const [selectedPosition, setSelectedPosition] = useState('ÂÖ®ÈÉ®');
            const [selectedTeam, setSelectedTeam] = useState('ÂÖ®ÈÉ®');
            const [editingTrainee, setEditingTrainee] = useState(null);
            const [isEditingTitle, setIsEditingTitle] = useState(false);
            const [formData, setFormData] = useState(DEFAULT_FORM_DATA);
            const [coachForm, setCoachForm] = useState({ name: '', role: 'Assistant', rate: 100, phone: '' });
            const [editingCoach, setEditingCoach] = useState(null);
            const [renamingTeam, setRenamingTeam] = useState({ original: '', current: '' });
            const [aiResult, setAiResult] = useState({content: null, name: null});
            const [attendanceList, setAttendanceList] = useState([]);
            const [coachAttendanceList, setCoachAttendanceList] = useState([]);
            const [attTab, setAttTab] = useState('trainees');
            const [importText, setImportText] = useState("");
            const [attendanceDate, setAttendanceDate] = useState(new Date().toISOString().slice(0, 10)); 
            const [attendanceSearchTerm, setAttendanceSearchTerm] = useState(''); 
            const [coachAttDate, setCoachAttDate] = useState(new Date().toISOString().slice(0, 10)); 
            const [coachAttSchool, setCoachAttSchool] = useState('');
            const [financeMonth, setFinanceMonth] = useState(new Date().toISOString().slice(0, 7));
            const [financeSearchTerm, setFinanceSearchTerm] = useState('');
            const [monthlyFee, setMonthlyFee] = useState(DEFAULT_MONTHLY_FEE);
            const [msgTemplate, setMsgTemplate] = useState('gentle');
            const [shareUrl, setShareUrl] = useState(window.location.href);

            const [tempImage, setTempImage] = useState(null);
            const cropperRef = useRef(null);
            const cropperImageRef = useRef(null);
            const fileInputRef = useRef(null);
            const logoInputRef = useRef(null);
            const backupInputRef = useRef(null);
            const [aiLoading, setAiLoading] = useState(false);

            // --- Remove Loader ---
            useEffect(() => {
                const timer = setTimeout(() => {
                    const loader = document.getElementById('static-loading');
                    if (loader) loader.classList.add('hidden');
                }, 1000);
                return () => clearTimeout(timer);
            }, []);

            // --- Translations ---
            const t = (key, subKey) => {
                const dict = TRANSLATIONS[lang] || TRANSLATIONS['zh'];
                if (subKey && dict[key]) return dict[key][subKey] || key;
                return dict[key] || key;
            };

            // --- Data Update Logic ---
            const updateData = (newData) => {
                const updated = {
                    trainees: newData.trainees !== undefined ? newData.trainees : trainees,
                    coaches: newData.coaches !== undefined ? newData.coaches : coaches,
                    teams: newData.teams !== undefined ? newData.teams : teams,
                    leagueName: newData.leagueName !== undefined ? newData.leagueName : leagueName,
                    appLogo: newData.appLogo !== undefined ? newData.appLogo : appLogo
                };
                setTrainees(updated.trainees);
                setCoaches(updated.coaches);
                setTeams(updated.teams);
                setLeagueName(updated.leagueName);
                setAppLogo(updated.appLogo);
                try { localStorage.setItem('cfc_local_db', JSON.stringify(updated)); } catch(e){ alert("Storage Full"); }
                if (isCloudConnected) syncToCloud(updated);
            };

            const syncFromCloud = async (key, binId) => {
                setCloudStatus("‚è≥");
                try {
                    const res = await fetch(`${JSONBIN_URL}/${binId}/latest`, { headers: { 'X-Master-Key': key } });
                    if (res.ok) {
                        const json = await res.json();
                        const data = json.record;
                        // Smart merge logo
                        const localLogo = appLogo;
                        updateData({ ...data, appLogo: data.appLogo || localLogo });
                        setIsCloudConnected(true); setCloudStatus("‚úÖ");
                    }
                } catch (e) { setCloudStatus("‚ùå"); }
            };

            const syncToCloud = async (data) => {
                if (!isCloudConnected) return;
                try {
                    const stripped = { ...data, trainees: data.trainees.map(t => t.image.startsWith('data:') ? { ...t, image: DEFAULT_IMAGE } : t) };
                    await fetch(`${JSONBIN_URL}/${cloudConfig.binId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json', 'X-Master-Key': cloudConfig.key },
                        body: JSON.stringify(stripped)
                    });
                } catch (e) {}
            };

            const createCloudBin = async () => {
                try {
                    const res = await fetch(JSONBIN_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'X-Master-Key': cloudConfig.key, 'X-Bin-Private': 'true' },
                        body: JSON.stringify({ trainees, coaches, teams, leagueName })
                    });
                    const json = await res.json();
                    const newBin = json.metadata.id;
                    setCloudConfig(p => ({ ...p, binId: newBin }));
                    localStorage.setItem('cfc_jsonbin_config', JSON.stringify({ ...cloudConfig, binId: newBin }));
                    setIsCloudConnected(true);
                } catch (e) { alert("Fail"); }
            };

            const handleConnectCloud = () => { if (cloudConfig.key && cloudConfig.binId) { localStorage.setItem('cfc_jsonbin_config', JSON.stringify(cloudConfig)); syncFromCloud(cloudConfig.key, cloudConfig.binId); setIsCloudModalOpen(false); } else { alert(t('alerts', 'fillCloudConfig')); } };

            const uploadToCloudinary = async (base64Image) => {
                if (!imgConfig.cloudName || !imgConfig.uploadPreset) { alert(t('alerts', 'fillImgConfig')); return null; }
                setUploadingStatus(t('uploading'));
                const url = `https://api.cloudinary.com/v1_1/${imgConfig.cloudName}/image/upload`;
                const formData = new FormData();
                formData.append('file', base64Image);
                formData.append('upload_preset', imgConfig.uploadPreset);
                try {
                    const response = await fetch(url, { method: 'POST', body: formData });
                    const data = await response.json();
                    setUploadingStatus("");
                    if (data.error) { alert(`‚ùå Cloudinary: ${data.error.message}`); return null; }
                    return data.secure_url;
                } catch (error) { alert("‚ö†Ô∏è Network Error"); setUploadingStatus(""); return null; }
            };

            const testCloudinary = async () => {
                const testPixel = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8/5+hHgAHggJ/PchI7wAAAABJRU5ErkJggg==";
                const url = await uploadToCloudinary(testPixel);
                if (url) alert(`‚úÖ Connection OK!\nURL: ${url}`);
            };

            const saveImgConfig = () => {
                if(imgConfig.cloudName && imgConfig.uploadPreset) {
                    localStorage.setItem('cfc_cloudinary_config', JSON.stringify(imgConfig));
                    setIsImgCloudReady(true);
                    alert(t('alerts', 'imgCloudConnected'));
                } else { alert(t('alerts', 'fillImgConfig')); }
            };

            const handleBackupToDrive = () => { const d=JSON.stringify({trainees,teams,leagueName,appLogo, coaches},null,2); const b=new Blob([d],{type:"application/json"}); const u=URL.createObjectURL(b); const l=document.createElement('a'); l.href=u; const dt=new Date().toISOString().slice(0,10); l.download=`CFC_Backup_${dt}.json`; document.body.appendChild(l); l.click(); document.body.removeChild(l); URL.revokeObjectURL(u); setTimeout(() => { if(confirm(t('alerts', 'backupDownloaded'))) window.open(DRIVE_LINK, '_blank'); }, 500); };
            const handleImportFile = (e) => { const f=e.target.files?.[0]; if(!f) return; const r=new FileReader(); r.onload=(ev) => { try { const p=JSON.parse(ev.target.result); if(!p.trainees) throw new Error(); if(confirm(t('alerts', 'overwriteConfirm'))) { updateData(p); alert(t('alerts', 'updated')); setIsDataToolsOpen(false); } } catch (e) { alert(t('alerts', 'fileError')); } e.target.value=null; }; r.readAsText(f); };

            const handleLogoFile = (e) => {
                const f = e.target.files[0]; if (!f) return;
                const reader = new FileReader();
                reader.onload = (ev) => { setTempImage(ev.target.result); setIsLogoCrop(true); setIsCropperOpen(true); };
                reader.readAsDataURL(f);
                e.target.value = "";
            };

            const handleTraineeFile = (e) => {
                const f = e.target.files[0]; if (!f) return;
                const reader = new FileReader();
                reader.onload = (ev) => { setTempImage(ev.target.result); setIsLogoCrop(false); setIsCropperOpen(true); };
                reader.readAsDataURL(f);
                e.target.value = "";
            };

            const handleCropConfirm = async () => {
                if (cropperRef.current) {
                    const c = cropperRef.current.getCroppedCanvas({ width: 250, height: 250 });
                    const base64Url = c.toDataURL('image/jpeg', 0.7);
                    let finalUrl = base64Url;
                    if (imgConfig.cloudName && imgConfig.uploadPreset) {
                        const cloudUrl = await uploadToCloudinary(base64Url);
                        if(cloudUrl) finalUrl = cloudUrl;
                    }
                    if (isLogoCrop) updateData({ appLogo: finalUrl });
                    else setFormData(p => ({ ...p, image: finalUrl }));
                    setIsCropperOpen(false); setTempImage(null);
                }
            };
            const handleRotate = () => { if (cropperRef.current) cropperRef.current.rotate(90); };

            const handleLogin = (role) => {
                if (role === 'admin' && pinInput !== ADMIN_PIN) return alert("Wrong PIN");
                setUserRole(role);
                setPinInput("");
                setShowPinInput(false);
            };

            // üî• Filter Logic moved up
            const filteredTrainees = useMemo(() => trainees.filter(t => 
                (selectedTeam === 'ÂÖ®ÈÉ®' || t.team === selectedTeam) &&
                (t.name.toLowerCase().includes(searchTerm.toLowerCase()))
            ), [trainees, selectedTeam, searchTerm]);

            const attendanceFiltered = useMemo(() => {
                const term = attendanceSearchTerm.toLowerCase();
                return (attTab === 'trainees' ? filteredTrainees : coaches).filter(item => 
                    item.name.toLowerCase().includes(term)
                );
            }, [attTab, filteredTrainees, coaches, attendanceSearchTerm]);

            const financeFiltered = useMemo(() => filteredTrainees.filter(trainee => 
                (trainee.name || '').toLowerCase().includes(financeSearchTerm.toLowerCase()) || 
                (trainee.team || '').toLowerCase().includes(financeSearchTerm.toLowerCase()) ||
                (trainee.parentName || '').toLowerCase().includes(financeSearchTerm.toLowerCase())
            ), [filteredTrainees, financeSearchTerm]);

            // üî• Function Definitions
            const getOptimizedImageUrl = (url) => {
                if (!url || typeof url !== 'string' || !url.includes('cloudinary.com')) return url || DEFAULT_IMAGE;
                let cleanUrl = url.replace(/([^:]\/)\/+/g, "$1"); 
                if (cleanUrl.includes('/f_avif,q_auto/')) return cleanUrl; 
                return cleanUrl.replace('/upload/', '/upload/f_avif,q_auto/');
            };

            const openAttendanceModal = () => {
                const today = new Date().toISOString().slice(0, 10);
                setAttendanceDate(today);
                setAttendanceSearchTerm(''); 
                setAttTab('trainees');
                
                const presentPlayerIds = filteredTrainees.filter(t => t.attendanceHistory && t.attendanceHistory.some(h => (typeof h === 'string' ? h : h.date) === today && (typeof h === 'string' || h.status === 'present'))).map(t => t.id);
                const playerRecordExists = filteredTrainees.some(t => t.attendanceHistory?.some(h => (typeof h === 'string' ? h : h.date) === today));
                
                if (playerRecordExists) { setAttendanceList(presentPlayerIds); } 
                else { setAttendanceList(filteredTrainees.map(t => t.id)); }
                
                const presentCoachIds = coaches.filter(c => c.attendanceHistory && c.attendanceHistory.some(h => h.date === today)).map(c => c.id);
                const coachRecordExists = coaches.some(c => c.attendanceHistory?.some(h => h.date === today));
                
                if (coachRecordExists) { setCoachAttendanceList(presentCoachIds); } 
                else { setCoachAttendanceList(coaches.map(c => c.id)); }
                
                setImportText(""); setIsAttendanceOpen(true);
            };

            const toggleAttendance = (id) => {
                if (attTab === 'trainees') {
                    if (attendanceList.includes(id)) setAttendanceList(attendanceList.filter(pid => pid !== id)); 
                    else setAttendanceList([...attendanceList, id]); 
                } else {
                    if (coachAttendanceList.includes(id)) setCoachAttendanceList(coachAttendanceList.filter(cid => cid !== id));
                    else setCoachAttendanceList([...coachAttendanceList, id]);
                }
            };

            const toggleCoachAttendance = (id) => {
                const newCoaches = coaches.map(c => {
                    if (c.id === id) {
                        const history = c.attendanceHistory || [];
                        const exists = history.some(h => h.date === coachAttDate && h.school === coachAttSchool);
                        const newHistory = exists 
                            ? history.filter(h => !(h.date === coachAttDate && h.school === coachAttSchool))
                            : [...history, { date: coachAttDate, school: coachAttSchool, status: 'present' }];
                        return { ...c, attendanceHistory: newHistory };
                    }
                    return c;
                });
                updateData({ coaches: newCoaches });
            };

            const removeCoachRecord = (coachId, date, school) => {
                if (!confirm(t('alerts', 'deleteConfirm'))) return;
                const newCoaches = coaches.map(c => {
                    if (c.id === coachId) {
                        const newHistory = (c.attendanceHistory || []).filter(h => !(h.date === date && h.school === school));
                        return { ...c, attendanceHistory: newHistory };
                    }
                    return c;
                });
                updateData({ coaches: newCoaches });
            };
            
            const toggleCoachPayment = (coachId) => {
                const newCoaches = coaches.map(c => {
                    if (c.id === coachId) {
                        const history = c.paymentHistory || {};
                        const currentStatus = history[financeMonth]?.status === 'paid';
                        const sessions = (c.attendanceHistory || []).filter(h => h.date.startsWith(financeMonth)).length;
                        const total = sessions * (c.rate || 0);
                        return { 
                            ...c, 
                            paymentHistory: { ...history, [financeMonth]: { status: currentStatus ? 'unpaid' : 'paid', amount: total } } 
                        };
                    }
                    return c;
                });
                updateData({ coaches: newCoaches });
            };

            const getPayroll = () => {
                let totalPayout = 0;
                const list = coaches.map(c => {
                    const monthSessions = (c.attendanceHistory || []).filter(h => h.date.startsWith(financeMonth));
                    const amount = monthSessions.length * (c.rate || 0);
                    const isPaid = c.paymentHistory?.[financeMonth]?.status === 'paid';
                    if (isPaid) totalPayout += amount;
                    monthSessions.sort((a,b) => a.date.localeCompare(b.date));
                    return { ...c, sessions: monthSessions.length, amount, isPaid, details: monthSessions };
                });
                return { list, totalPayout };
            };

            const handleEdit = (t) => {
                setEditingTrainee(t);
                setFormData({ ...t });
                setIsModalOpen(true);
            };

            const handleSaveTrainee = () => {
                if (!formData.name) return;
                const data = { 
                    ...formData, 
                    image: formData.image || DEFAULT_IMAGE,
                    stats: formData.stats || DEFAULT_FORM_DATA.stats,
                    name: formData.name || 'Unknown',
                    team: formData.team || 'Free Agent'
                }; 
                let newTrainees;
                if (editingTrainee) {
                    const oldT = trainees.find(t => t.id === editingTrainee.id) || editingTrainee; 
                    newTrainees = trainees.map(t => t.id === editingTrainee.id ? { 
                        ...data, 
                        attendanceHistory: oldT.attendanceHistory || [], 
                        feeHistory: oldT.feeHistory || {}, 
                        id: t.id 
                    } : t);
                } else {
                    newTrainees = [{ ...data, id: Date.now().toString(), attendanceHistory: [], feeHistory: {} }, ...trainees];
                }
                updateData({ trainees: newTrainees });
                setIsModalOpen(false);
            };
            
            const handleRegister = () => {
                setEditingTrainee(null);
                setFormData(DEFAULT_FORM_DATA);
                setIsModalOpen(true);
            };
            
            const deleteTrainee = (id) => { if(confirm(t('alerts', 'deleteConfirm'))) { const newT = trainees.filter(t => t.id !== id); updateData({ trainees: newT }); } };
            
            const saveCoach = () => {
                if(!coachForm.name) return;
                let newCoaches;
                if(editingCoach) {
                    newCoaches = coaches.map(c => c.id === editingCoach.id ? { ...c, ...coachForm } : c);
                } else {
                    newCoaches = [...coaches, { ...coachForm, id: Date.now().toString(), attendanceHistory: [], paymentHistory: {} }];
                }
                updateData({ coaches: newCoaches });
                setEditingCoach(null);
                setCoachForm({ name: '', role: 'Assistant', rate: 100, phone: '' });
            };
            const deleteCoach = (id) => {
                if(!confirm(t('alerts', 'deleteConfirm'))) return;
                const newCoaches = coaches.filter(c => c.id !== id);
                updateData({ coaches: newCoaches });
            };

            const handleAttendanceChange = (field, value) => { const val = parseInt(value) || 0; let newData = { ...formData, [field]: val }; const att = field === 'attendedSessions' ? val : formData.attendedSessions; const tot = field === 'totalSessions' ? val : formData.totalSessions; const newRate = tot === 0 ? 0 : Math.round((att / tot) * 100); newData.attendance = newRate; setFormData(newData); };
            const resetPlayerStats = () => { if(!confirm(t('alerts', 'resetConfirm'))) return; const data = { ...formData, totalSessions: PRESET_YEARLY_TOTAL, attendedSessions: 0, attendance: 0, attendanceHistory: [] }; setFormData(data); };
            
            const handleRenameTeam = (old) => { const n = renamingTeam.current.trim(); if(!n || n===old) return setRenamingTeam({original:'',current:''}); const newTeams = teams.map(teamName=>teamName===old?n:teamName); const newT = trainees.map(trainee=>trainee.team===old?{...trainee,team:n}:trainee); updateData({teams:newTeams, trainees:newT}); setRenamingTeam({original:'',current:''}); };
            const handleAddTeam = () => { const n=`New School ${teams.length+1}`; updateData({teams:[...teams,n]}); };
            const handleDeleteTeam = (n) => { if(!confirm(`${t('delete')} ${n}?`)) return; const newTeams=teams.filter(teamName=>teamName!==n); const newT=trainees.map(trainee=>trainee.team===n?{...trainee,team:'Free Agent'}:trainee); updateData({teams:newTeams,trainees:newT}); };
            
            const mockAI = (type, trainee) => { setAiLoading(true); setAiResult({ name: trainee.name, content: TRANSLATIONS[lang].ai.analyzing }); setIsEditingReport(false); setTimeout(() => { const stats=trainee.stats||{pace:50}; const sorted=Object.entries(stats).sort((a,b)=>b[1]-a[1]); const best=sorted[0]; const weak=sorted[sorted.length-1]; const d=TRANSLATIONS[lang].ai; const sd=TRANSLATIONS[lang].stats; let rep=`„Äê${d.reportTitle}„Äë\n\nüî• ${d.strength}Ôºö${sd[best[0]]} (${best[1]})\nüìù ${d.suggestion}Ôºö${d.advice}\n\nüí¨ ${d.comment}Ôºö\n"${trainee.name} - ${d.commentText}"`; setAiResult({name:trainee.name, content:rep}); setAiLoading(false); }, 1000); };
            const generateShareText = (trainee) => { const L = TRANSLATIONS[lang]; const c = trainee.category ? `[${trainee.category}] ` : ''; let base = `„Äê${L.appTitle}„Äë\n\n${L.name}Ôºö${trainee.name}\n${L.school}Ôºö${c}${trainee.team}\n${L.mainPos}Ôºö${trainee.primaryPosition}\n${L.age}Ôºö${trainee.age} | ${L.height}Ôºö${trainee.height||'-'}cm | ${L.weight}Ôºö${trainee.weight||'-'}kg\n${L.attendance}Ôºö${trainee.attendance||0}%\n\nüìä ${L.stats.pace}: ${trainee.stats.pace} | ${L.stats.shooting}: ${trainee.stats.shooting}\n${L.stats.passing}: ${trainee.stats.passing} | ${L.stats.dribbling}: ${trainee.stats.dribbling}\n${L.stats.defending}: ${trainee.stats.defending} | ${L.stats.physical}: ${trainee.stats.physical}`; return base; };
            const handleSystemShare = async (trainee) => { const text = generateShareText(trainee); const shareData = { title: trainee.name, text: text }; if (trainee.image && trainee.image.startsWith('data:image')) { const file = dataURLtoFile(trainee.image, `${trainee.name}.jpg`); if (file && navigator.canShare && navigator.canShare({ files: [file] })) { shareData.files = [file]; } } else if (trainee.image && trainee.image.startsWith('http')) { shareData.text += `\n\nPhoto: ${trainee.image}`; } try { await navigator.share(shareData); } catch(e) { const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(shareData.text)}`; window.open(whatsappUrl, '_blank'); } };
            const handleReportShare = async () => { if(!aiResult) return; const txt = aiResult.content; try { if(navigator.share) await navigator.share({text:txt}); else { const ta=document.createElement("textarea"); ta.value=txt; document.body.appendChild(ta); ta.select(); document.execCommand("copy"); document.body.removeChild(ta); alert(t('alerts', 'copied')); } } catch(e){} };
            const handleWhatsappShare = () => { const date = attendanceDate; const pNames = attendanceFiltered.filter(item => attendanceList.includes(item.id)).map(item => item.name); const aNames = attendanceFiltered.filter(item => !attendanceList.includes(item.id)).map(item => item.name); let text = `üìÖ *CFCYA Attendance - ${date}*\n\n‚úÖ *Present (${pNames.length})*:\n${pNames.join('\n')}\n\n‚ùå *Absent (${aNames.length})*:\n${aNames.join('\n')}`; window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank'); };
            const handleExportAttendanceExcel = () => { const date = attendanceDate; const targetSchool = selectedTeam === 'ÂÖ®ÈÉ®' ? 'All_Schools' : selectedTeam.split(' ')[0].replace(/[^a-zA-Z0-9]/g, ''); let csvContent = "\uFEFFName,Team,Category,Status,Date\n"; reportFiltered.forEach(trainee => { const status = attendanceList.includes(trainee.id) ? "Present" : "Absent"; csvContent += `${trainee.name.replace(/,/g," ")},${trainee.team.replace(/,/g," ")},${trainee.category||""},${status},${date}\n`; }); const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" }); const url = URL.createObjectURL(blob); const link = document.createElement("a"); link.href = url; link.download = `CFC_Att_${targetSchool}_${date}.csv`; document.body.appendChild(link); link.click(); document.body.removeChild(link); };
            const exportFinanceExcel = () => { const targetSchool = selectedTeam === 'ÂÖ®ÈÉ®' ? 'All_Schools' : selectedTeam.split(' ')[0].replace(/[^a-zA-Z0-9]/g, ''); const teamsMap = {}; financeFiltered.forEach(trainee => { if (!teamsMap[trainee.team]) teamsMap[trainee.team] = []; teamsMap[trainee.team].push(trainee); }); let csvContent = "\uFEFF"; csvContent += `CFC YOUTH ACADEMY FINANCE REPORT\nMonth:,${financeMonth}\nGenerated:,${new Date().toISOString().slice(0, 10)}\nScope:,${targetSchool}\nFee Standard:,RM ${monthlyFee}\n\n`; let grandTotalCollected = 0; let grandTotalPending = 0; Object.keys(teamsMap).sort().forEach(school => { const students = teamsMap[school]; const paidCount = students.filter(t => t.feeHistory && t.feeHistory[financeMonth]).length; const totalCount = students.length; const unpaidCount = totalCount - paidCount; const collected = paidCount * monthlyFee; const pending = unpaidCount * monthlyFee; const rate = totalCount === 0 ? 0 : Math.round((paidCount / totalCount) * 100); grandTotalCollected += collected; grandTotalPending += pending; csvContent += `------------------------------------------------\nSCHOOL:,${school.replace(/,/g, " ")}\nSummary:,${paidCount} Paid / ${totalCount} Total (${rate}%)\nCash Flow:,Collected: RM ${collected},Pending: RM ${pending}\n------------------------------------------------\nName,Category,Position,Fee (RM),Status\n`; students.sort((a, b) => { if (a.category !== b.category) return (a.category || '').localeCompare(b.category || ''); return a.name.localeCompare(b.name); }); students.forEach(t => { const isPaid = t.feeHistory && t.feeHistory[financeMonth]; const status = isPaid ? "PAID" : "UNPAID"; csvContent += `${t.name.replace(/,/g," ")},${t.category||"-"},${t.primaryPosition.split(' ')[0]},${monthlyFee},${status}\n`; }); csvContent += `\n\n`; }); if (selectedTeam === 'ÂÖ®ÈÉ®') { csvContent += `================================================\nGRAND TOTAL SUMMARY\nTotal Collected:,RM ${grandTotalCollected}\nTotal Pending:,RM ${grandTotalPending}\n================================================\n`; } const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" }); const url = URL.createObjectURL(blob); const link = document.createElement("a"); link.href = url; link.download = `CFC_Fin_${targetSchool}_${financeMonth}.csv`; document.body.appendChild(link); link.click(); document.body.removeChild(link); };
            const toggleFeeStatus = (traineeId) => { const newTrainees = trainees.map(trainee => { if (trainee.id === traineeId) { const history = trainee.feeHistory || {}; const currentStatus = history[financeMonth] || false; return { ...trainee, feeHistory: { ...history, [financeMonth]: !currentStatus } }; } return trainee; }); updateData({ trainees: newTrainees }); };
            const toggleAllFeeStatus = () => { const allPaid = financeFiltered.every(trainee => trainee.feeHistory && trainee.feeHistory[financeMonth]); const targetStatus = !allPaid; const statusText = targetStatus ? (lang === 'zh' ? "Â∑≤‰∫§ (PAID)" : "PAID") : (lang === 'zh' ? "Êú™‰∫§ (UNPAID)" : "UNPAID"); if (!confirm(t('alerts', 'finConfirmAll').replace('{status}', statusText))) return; const newTrainees = trainees.map(trainee => { if (financeFiltered.some(rt => rt.id === trainee.id)) { const history = trainee.feeHistory || {}; return { ...trainee, feeHistory: { ...history, [financeMonth]: targetStatus } }; } return trainee; }); updateData({ trainees: newTrainees }); };
            const toggleAllAttendanceStatus = () => { if (attTab === 'trainees') { const allPresent = attendanceFiltered.every(t => attendanceList.includes(t.id)); if (allPresent) { const idsToRemove = attendanceFiltered.map(t => t.id); setAttendanceList(attendanceList.filter(id => !idsToRemove.includes(id))); } else { const idsToAdd = attendanceFiltered.map(t => t.id); setAttendanceList([...new Set([...attendanceList, ...idsToAdd])]); } } else { const allPresent = attendanceFiltered.every(c => coachAttendanceList.includes(c.id)); if (allPresent) { const idsToRemove = attendanceFiltered.map(c => c.id); setCoachAttendanceList(coachAttendanceList.filter(id => !idsToRemove.includes(id))); } else { const idsToAdd = attendanceFiltered.map(c => c.id); setCoachAttendanceList([...new Set([...coachAttendanceList, ...idsToAdd])]); } } };
            const sendFeeReminder = (trainee) => { const dict = TRANSLATIONS[lang]; const template = dict.msgs[msgTemplate] || dict.msgs['gentle']; const bankInfo = dict.bankDetails.replace('{bankName}', BANK_INFO.bankName).replace('{accNum}', BANK_INFO.accNum).replace('{holder}', BANK_INFO.holder); const msgBody = template.replace('{name}', trainee.name).replace('{month}', financeMonth).replace('{amount}', monthlyFee); const fullMsg = msgBody + bankInfo; window.open(`https://wa.me/?text=${encodeURIComponent(fullMsg)}`, '_blank'); };
            const copyBankInfo = () => { const text = `${BANK_INFO.bankName}\n${BANK_INFO.accNum}\n${BANK_INFO.holder}`; const ta = document.createElement("textarea"); ta.value = text; document.body.appendChild(ta); ta.select(); document.execCommand("copy"); document.body.removeChild(ta); alert(t('finCopied')); };
            const getFinanceSummary = () => { const paidCount = financeFiltered.filter(trainee => trainee.feeHistory && trainee.feeHistory[financeMonth]).length; const totalAmount = paidCount * monthlyFee; const pendingAmount = (financeFiltered.length - paidCount) * monthlyFee; return { paidCount, totalAmount, pendingAmount }; };
            const parseImportText = () => { if (!importText) return; const text = importText.toLowerCase(); const targetList = attTab === 'trainees' ? reportFiltered : coaches; const matchedIds = targetList.filter(item => text.includes(item.name.toLowerCase())).map(item => item.id); if (matchedIds.length > 0) { if(attTab === 'trainees') setAttendanceList(matchedIds); else setCoachAttendanceList(matchedIds); alert(`‚úÖ ID: ${matchedIds.length}`); } else { alert("‚ö†Ô∏è No match"); } };

            // --- Render ---
            if (!userRole) return (
                <div className="fixed inset-0 bg-black flex flex-col items-center justify-center p-6 z-[200] fade-in">
                    <div className="w-24 h-24 mb-6 rounded-2xl overflow-hidden border-2 border-zinc-800 shadow-2xl">
                        {appLogo ? <img src={appLogo} className="w-full h-full object-cover"/> : <div className="bg-zinc-900 w-full h-full flex items-center justify-center"><i className="fa-solid fa-shield-halved text-yellow-500 text-5xl"></i></div>}
                    </div>
                    <h1 className="text-3xl font-black text-white mb-2">CFC YOUTH ACADEMY</h1>
                    <div className="w-full max-w-sm space-y-4 mt-8">
                        {!showPinInput ? (
                            <>
                                <button onClick={() => setShowPinInput(true)} className="w-full py-4 bg-zinc-800 rounded-xl font-bold flex items-center justify-center gap-3 border border-zinc-700">
                                    <i className="fa-solid fa-user-shield text-emerald-400"></i> MASTER MODE
                                </button>
                                <button onClick={() => handleLogin('user')} className="w-full py-4 bg-zinc-900 rounded-xl font-bold flex items-center justify-center gap-3 border border-zinc-800">
                                    <i className="fa-solid fa-users text-blue-400"></i> PLAYER MODE
                                </button>
                            </>
                        ) : (
                            <div className="bg-zinc-900 p-6 rounded-2xl border border-zinc-800">
                                <h3 className="text-center mb-4">Enter Admin PIN</h3>
                                <div className="grid grid-cols-3 gap-3">
                                    {[1,2,3,4,5,6,7,8,9,0].map(n => <button key={n} onClick={() => setPinInput(p => (p+n).slice(0,4))} className="py-4 bg-zinc-800 rounded-lg font-bold">{n}</button>)}
                                    <button onClick={() => setShowPinInput(false)} className="text-red-500 text-xs font-bold uppercase">Back</button>
                                    <button onClick={() => handleLogin('admin')} className="bg-emerald-600 rounded-lg flex items-center justify-center"><i className="fa-solid fa-check"></i></button>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );

            return (
                <div className="max-w-[1920px] mx-auto p-4 md:p-8 pb-20 fade-in">
                    <div className="h-1 bg-gradient-to-r from-blue-600 via-indigo-500 to-yellow-500 mb-6 rounded-full"></div>
                    <header className="relative z-20 flex flex-col xl:flex-row justify-between items-center gap-6 mb-8">
                        <div className="flex items-center gap-4 w-full">
                            <div className="w-16 h-16 rounded-xl overflow-hidden border border-zinc-700 cursor-pointer shadow-lg shrink-0" onClick={() => userRole === 'admin' && logoInputRef.current.click()}>
                                {appLogo ? <img src={appLogo} className="w-full h-full object-cover"/> : <div className="bg-zinc-900 w-full h-full flex items-center justify-center"><i className="fa-solid fa-shield-halved text-yellow-500 text-3xl"></i></div>}
                                <input type="file" ref={logoInputRef} className="hidden" accept="image/*" onChange={handleLogoFile}/>
                            </div>
                            <div className="flex-1">
                                <h1 className="text-2xl font-black">{leagueName}</h1>
                                <div className="flex items-center gap-2 mt-1">
                                    <span className={`px-2 py-0.5 rounded text-[10px] font-bold ${userRole==='admin'?'bg-emerald-900 text-emerald-400':'bg-blue-900 text-blue-400'}`}>{userRole.toUpperCase()}</span>
                                    <button onClick={() => setIsShareAppOpen(true)} className="text-zinc-500 hover:text-white"><i className="fa-solid fa-qrcode"></i></button>
                                    <button onClick={() => setUserRole(null)} className="text-zinc-500 hover:text-white"><i className="fa-solid fa-right-from-bracket"></i></button>
                                </div>
                            </div>
                        </div>
                        {userRole === 'admin' && (
                            <div className="grid grid-cols-4 sm:flex gap-2 w-full">
                                <button onClick={() => setIsFinanceOpen(true)} className="px-4 py-3 bg-yellow-600 rounded-xl font-bold text-xs"><i className="fa-solid fa-sack-dollar block text-center mb-1 text-lg"></i>Ë¥¢Âä°</button>
                                <button onClick={openAttendanceModal} className="px-4 py-3 bg-emerald-700 rounded-xl font-bold text-xs"><i className="fa-solid fa-calendar-check block text-center mb-1 text-lg"></i>ËÄÉÂã§</button>
                                <button onClick={() => { setIsCoachOpen(true); setCoachView('list'); }} className="px-4 py-3 bg-blue-800 rounded-xl font-bold text-xs"><i className="fa-solid fa-user-tie block text-center mb-1 text-lg"></i>ÊïôÁªÉ</button>
                                <button onClick={() => setIsDataToolsOpen(true)} className="px-4 py-3 bg-indigo-800 rounded-xl font-bold text-xs"><i className="fa-solid fa-cloud-arrow-up block text-center mb-1 text-lg"></i>Â§á‰ªΩ</button>
                                <button onClick={() => setIsSchoolManagerOpen(true)} className="flex-1 bg-zinc-800 rounded-xl font-bold text-xs border border-zinc-700">Â≠¶Ê†°ÁÆ°ÁêÜ</button>
                                <button onClick={handleRegister} className="flex-1 bg-white text-black rounded-xl font-bold text-xs">Ê≥®ÂÜåÁêÉÂëò</button>
                            </div>
                        )}
                    </header>

                    {/* Filter UI */}
                    <div className="relative z-10 mb-8 space-y-4">
                        <div className="relative">
                            <i className="fa-solid fa-magnifying-glass absolute left-4 top-1/2 -translate-y-1/2 text-zinc-500"></i>
                            <input className="w-full bg-zinc-900 border border-zinc-800 rounded-2xl py-4 pl-12 pr-4 outline-none focus:border-indigo-500 text-lg shadow-xl" placeholder="ÊêúÁ¥¢ÁêÉÂëò..." value={searchTerm} onChange={e => setSearchTerm(e.target.value)} />
                        </div>
                        <div className="flex gap-2 overflow-x-auto no-scrollbar">
                            {['ÂÖ®ÈÉ®', ...teams].map(team => <button key={team} onClick={() => setSelectedTeam(team)} className={`px-4 py-2 rounded-xl border font-bold whitespace-nowrap transition-all ${selectedTeam === team ? 'bg-yellow-500 text-black border-yellow-500' : 'bg-zinc-900 text-zinc-500 border-zinc-800'}`}>{team.split(' ')[0]}</button>)}
                        </div>
                    </div>

                    {/* Trainee Grid */}
                    <div className="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 2xl:grid-cols-6 gap-3 z-0">
                        {filteredTrainees.map(t => (
                            <div key={t.id} className="bg-zinc-900 rounded-2xl border border-zinc-800 overflow-hidden flex flex-col group hover:border-zinc-500 transition-all shadow-xl z-0 hover:z-10">
                                <div className="h-28 relative">
                                    <img src={getOptimizedImageUrl(t.image)} className="w-full h-full object-cover transition-transform group-hover:scale-110 duration-500" />
                                    <div className="absolute inset-0 bg-gradient-to-t from-zinc-900 via-transparent to-transparent"></div>
                                    <span className="absolute top-2 left-2 bg-yellow-500 text-black text-[10px] font-black px-1.5 rounded">{getPositionCode(t.primaryPosition)}</span>
                                    <div className="absolute bottom-2 left-3 right-3 truncate">
                                        <h3 className="font-bold text-sm text-white drop-shadow-md">{t.name}</h3>
                                        <p className="text-[10px] text-zinc-300 opacity-80">{t.team.split(' ')[0]}</p>
                                    </div>
                                </div>
                                <div className="p-2 flex-1 flex flex-col">
                                    <div className="grid grid-cols-3 gap-1 mb-2">
                                        {['pace', 'shooting', 'passing'].map(s => (
                                            <div key={s} className="bg-black/50 p-1 rounded flex flex-col items-center">
                                                <span className="text-zinc-600 text-[8px] uppercase">{s.slice(0,3)}</span>
                                                <span className={`text-xs font-black ${getGradeColor(getStatGrade(t.stats?.[s]))}`}>{getStatGrade(t.stats?.[s])}</span>
                                            </div>
                                        ))}
                                    </div>
                                    <div className="mt-auto pt-2 border-t border-zinc-800/50 flex justify-between">
                                        <div className={`w-2 h-2 rounded-full mt-1.5 ${getAttendanceColor(t.attendance)}`}></div>
                                        {userRole === 'admin' && (
                                            <div className="flex gap-1">
                                                <button onClick={() => handleEdit(t)} className="w-6 h-6 rounded bg-zinc-800 text-zinc-400 hover:text-white flex items-center justify-center"><i className="fa-solid fa-pen text-[10px]"></i></button>
                                                <button onClick={() => deleteTrainee(t.id)} className="w-6 h-6 rounded bg-red-900/20 text-red-500 flex items-center justify-center"><i className="fa-solid fa-trash text-[10px]"></i></button>
                                                <button onClick={() => mockAI('ÁêÉÊé¢', t)} className="w-6 h-6 rounded bg-blue-900/20 text-blue-400 flex items-center justify-center"><i className="fa-solid fa-robot text-[10px]"></i></button>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>
                        ))}
                    </div>

                    {/* --- Share Modal --- */}
                    {isShareAppOpen && (
                        <div className="fixed inset-0 z-[300] bg-black/90 backdrop-blur-sm flex items-center justify-center p-6 fade-in" onClick={() => setIsShareAppOpen(false)}>
                            <div className="bg-zinc-900 border border-zinc-800 w-full max-w-sm rounded-3xl p-8 text-center" onClick={e => e.stopPropagation()}>
                                <div className="w-20 h-20 bg-zinc-800 rounded-3xl mx-auto mb-6 flex items-center justify-center border-2 border-zinc-700 shadow-xl overflow-hidden">
                                    {appLogo ? <img src={appLogo} className="w-full h-full object-cover"/> : <i className="fa-solid fa-shield-halved text-yellow-500 text-4xl"></i>}
                                </div>
                                <h2 className="text-2xl font-black text-white mb-2">ÂÆâË£Ö CFC App</h2>
                                <p className="text-zinc-500 text-sm mb-8 leading-relaxed">ËØ∑‰ΩøÁî®ÊµèËßàÂô®‚ÄúÊ∑ªÂä†Âà∞‰∏ªÂ±èÂπï‚ÄùÂäüËÉΩÂÆâË£Ö„ÄÇ</p>
                                <div className="bg-white p-3 rounded-2xl mb-8 w-fit mx-auto shadow-2xl">
                                    <img src={`https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=${encodeURIComponent(shareUrl)}&margin=10`} className="w-48 h-48 rounded-lg"/>
                                </div>
                                <button onClick={() => { navigator.clipboard.writeText(shareUrl); alert("ÈìæÊé•Â∑≤Â§çÂà∂ÔºÅ"); }} className="w-full py-4 bg-zinc-800 text-white rounded-2xl font-bold hover:bg-zinc-700 transition-colors flex items-center justify-center gap-2">
                                    <i className="fa-solid fa-link"></i> Â§çÂà∂ÈìæÊé•
                                </button>
                            </div>
                        </div>
                    )}

                    {/* --- Coach Modal --- */}
                    {isCoachOpen && (
                        <div className="fixed inset-0 z-[200] bg-black/90 backdrop-blur-sm flex items-center justify-center p-4 fade-in" onClick={() => setIsCoachOpen(false)}>
                            <div className="bg-zinc-900 border border-zinc-800 w-full max-w-lg h-[80vh] rounded-3xl p-6 flex flex-col" onClick={e => e.stopPropagation()}>
                                <div className="flex justify-between items-center mb-6">
                                    <h2 className="text-xl font-bold flex items-center gap-2"><i className="fa-solid fa-user-tie text-blue-500"></i> ÊïôÁªÉ‰∏≠ÂøÉ</h2>
                                    <button onClick={() => setIsCoachOpen(false)}><i className="fa-solid fa-xmark text-xl text-zinc-500"></i></button>
                                </div>
                                <div className="flex bg-zinc-950 p-1 rounded-xl mb-6 border border-zinc-800">
                                    {['list', 'attendance', 'finance'].map(v => <button key={v} onClick={() => setCoachView(v)} className={`flex-1 py-2 text-xs font-bold rounded-lg ${coachView === v ? 'bg-blue-900 text-white shadow-lg' : 'text-zinc-500'}`}>{v.toUpperCase()}</button>)}
                                </div>
                                <div className="flex-1 overflow-y-auto pr-1">
                                    {coachView === 'finance' && (
                                        <div className="space-y-4">
                                            <div className="bg-zinc-950 p-4 rounded-2xl border border-zinc-800 flex justify-between items-center mb-4">
                                                <input type="month" className="bg-zinc-900 text-white px-2 py-1 rounded border border-zinc-700 text-sm" value={financeMonth} onChange={e => setFinanceMonth(e.target.value)}/>
                                                <div className="text-right"><p className="text-[10px] text-zinc-500 uppercase tracking-wider">MONTH TOTAL</p><p className="text-xl font-black text-emerald-400">RM {getPayroll().totalPayout}</p></div>
                                            </div>
                                            {getPayroll().list.map(c => (
                                                <div key={c.id} className="bg-zinc-800 p-4 rounded-2xl border border-zinc-700 flex flex-col gap-3">
                                                    <div className="flex justify-between items-center">
                                                        <div className="flex-1">
                                                            <div className="flex items-center gap-2"><p className="font-bold">{c.name}</p><button onClick={() => setExpandedCoachId(expandedCoachId === c.id ? null : c.id)} className="text-[10px] text-zinc-400 bg-zinc-900 px-2 py-0.5 rounded border border-zinc-700">ÊòéÁªÜ</button></div>
                                                            <p className="text-xs text-zinc-500 mt-1">{c.sessions} sessions x RM{c.rate}</p>
                                                        </div>
                                                        <div className="text-right">
                                                            <p className="text-lg font-black">RM {c.amount}</p>
                                                            <button onClick={() => toggleCoachPayment(c.id)} className={`text-[10px] font-bold px-2 py-0.5 rounded mt-1 ${c.isPaid?'bg-emerald-600 text-white':'border border-zinc-600 text-zinc-500'}`}>{c.isPaid ? 'PAID' : 'PENDING'}</button>
                                                        </div>
                                                    </div>
                                                    {expandedCoachId === c.id && (
                                                        <div className="bg-black/50 p-3 rounded-xl space-y-2 fade-in max-h-40 overflow-y-auto">
                                                            {c.details && c.details.length > 0 ? c.details.map((d, i) => (
                                                                <div key={i} className="flex justify-between items-center text-[11px] border-b border-zinc-800 pb-2 last:border-0 last:pb-0">
                                                                    <div><span className="text-zinc-200 font-bold">{d.date}</span><span className="text-blue-400 ml-2">{d.school}</span></div>
                                                                    <button onClick={() => removeCoachRecord(c.id, d.date, d.school)} className="w-7 h-7 bg-red-900/20 text-red-500 rounded flex items-center justify-center transition-colors"><i className="fa-solid fa-trash-can text-[10px]"></i></button>
                                                                </div>
                                                            )) : <p className="text-center text-zinc-600 text-[10px] italic">No records.</p>}
                                                        </div>
                                                    )}
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                    {coachView === 'attendance' && (
                                        <div className="space-y-4">
                                            <div className="bg-zinc-950 p-3 rounded-xl border border-zinc-800 mb-4 flex gap-2">
                                                <input type="date" className="flex-1 bg-zinc-900 text-white px-3 py-2 rounded-lg border border-zinc-700 outline-none focus:border-blue-500" value={coachAttDate} onChange={e => setCoachAttDate(e.target.value)}/>
                                                <select className="flex-1 bg-zinc-900 text-white px-3 py-2 rounded-lg border border-zinc-700 outline-none text-xs" value={coachAttSchool} onChange={e => setCoachAttSchool(e.target.value)}>{teams.map(t => <option key={t} value={t}>{t}</option>)}</select>
                                            </div>
                                            {coaches.map(c => {
                                                const isPresent = (c.attendanceHistory || []).some(h => h.date === coachAttDate && h.school === coachAttSchool);
                                                return <div key={c.id} onClick={() => toggleCoachAttendance(c.id)} className={`flex items-center justify-between p-4 rounded-xl border cursor-pointer transition-all ${isPresent ? 'bg-emerald-900/30 border-emerald-500' : 'bg-zinc-800 border-zinc-700'}`}><div className="flex items-center gap-3"><div className={`w-6 h-6 rounded flex items-center justify-center border ${isPresent ? 'bg-emerald-500 border-emerald-500 text-black' : 'border-zinc-500'}`}>{isPresent && <i className="fa-solid fa-check text-sm"></i>}</div><p className="font-bold">{c.name}</p></div></div>;
                                            })}
                                        </div>
                                    )}
                                    {coachView === 'list' && (
                                        <div className="space-y-3">
                                            <div className="bg-zinc-950 p-4 rounded-xl border border-zinc-800 mb-4"><div className="grid grid-cols-2 gap-2 mb-2"><input className="bg-zinc-900 border border-zinc-700 rounded px-2 py-1.5 text-sm text-white" placeholder="Name" value={coachForm.name} onChange={e => setCoachForm({...coachForm, name: e.target.value})} /><input className="bg-zinc-900 border border-zinc-700 rounded px-2 py-1.5 text-sm text-white" placeholder="Phone" value={coachForm.phone} onChange={e => setCoachForm({...coachForm, phone: e.target.value})} /></div><div className="grid grid-cols-2 gap-2 mb-3"><select className="bg-zinc-900 border border-zinc-700 rounded px-2 py-1.5 text-sm text-white" value={coachForm.role} onChange={e => setCoachForm({...coachForm, role: e.target.value})}><option value="Head Coach">Head Coach</option><option value="Assistant">Assistant</option><option value="GK Coach">GK Coach</option><option value="Fitness">Fitness</option></select><div className="flex items-center gap-2 bg-zinc-900 border border-zinc-700 rounded px-2"><span className="text-xs text-zinc-500">RM</span><input type="number" className="bg-transparent w-full py-1.5 text-sm text-white outline-none" placeholder="Rate" value={coachForm.rate} onChange={e => setCoachForm({...coachForm, rate: parseInt(e.target.value) || 0})} /></div></div><button onClick={saveCoach} className="w-full py-2 bg-blue-600 hover:bg-blue-500 text-white text-sm font-bold rounded-lg transition-colors">{editingCoach ? t('save') : t('addCoach')}</button></div>
                                            {coaches.map(c => <div key={c.id} className="bg-zinc-800 p-4 rounded-2xl border border-zinc-700 flex justify-between items-center"><div><p className="font-bold">{c.name}</p><p className="text-xs text-zinc-500">{c.role} ‚Ä¢ RM{c.rate}</p></div><div className="flex gap-2"><button onClick={() => sendCoachMessage(c)} className="w-8 h-8 bg-[#25D366]/20 text-[#25D366] rounded-full flex items-center justify-center"><i className="fa-brands fa-whatsapp"></i></button><button onClick={() => deleteCoach(c.id)} className="text-zinc-600 hover:text-red-500 transition-colors"><i className="fa-solid fa-trash"></i></button></div></div>)}
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {/* AI Result */}
                    {aiResult.content && (
                        <div className="fixed inset-0 z-[250] bg-black/90 flex items-center justify-center p-6 fade-in" onClick={() => setAiResult({content:null, name:null})}>
                            <div className="bg-zinc-900 border border-zinc-700 w-full max-w-md rounded-3xl p-6" onClick={e => e.stopPropagation()}>
                                <div className="flex justify-between mb-4"><h3 className="font-bold text-lg">AI Report: {aiResult.name}</h3><button onClick={() => setAiResult({content:null, name:null})}><i className="fa-solid fa-xmark"></i></button></div>
                                <div className="text-zinc-300 text-sm whitespace-pre-wrap leading-relaxed">{aiResult.content}</div>
                            </div>
                        </div>
                    )}

                    {/* Trainee Edit Modal */}
                    {isModalOpen && (
                        <div className="fixed inset-0 z-[150] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 fade-in" onClick={() => setIsModalOpen(false)}>
                            <div className="bg-zinc-900 border border-zinc-800 w-full max-w-lg rounded-3xl p-6 overflow-y-auto max-h-[90vh]" onClick={e => e.stopPropagation()}>
                                <div className="flex justify-between items-center mb-6"><h2 className="text-xl font-bold text-white">ÁêÉÂëòÊ°£Ê°à</h2><button onClick={() => setIsModalOpen(false)}><i className="fa-solid fa-xmark text-xl text-zinc-500"></i></button></div>
                                <div className="space-y-4">
                                    <div className="flex items-center gap-4">
                                        <div className="w-20 h-20 bg-zinc-800 rounded-xl overflow-hidden border border-zinc-700 cursor-pointer relative flex items-center justify-center" onClick={() => fileInputRef.current.click()}>
                                            {formData.image ? <img src={formData.image} className="w-full h-full object-cover"/> : <i className="fa-solid fa-camera text-zinc-600 text-2xl"></i>}
                                            <input type="file" ref={fileInputRef} className="hidden" accept="image/*" onChange={handleTraineeFile}/>
                                        </div>
                                        <div className="flex-1 space-y-2">
                                            <input className="w-full bg-zinc-950 border border-zinc-800 rounded-xl px-4 py-2" placeholder="ÂßìÂêç" value={formData.name} onChange={e => setFormData({...formData, name: e.target.value})}/>
                                            <select className="w-full bg-zinc-950 border border-zinc-800 rounded-xl px-4 py-2 text-sm" value={formData.team} onChange={e => setFormData({...formData, team: e.target.value})}>{teams.map(t => <option key={t} value={t}>{t}</option>)}</select>
                                        </div>
                                    </div>
                                    <div className="grid grid-cols-2 gap-4">
                                        {Object.keys(formData.stats || {}).map(s => (
                                            <div key={s} className="bg-zinc-800 p-2 rounded-xl">
                                                <div className="flex justify-between text-[10px] mb-1 uppercase text-zinc-400"><span>{s}</span><span>{formData.stats[s]}</span></div>
                                                <input type="range" className="w-full accent-indigo-500" value={formData.stats[s]} min="0" max="99" onChange={e => setFormData({...formData, stats: {...formData.stats, [s]: parseInt(e.target.value)}})}/>
                                            </div>
                                        ))}
                                    </div>
                                    <button onClick={handleSaveTrainee} className="w-full py-4 bg-white text-black rounded-xl font-bold mt-4 shadow-xl active:scale-95 transition-transform">‰øùÂ≠òÊõ¥Êîπ</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {isCropperOpen && (
                        <div className="fixed inset-0 z-[400] bg-black flex flex-col items-center justify-center p-4">
                            <h3 className="text-white font-bold mb-4">Ë£ÅÂâ™ÁÖßÁâá</h3>
                            <div className="max-w-full max-h-[60vh] bg-zinc-900 rounded-xl overflow-hidden mb-6 shadow-2xl">
                                <img ref={cropperImageRef} src={tempImage} style={{maxWidth: '100%'}} />
                            </div>
                            <div className="flex gap-4 w-full max-w-xs">
                                <button onClick={handleRotate} className="flex-1 py-3 bg-zinc-800 rounded-xl"><i className="fa-solid fa-rotate-right"></i></button>
                                <button onClick={handleCropConfirm} className="flex-[2] py-3 bg-emerald-600 rounded-xl font-bold active:scale-95">Á°ÆËÆ§Ë£ÅÂâ™</button>
                                <button onClick={() => setIsCropperOpen(false)} className="flex-1 py-3 bg-red-600 rounded-xl"><i className="fa-solid fa-xmark"></i></button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
