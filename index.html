<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>CFC YOUTH ACADEMY</title>
    <meta name="theme-color" content="#09090b">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link id="dynamic-favicon" rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/3309/3309991.png">
    <link id="dynamic-apple-icon" rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3309/3309991.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <style>
        body { background-color: #09090b; color: #fff; font-family: sans-serif; -webkit-tap-highlight-color: transparent; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .cropper-container { max-height: 60vh; background-color: #000; }
        #static-loading { position: fixed; inset: 0; display: flex; flex-direction: column; justify-content: center; align-items: center; background: #09090b; z-index: 5000; transition: opacity 0.5s; }
        .hidden { opacity: 0; pointer-events: none; }
        header { padding-top: env(safe-area-inset-top); }
        input[type="range"] { accent-color: white; }
    </style>
</head>
<body>
    <div id="static-loading">
        <i class="fa-solid fa-shield-halved text-yellow-500 text-5xl fa-beat mb-4"></i>
        <h2 class="text-xl font-bold mt-4 tracking-wider uppercase text-white">CFC YOUTH ACADEMY</h2>
        <p id="loading-text" class="text-zinc-500 text-xs mt-2 font-mono tracking-widest uppercase">System Ready...</p>
    </div>
    <div id="error-box" style="display:none; position:fixed; top:0; left:0; width:100%; background:#ef4444; color:#fff; padding:10px; z-index:9000; font-size:12px; text-align:center;"></div>
    <div id="root"></div>

    <script type="text/babel">
        // --- Constants ---
        const MY_MASTER_KEY = "$2a$10$JuGSKsBRirNG95vYP0fbSuotikgzUSy8nphUaCtjGq0qsdCalvBo2"; 
        const JSONBIN_URL = "https://api.jsonbin.io/v3/b";
        const MY_CLOUD_NAME = "dtlsbbj1v"; 
        const ADMIN_PIN = "1413"; 
        const PRESET_YEARLY_TOTAL = 52;
        const DEFAULT_IMAGE = 'https://images.unsplash.com/photo-1552667466-07770ae110d0?w=400&h=400&fit=crop';
        const BANK_INFO = { bankName: "OCBC BANK", accNum: "7091258844", holder: "CFC YOUTH ACADEMY SB" };

        const INITIAL_TEAMS = ['çš‡å®¶ä¹¦é™¢', 'æ˜Ÿè€€ä¸­å­¦', 'é›·éœ†ä½“æ ¡', 'è“é¹°å›½é™…', 'åŒ—å¢ƒä¸€ä¸­', 'å—æ´‹å…¬å­¦', 'å…‰è¾‰ä¸­å­¦', 'é£Žæš´ç«žæŠ€', 'é“¶æ²³å®žéªŒ', 'æ³°å¦ä¸­å­¦'];
        const CATEGORIES = ['U8', 'U10', 'U12', 'U15', 'U18'];
        const POSITIONS = ['å‰é”‹ (FW)', 'å·¦è¾¹é”‹ (LW)', 'å³è¾¹é”‹ (RW)', 'å‰è…° (CAM)', 'ä¸­åœº (CM)', 'åŽè…° (CDM)', 'åŽå« (DF)', 'é—¨å°† (GK)'];

        const INITIAL_TRAINEES = [{ id: '1', name: 'Arthur', primaryPosition: 'å‰è…° (CAM)', team: 'çš‡å®¶ä¹¦é™¢', stats: { pace: 75, shooting: 82, passing: 95, dribbling: 85, defending: 60, physical: 70 }, image: DEFAULT_IMAGE, attendance: 0, attendanceHistory: [], feeHistory: {} }];
        const INITIAL_COACHES = [{ id: 'c1', name: 'Coach Mourinho', role: 'Head Coach', rate: 200, phone: '60123456789', attendanceHistory: [], paymentHistory: {} }];
        const DEFAULT_FORM_DATA = { name:'', team:'', primaryPosition:'å‰è…° (CAM)', stats:{pace:50,shooting:50,passing:50,dribbling:50,defending:50,physical:50}, image: DEFAULT_IMAGE };

        const TRANSLATIONS = {
            zh: { appTitle: "CFC YOUTH ACADEMY", auth: { adminMode: "ç®¡ç†å‘˜æ¨¡å¼", userMode: "çƒå‘˜æ¨¡å¼", enterPin: "è¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç ", wrong: "å¯†ç é”™è¯¯" }, nav: { finance: "è´¢åŠ¡", att: "è€ƒå‹¤", coach: "æ•™ç»ƒ", school: "å­¦æ ¡", reg: "æ³¨å†Œ", data: "å¤‡ä»½" }, common: { save: "ä¿å­˜", cancel: "å–æ¶ˆ", name: "å§“å", school: "å­¦æ ¡", comment: "æ•™ç»ƒè¯„è¯­", generate: "AI ç”Ÿæˆ" }, stats: { pace: "é€Ÿåº¦", shooting: "å°„é—¨", passing: "ä¼ çƒ", dribbling: "ç›˜å¸¦", defending: "é˜²å®ˆ", physical: "ä½“èƒ½" }, alerts: { del: "ç¡®å®šåˆ é™¤ï¼Ÿ", saved: "å·²ä¿å­˜ï¼", copied: "å·²å¤åˆ¶ï¼" }, share: { copy: "å¤åˆ¶é“¾æŽ¥" }, coach: { title: "æ•™ç»ƒä¸­å¿ƒ", list: "åå•", att: "è€ƒå‹¤", fin: "è–ªèµ„", total: "æ€»æ”¯å‡º", details: "æ˜Žç»†", sessions: "åœºæ¬¡", reg: "æ³¨å†Œæ•™ç»ƒ" }, fin: { title: "è´¢åŠ¡ä¸­å¿ƒ", total: "æ€»æ”¶å…¥", pending: "å¾…æ”¶", fee: "æœˆè´¹", search: "æœç´¢...", toggle: "ä¸€é”®å…¨é€‰", export: "å¯¼å‡ºæŠ¥è¡¨", copy: "å¤åˆ¶è´¦å·", remind: "å‚¬è´¹" }, att: { title: "è€ƒå‹¤æ‰“å¡", tabT: "å­¦å‘˜", tabC: "æ•™ç»ƒ", paste: "ç²˜è´´å¯¼å…¥", pasteDesc: "è‡ªåŠ¨è¯†åˆ«", search: "æœç´¢...", toggle: "ä¸€é”®å…¨é€‰", save: "ä¿å­˜", confirm: "ç¡®è®¤æäº¤ï¼Ÿ", excel: "å¯¼å‡ºè¡¨æ ¼" }, cloud: { setup: "äº‘ç«¯è®¾ç½®", desc: "è¿žæŽ¥ JSONBin", key: "Master Key", bin: "Bin ID", connect: "è¿žæŽ¥", create: "åˆ›å»º", imageCloud: "å›¾ç‰‡äº‘", name: "Cloud Name", preset: "Preset", saveImg: "ä¿å­˜é…ç½®" }, msgTemplates: { gentle: "æ¸©æŸ”æé†’", friendly: "æœ‹å‹è¯­æ°”", soft: "å©‰è½¬æé†’", formal: "æ­£å¼é€šçŸ¥" }, msgs: { gentle: "Hi å®¶é•¿å¥½ï¼Œæ¸©é¦¨æé†’å­¦è´¹å°šæœªç¼´äº¤ã€‚" } },
            en: { appTitle: "CFC YOUTH ACADEMY", auth: { adminMode: "MASTER MODE", userMode: "PLAYER MODE", enterPin: "Enter PIN", wrong: "Wrong PIN" }, nav: { finance: "Finance", att: "Attnd", coach: "Coach", school: "Schools", reg: "Register", data: "Backup" }, common: { save: "Save", cancel: "Cancel", name: "Name", school: "School", comment: "Comment", generate: "Generate AI" }, stats: { pace: "PAC", shooting: "SHO", passing: "PAS", dribbling: "DRI", defending: "DEF", physical: "PHY" }, alerts: { del: "Delete?", saved: "Saved!", copied: "Copied!" }, share: { copy: "Copy Link" }, coach: { title: "Coach Hub", list: "List", att: "Attnd", fin: "Payroll", total: "Total Payout", details: "Details", sessions: "Sessions", reg: "Register" }, fin: { title: "Finance Hub", total: "Revenue", pending: "Pending", fee: "Fee", search: "Search...", toggle: "Toggle All", export: "Export", copy: "Copy Info", remind: "Remind" }, att: { title: "Attendance", tabT: "Trainees", tabC: "Coaches", paste: "Paste List", pasteDesc: "Auto-Match", search: "Search...", toggle: "Toggle All", save: "Save", confirm: "Confirm?", excel: "Export" }, cloud: { setup: "Cloud Setup", desc: "Connect JSONBin", key: "Master Key", bin: "Bin ID", connect: "Connect", create: "Create", imageCloud: "Image Cloud", name: "Cloud Name", preset: "Preset", saveImg: "Save Config" }, msgTemplates: { gentle: "Gentle", friendly: "Friendly", soft: "Soft", formal: "Formal" }, msgs: { gentle: "Hi Parents, gentle reminder on fee." } },
            ms: { appTitle: "AKADEMI BELIA CFC", auth: { adminMode: "MOD UTAMA", userMode: "MOD PEMAIN", enterPin: "Masukkan PIN", wrong: "Salah PIN" }, nav: { finance: "Kewangan", att: "Kehadiran", coach: "Jurulatih", school: "Sekolah", reg: "Daftar", data: "Sandaran" }, common: { save: "Simpan", cancel: "Batal", name: "Nama", school: "Sekolah", comment: "Komen", generate: "Jana AI" }, stats: { pace: "Laju", shooting: "Tembak", passing: "Hantar", dribbling: "Gelecek", defending: "Pertahan", physical: "Fizikal" }, alerts: { del: "Padam?", saved: "Disimpan!", copied: "Disalin!" }, share: { copy: "Salin Pautan" }, coach: { title: "Pusat Jurulatih", list: "Senarai", att: "Kehadiran", fin: "Gaji", total: "Jumlah", details: "Butiran", sessions: "Sesi", reg: "Daftar" }, fin: { title: "Kewangan", total: "Hasil", pending: "Tunggakan", fee: "Yuran", search: "Cari...", toggle: "Pilih Semua", export: "Eksport", copy: "Salin Info", remind: "Ingatkan" }, att: { title: "Kehadiran", tabT: "Pelatih", tabC: "Jurulatih", paste: "Tampal", pasteDesc: "Auto-Tanda", search: "Cari...", toggle: "Pilih Semua", save: "Simpan", confirm: "Sahkan?", excel: "Eksport" }, cloud: { setup: "Tetapan Awan", desc: "Sambung JSONBin", key: "Kunci", bin: "ID Bin", connect: "Sambung", create: "Cipta", imageCloud: "Awan Gambar", name: "Nama Cloud", preset: "Preset", saveImg: "Simpan" }, msgTemplates: { gentle: "Lembut", friendly: "Mesra", soft: "Santai", formal: "Rasmi" }, msgs: { gentle: "Salam, peringatan mesra yuran." } }
        };

        // --- Helpers ---
        const getStatGrade=(v)=>{const n=parseInt(v)||0;return n>=85?'A':n>=70?'B':n>=55?'C':'D'};
        const getGradeColor=(g)=>{switch(g){case'A':return'text-emerald-400 font-black';case'B':return'text-blue-400 font-bold';case'C':return'text-yellow-400 font-bold';default:return'text-zinc-500'}};
        const getAttendanceColor=(v)=>v>=90?'bg-emerald-500 shadow-lg shadow-emerald-500/20':(v>=70?'bg-yellow-500 shadow-lg shadow-yellow-500/20':'bg-red-500 shadow-lg shadow-red-500/20');
        const getPositionCode=(s)=>(s&&s!=='æ— ')?s.match(/\((.*?)\)/)?.[1]||s.substring(0,2):'';
        const getOptimizedImageUrl=(u)=>(!u||!u.includes('cloudinary.com'))?(u||DEFAULT_IMAGE):u.replace(/([^:]\/)\/+/g,"$1").replace('/upload/','/upload/f_avif,q_auto/');
        const safeCopy=(t,m)=>{const a=document.createElement("textarea");a.value=t;a.style.position="fixed";a.style.left="-9999px";document.body.appendChild(a);a.select();try{document.execCommand('copy');if(m)alert(m)}catch(e){console.error(e)}document.body.removeChild(a)};

        const { useState, useEffect, useRef, useMemo } = React;

        const App = () => {
            const [userRole, setUserRole] = useState(null); 
            const [lang, setLang] = useState('zh');
            const [pinInput, setPinInput] = useState("");
            const [showPinInput, setShowPinInput] = useState(false);
            const [teams, setTeams] = useState(INITIAL_TEAMS);
            const [trainees, setTrainees] = useState([]);
            const [coaches, setCoaches] = useState([]);
            const [leagueName, setLeagueName] = useState('CFC YOUTH ACADEMY');
            const [appLogo, setAppLogo] = useState(null);
            const [cloudConfig, setCloudConfig] = useState({ key: MY_MASTER_KEY, binId: '' });
            const [isCloudConnected, setIsCloudConnected] = useState(false);
            const [cloudStatus, setCloudStatus] = useState("");
            const [imgConfig, setImgConfig] = useState({ cloudName: MY_CLOUD_NAME, uploadPreset: '' });
            const [isImgCloudReady, setIsImgCloudReady] = useState(false);
            const [modals, setModals] = useState({ trainee:0, attendance:0, finance:0, coach:0, cloud:0, school:0, cropper:0, share:0, data:0 });
            const toggleM = (k, v) => setModals(p => ({ ...p, [k]: v }));
            const [coachView, setCoachView] = useState('list');
            const [coachForm, setCoachForm] = useState({ name: '', phone: '', role: 'Assistant', rate: 100 });
            const [expandedCoachId, setExpandedCoachId] = useState(null);
            const [editingCoach, setEditingCoach] = useState(null);
            const [searchTerm, setSearchTerm] = useState('');
            const [selectedTeam, setSelectedTeam] = useState('å…¨éƒ¨');
            const [formData, setFormData] = useState(DEFAULT_FORM_DATA);
            const [editingTrainee, setEditingTrainee] = useState(null);
            const [renamingTeam, setRenamingTeam] = useState({ original: '', current: '' });
            const [attendanceDate, setAttendanceDate] = useState(new Date().toISOString().slice(0, 10));
            const [attendanceList, setAttendanceList] = useState([]);
            const [coachAttendanceList, setCoachAttendanceList] = useState([]);
            const [attTab, setAttTab] = useState('trainees');
            const [importText, setImportText] = useState("");
            const [attendanceSearchTerm, setAttendanceSearchTerm] = useState('');
            const [coachAttDate, setCoachAttDate] = useState(new Date().toISOString().slice(0, 10)); 
            const [coachAttSchool, setCoachAttSchool] = useState(INITIAL_TEAMS[0]);
            const [financeMonth, setFinanceMonth] = useState(new Date().toISOString().slice(0, 7));
            const [financeSearchTerm, setFinanceSearchTerm] = useState('');
            const [monthlyFee, setMonthlyFee] = useState(150);
            const [msgTemplate, setMsgTemplate] = useState('gentle'); 
            const [shareTarget, setShareTarget] = useState(null);
            const [tempImage, setTempImage] = useState(null);
            const [isLogoCrop, setIsLogoCrop] = useState(false);
            const [shareUrl] = useState(window.location.href);
            const [aiResult, setAiResult] = useState({content: null, name: null});
            const [aiLoading, setAiLoading] = useState(false);

            const cropperRef = useRef(null); const cropperImageRef = useRef(null); const fileInputRef = useRef(null); const logoInputRef = useRef(null); const backupInputRef = useRef(null);

            const t = (k, sk) => { const dict = TRANSLATIONS[lang] || TRANSLATIONS['zh']; if(sk) return dict[k]?.[sk] || (TRANSLATIONS['zh'][k]?.[sk] || k); return dict[k] || (TRANSLATIONS['zh'][k] || k); };

            const filteredTrainees = useMemo(() => trainees.filter(t => (selectedTeam === 'å…¨éƒ¨' || selectedTeam === 'All' || selectedTeam === 'Semua' || t.team === selectedTeam) && t.name.toLowerCase().includes(searchTerm.toLowerCase())), [trainees, selectedTeam, searchTerm]);
            const financeFiltered = useMemo(() => filteredTrainees.filter(t => (t.name || '').toLowerCase().includes(financeSearchTerm.toLowerCase())), [filteredTrainees, financeSearchTerm]);
            const attendanceFiltered = useMemo(() => { const term = attendanceSearchTerm.toLowerCase(); return (attTab === 'trainees' ? filteredTrainees : coaches).filter(i => i.name.toLowerCase().includes(term)); }, [attTab, filteredTrainees, coaches, attendanceSearchTerm]);
            
            const financeSummary = useMemo(() => { 
                const paidCount = financeFiltered.filter(t => t.feeHistory?.[financeMonth]).length; 
                return { total: financeFiltered.length * monthlyFee, paid: paidCount * monthlyFee, pending: (financeFiltered.length - paidCount) * monthlyFee, paidCount }; 
            }, [financeFiltered, financeMonth, monthlyFee]);

            const payrollData = useMemo(() => {
                let total = 0;
                const list = coaches.map(c => {
                    const monthSessions = (c.attendanceHistory || []).filter(h => { const d = (typeof h === 'string') ? h : h.date; return d && d.startsWith(financeMonth); });
                    const amount = monthSessions.length * (c.rate || 0);
                    const isPaid = c.paymentHistory?.[financeMonth]?.status === 'paid';
                    if (isPaid) total += amount;
                    const sorted = monthSessions.map(h => ({ date: (typeof h === 'string') ? h : h.date, school: (typeof h === 'string') ? '' : (h.school || '') })).sort((a,b) => b.date.localeCompare(a.date));
                    return { ...c, sessions: monthSessions.length, amount, isPaid, details: sorted };
                });
                return { list, total };
            }, [coaches, financeMonth]);

            const updateData = (newData) => {
                const u = { trainees: newData.trainees!==undefined?newData.trainees:trainees, coaches: newData.coaches!==undefined?newData.coaches:coaches, leagueName: newData.leagueName!==undefined?newData.leagueName:leagueName, appLogo: newData.appLogo!==undefined?newData.appLogo:appLogo, teams: newData.teams!==undefined?newData.teams:teams };
                if(newData.trainees) setTrainees(newData.trainees); if(newData.coaches) setCoaches(newData.coaches); if(newData.appLogo!==undefined) setAppLogo(newData.appLogo); if(newData.leagueName) setLeagueName(newData.leagueName); if(newData.teams) setTeams(newData.teams);
                localStorage.setItem('cfc_local_db', JSON.stringify(u));
                if (isCloudConnected) syncToCloud(u);
            };

            const syncFromCloud = async (key, binId) => {
                setCloudStatus("â³");
                try { const res = await fetch(`${JSONBIN_URL}/${binId}/latest`, { headers: { 'X-Master-Key': key } }); if (res.ok) { const json = await res.json(); updateData(json.record); setIsCloudConnected(true); setCloudStatus("âœ…"); } } catch (e) { setCloudStatus("âŒ"); }
            };
            const syncToCloud = async (data) => {
                if (!isCloudConnected || !cloudConfig.binId) return;
                try { const clean = { ...data, trainees: data.trainees.map(t => t.image.startsWith('data:') ? { ...t, image: DEFAULT_IMAGE } : t) }; await fetch(`${JSONBIN_URL}/${cloudConfig.binId}`, { method: 'PUT', headers: { 'Content-Type': 'application/json', 'X-Master-Key': cloudConfig.key }, body: JSON.stringify(clean) }); } catch (e) {}
            };
            const uploadToCloudinary = async (b64) => {
                if (!imgConfig.cloudName || !imgConfig.uploadPreset) return null;
                const fd = new FormData(); fd.append('file', b64); fd.append('upload_preset', imgConfig.uploadPreset);
                try { const res = await fetch(`https://api.cloudinary.com/v1_1/${imgConfig.cloudName}/image/upload`, { method: 'POST', body: fd }); const d = await res.json(); return d.secure_url; } catch (error) { return null; }
            };

            const handleLogin = (role) => { if (role === 'admin') { if (pinInput === ADMIN_PIN) { setUserRole('admin'); setPinInput(""); setShowPinInput(false); } else { alert(t('auth', 'wrong')); setPinInput(""); } } else setUserRole('user'); };
            const handleRegister = () => { setEditingTrainee(null); setFormData(DEFAULT_FORM_DATA); toggleM('trainee', 1); };
            const handleEdit = (t) => { setEditingTrainee(t); setFormData({ ...t }); toggleM('trainee', 1); };
            const handleSaveTrainee = () => { if (!formData.name) return; const data = { ...formData, image: formData.image || DEFAULT_IMAGE }; let newT = editingTrainee ? trainees.map(t => t.id === editingTrainee.id ? { ...data, id: t.id } : t) : [{ ...data, id: Date.now().toString(), attendanceHistory: [], feeHistory: {} }, ...trainees]; updateData({ trainees: newT }); toggleM('trainee', 0); };
            const deleteTrainee = (id) => { if(confirm(t('alerts', 'del'))) updateData({ trainees: trainees.filter(t => t.id !== id) }); };
            const handleAddTeam = () => { const nt = [...teams, `New School ${teams.length + 1}`]; updateData({ teams: nt }); };
            const handleRenameTeam = (old) => { const n = renamingTeam.current.trim(); if(!n || n===old) return setRenamingTeam({original:'',current:''}); const nt = teams.map(t => t===old?n:t); const ntr = trainees.map(tr => tr.team===old?{...tr,team:n}:tr); updateData({teams:nt, trainees:ntr}); setRenamingTeam({original:'',current:''}); };
            const handleDeleteTeam = (n) => { if(confirm(`${t('alerts', 'del')} ${n}?`)) { const nt = teams.filter(t => t!==n); const ntr = trainees.map(tr => tr.team===n?{...tr,team:'Free Agent'}:tr); updateData({teams:nt, trainees:ntr}); } };
            const saveCoach = () => { if(!coachForm.name) return; let newC; if(editingCoach) { newC = coaches.map(c => c.id === editingCoach.id ? { ...c, ...coachForm } : c); } else { newC = [...coaches, { ...coachForm, id: Date.now().toString(), attendanceHistory: [], paymentHistory: {} }]; } updateData({ coaches: newC }); setEditingCoach(null); setCoachForm({ name: '', phone: '', role: 'Assistant', rate: 100 }); };
            const handleRegisterCoach = () => { if (!coachForm.name) return; const newC = [...coaches, { ...coachForm, id: Date.now().toString(), attendanceHistory: [], paymentHistory: {} }]; updateData({ coaches: newC }); setCoachForm({ name: '', phone: '', role: 'Assistant', rate: 100 }); };
            const deleteCoach = (id) => { if(!confirm(t('alerts', 'del'))) return; updateData({ coaches: coaches.filter(c => c.id !== id) }); };
            const removeCoachRecord = (coachId, dateToRemove, schoolToRemove) => { if (!confirm(t('alerts', 'del'))) return; const newCoaches = coaches.map(c => { if (c.id === coachId) { const newHistory = (c.attendanceHistory || []).filter(h => { const hDate = (typeof h === 'string') ? h : h.date; const hSchool = (typeof h === 'string') ? '' : (h.school || ''); return !(hDate === dateToRemove && (hSchool === schoolToRemove || (schoolToRemove === '' && hSchool === ''))); }); return { ...c, attendanceHistory: newHistory }; } return c; }); updateData({ coaches: newCoaches }); };
            const toggleCoachPayment = (id) => { const newCoaches = coaches.map(c => { if (c.id === id) { const history = c.paymentHistory || {}; const isPaid = history[financeMonth]?.status === 'paid'; return { ...c, paymentHistory: { ...history, [financeMonth]: { status: isPaid ? 'unpaid' : 'paid' } } }; } return c; }); updateData({ coaches: newCoaches }); };
            const toggleCoachAttendance = (id) => { const newCoaches = coaches.map(c => { if (c.id === id) { const history = c.attendanceHistory || []; const exists = history.some(h => h.date === coachAttDate && h.school === coachAttSchool); const newHistory = exists ? history.filter(h => !(h.date === coachAttDate && h.school === coachAttSchool)) : [...history, { date: coachAttDate, school: coachAttSchool }]; return { ...c, attendanceHistory: newHistory }; } return c; }); updateData({ coaches: newCoaches }); };
            const openAttendanceModal = () => { const today = new Date().toISOString().slice(0, 10); setAttendanceDate(today); setAttTab('trainees'); setAttendanceList(trainees.filter(t => t.attendanceHistory?.some(h => (h.date || h) === today)).map(t => t.id)); setCoachAttendanceList(coaches.filter(c => c.attendanceHistory?.some(h => h.date === today)).map(c => c.id)); toggleM('attendance', 1); };
            const toggleAttendance = (id) => { if (attTab === 'trainees') setAttendanceList(prev => prev.includes(id) ? prev.filter(i => i !== id) : [...prev, id]); else setCoachAttendanceList(prev => prev.includes(id) ? prev.filter(i => i !== id) : [...prev, id]); };
            const submitAttendance = () => { const newTrainees = trainees.map(t => { let history = Array.isArray(t.attendanceHistory) ? [...t.attendanceHistory] : []; history = history.filter(h => (h.date || h) !== attendanceDate); if (attendanceList.includes(t.id)) history.push({ date: attendanceDate, status: 'present' }); const rate = Math.round((history.length / PRESET_YEARLY_TOTAL) * 100); return { ...t, attendance: rate, attendanceHistory: history }; }); const newCoaches = coaches.map(c => { let history = Array.isArray(c.attendanceHistory) ? [...c.attendanceHistory] : []; history = history.filter(h => h.date !== attendanceDate); if (coachAttendanceList.includes(c.id)) history.push({ date: attendanceDate, school: teams[0] }); return { ...c, attendanceHistory: history }; }); updateData({ trainees: newTrainees, coaches: newCoaches }); toggleM('attendance', 0); alert(t('alerts', 'saved')); };
            const handleBackupToDrive = () => { const d=JSON.stringify({trainees,teams,leagueName,appLogo, coaches},null,2); const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([d],{type:"application/json"})); a.download = `CFC_Backup.json`; a.click(); };
            const handleImportFile = (e) => { const f=e.target.files?.[0]; if(!f) return; const r=new FileReader(); r.onload=(ev) => { try { const p=JSON.parse(ev.target.result); if(confirm(t('alerts', 'reset'))) { updateData(p); toggleM('data', 0); } } catch (e) { alert(t('alerts', 'fileError')); } }; r.readAsText(f); };
            const handleConnectCloud = () => { if (cloudConfig.key && cloudConfig.binId) { localStorage.setItem('cfc_jsonbin_config', JSON.stringify(cloudConfig)); syncFromCloud(cloudConfig.key, cloudConfig.binId); toggleM('cloud', 0); } else { alert(t('alerts', 'incomplete')); } };
            const createCloudBin = async () => { if (!cloudConfig.key) return alert("Key?"); try { const res = await fetch(JSONBIN_URL, { method: "POST", headers: { "Content-Type": "application/json", "X-Master-Key": cloudConfig.key, "X-Bin-Private": "true" }, body: JSON.stringify({ trainees, coaches, teams }) }); if (res.ok) { const json = await res.json(); setCloudConfig(p => ({ ...p, binId: json.metadata.id })); setIsCloudConnected(true); alert("Success"); } } catch (e) { alert(t('alerts', 'fail')); } };
            const handleLogoFile = (e) => { const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=(ev)=>{setTempImage(ev.target.result);setIsLogoCrop(true);toggleM('cropper', 1);}; r.readAsDataURL(f); e.target.value=""; };
            const handleTraineeFile = (e) => { const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=(ev)=>{setTempImage(ev.target.result);setIsLogoCrop(false);toggleM('cropper', 1);}; r.readAsDataURL(f); e.target.value=""; };
            const handleCropConfirm = async () => { if (cropperRef.current) { const b64 = cropperRef.current.getCroppedCanvas({width:400,height:400}).toDataURL('image/jpeg',0.8); let finalUrl = b64; if (isImgCloudReady) { const cloudUrl = await uploadToCloudinary(b64); if (cloudUrl) finalUrl = cloudUrl; } if (isLogoCrop) updateData({ appLogo: finalUrl }); else setFormData(p => ({ ...p, image: finalUrl })); toggleM('cropper', 0); } };
            const handleRotate = () => { if (cropperRef.current) cropperRef.current.rotate(90); };
            const handleAttendanceChange = (field, val) => { const num = parseInt(val) || 0; setFormData(p => ({ ...p, [field]: num })); };
            const resetPlayerStats = () => { if(!confirm(t('alerts', 'reset'))) return; setFormData({ ...formData, attendedSessions: 0, attendance: 0, attendanceHistory: [] }); };
            const sendCoachMessage = (coach) => { window.open(`https://wa.me/${coach.phone.replace(/[^0-9]/g, '')}`, '_blank'); };
            const toggleFeeStatus = (traineeId) => { const newTrainees = trainees.map(trainee => { if (trainee.id === traineeId) { const history = trainee.feeHistory || {}; const currentStatus = history[financeMonth] || false; return { ...trainee, feeHistory: { ...history, [financeMonth]: !currentStatus } }; } return trainee; }); updateData({ trainees: newTrainees }); };
            const toggleAllFeeStatus = () => { const allPaid = financeFiltered.every(trainee => trainee.feeHistory && trainee.feeHistory[financeMonth]); const targetStatus = !allPaid; if (!confirm(`Mark all ${targetStatus?'Paid':'Unpaid'}?`)) return; const newTrainees = trainees.map(trainee => { if (financeFiltered.some(rt => rt.id === trainee.id)) { const history = trainee.feeHistory || {}; return { ...trainee, feeHistory: { ...history, [financeMonth]: targetStatus } }; } return trainee; }); updateData({ trainees: newTrainees }); };
            const toggleAllAttendanceStatus = () => { const currentIds = attTab === 'trainees' ? attendanceList : coachAttendanceList; const filteredIds = attendanceFiltered.map(i => i.id); const allSelected = filteredIds.every(id => currentIds.includes(id)); if (allSelected) { if (attTab === 'trainees') setAttendanceList(attendanceList.filter(id => !filteredIds.includes(id))); else setCoachAttendanceList(coachAttendanceList.filter(id => !filteredIds.includes(id))); } else { if (attTab === 'trainees') setAttendanceList([...new Set([...attendanceList, ...filteredIds])]); else setCoachAttendanceList([...new Set([...coachAttendanceList, ...filteredIds])]); } };
            const sendFeeReminder = (trainee) => { const dict = TRANSLATIONS[lang] || TRANSLATIONS['zh']; const template = dict.msgs[msgTemplate] || dict.msgs['gentle']; const bankInfo = dict.bankDetails.replace('{bankName}', BANK_INFO.bankName).replace('{accNum}', BANK_INFO.accNum).replace('{holder}', BANK_INFO.holder); const msgBody = template.replace('{name}', trainee.name).replace('{month}', financeMonth).replace('{amount}', monthlyFee); const fullMsg = msgBody + bankInfo; window.open(`https://wa.me/?text=${encodeURIComponent(fullMsg)}`, '_blank'); };
            const copyBankInfo = () => { safeCopy(`${BANK_INFO.bankName}\n${BANK_INFO.accNum}\n${BANK_INFO.holder}`, t('alerts', 'copied')); };
            const parseImportText = () => { if (!importText) return; const text = importText.toLowerCase(); const matchedIds = (attTab === 'trainees' ? filteredTrainees : coaches).filter(item => text.includes(item.name.toLowerCase())).map(item => item.id); if (attTab === 'trainees') setAttendanceList(matchedIds); else setCoachAttendanceList(matchedIds); alert(`Matched ${matchedIds.length}`); };
            const mockAI = (type, trainee) => { setAiLoading(true); setTimeout(() => { setAiResult({name:trainee.name, content: "Great potential."}); setFormData(p=>({...p, coachComment: "Great potential."})); setAiLoading(false); }, 1000); };
            const saveImgConfig = () => { if(imgConfig.cloudName) { localStorage.setItem('cfc_cloudinary_config', JSON.stringify(imgConfig)); setIsImgCloudReady(true); alert("Saved"); } };
            const testCloudinary = async () => { alert("Testing..."); };
            const handleWhatsappShare = () => { const names = attendanceFiltered.filter(i => attTab === 'trainees' ? attendanceList.includes(i.id) : coachAttendanceList.includes(i.id)).map(i => i.name); window.open(`https://wa.me/?text=${encodeURIComponent(`ðŸ“… ${attendanceDate}:\n${names.join('\n')}`)}`, '_blank'); };
            const handleExportAttendanceExcel = () => { const targetSchool = selectedTeam === 'å…¨éƒ¨' ? 'All' : selectedTeam; let csv = `Name,Status\n`; (attTab==='trainees'?filteredTrainees:coaches).forEach(i=>{csv+=`${i.name},${(attTab==='trainees'?attendanceList:coachAttendanceList).includes(i.id)?'Present':'Absent'}\n`}); const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" }); const link = document.createElement("a"); link.href = URL.createObjectURL(blob); link.download = `Att_${attendanceDate}.csv`; link.click(); };
            const exportFinanceExcel = () => { let csv = `Name,Status\n`; financeFiltered.forEach(t=>{csv+=`${t.name},${t.feeHistory?.[financeMonth]?'PAID':'UNPAID'}\n`}); const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" }); const link = document.createElement("a"); link.href = URL.createObjectURL(blob); link.download = `Fin_${financeMonth}.csv`; link.click(); };
            const generateShareText = (t) => `${t.name} | ${t.team}`;
            const handleSystemShare = (t) => { const text = generateShareText(t); if(navigator.share) { navigator.share({title:t.name, text: text}).catch(err => { if (err.name !== 'AbortError') setShareTarget(t); }); } else { setShareTarget(t); } };

            useEffect(() => {
                const local = JSON.parse(localStorage.getItem('cfc_local_db') || '{}');
                setTrainees(local.trainees || INITIAL_TRAINEES);
                setCoaches(local.coaches || INITIAL_COACHES);
                setLeagueName(local.leagueName || 'CFC YOUTH ACADEMY');
                setAppLogo(local.appLogo || null);
                if (local.teams) setTeams(local.teams);
                const savedCloud = JSON.parse(localStorage.getItem('cfc_jsonbin_config') || '{}');
                if (savedCloud.binId) { setCloudConfig(savedCloud); syncFromCloud(savedCloud.key, savedCloud.binId); }
                const savedImgCloud = JSON.parse(localStorage.getItem('cfc_cloudinary_config') || '{}');
                if (savedImgCloud.cloudName) { setImgConfig(savedImgCloud); setIsImgCloudReady(true); }
                setTimeout(() => document.getElementById('static-loading').classList.add('hidden'), 500);
            }, []);

            useEffect(() => { if (modals.cropper && cropperImageRef.current) { if (cropperRef.current) cropperRef.current.destroy(); cropperRef.current = new Cropper(cropperImageRef.current, { aspectRatio: 1, viewMode: 1 }); } }, [modals.cropper, tempImage]);

            if (!userRole) return (
                <div className="fixed inset-0 bg-black flex flex-col items-center justify-center p-6 z-[6000] fade-in">
                    <div className="w-24 h-24 mb-6 rounded-2xl overflow-hidden border-2 border-zinc-800 bg-zinc-900 flex items-center justify-center shadow-2xl">
                        {appLogo ? <img src={appLogo} className="w-full h-full object-cover"/> : <i className="fa-solid fa-shield-halved text-yellow-500 text-5xl"></i>}
                    </div>
                    <h1 className="text-3xl font-black text-white mb-2 uppercase tracking-tighter">CFC YOUTH ACADEMY</h1>
                    <div className="w-full max-w-sm space-y-4 mt-8">
                        {!showPinInput ? (
                            <>
                                <button onClick={() => setShowPinInput(true)} className="w-full py-4 bg-zinc-800 rounded-xl font-bold flex items-center justify-center gap-3 border border-zinc-700 active:scale-95 transition-all text-white uppercase shadow-xl"><i className="fa-solid fa-user-shield text-emerald-400"></i> {t('auth', 'adminMode')}</button>
                                <button onClick={() => handleLogin('user')} className="w-full py-4 bg-zinc-900 rounded-xl font-bold flex items-center justify-center gap-3 border border-zinc-800 active:scale-95 transition-all text-white uppercase text-sm"><i className="fa-solid fa-users text-blue-400"></i> {t('auth', 'userMode')}</button>
                            </>
                        ) : (
                            <div className="bg-zinc-900 p-6 rounded-2xl border border-zinc-800 shadow-2xl">
                                <h3 className="text-center text-zinc-400 text-sm mb-4 uppercase font-bold tracking-widest leading-none">{t('auth', 'enterPin')}</h3>
                                <div className="grid grid-cols-3 gap-3">
                                    {[1,2,3,4,5,6,7,8,9,0].map(n => <button key={n} onClick={() => setPinInput(p => (p+n).slice(0,4))} className="py-4 bg-zinc-800 rounded-lg font-bold text-xl text-white active:bg-zinc-700">{n}</button>)}
                                    <button onClick={() => {setShowPinInput(false); setPinInput("");}} className="text-red-500 text-[10px] font-black uppercase tracking-tighter">BACK</button>
                                    <button onClick={() => handleLogin('admin')} className="bg-emerald-600 rounded-lg flex items-center justify-center text-white active:bg-emerald-500 shadow-lg shadow-emerald-600/20"><i className="fa-solid fa-check text-xl"></i></button>
                                </div>
                            </div>
                        )}
                        <div className="flex justify-center gap-6 mt-8">
                            <button onClick={() => setLang('zh')} className={`text-2xl transition-opacity ${lang === 'zh' ? 'opacity-100 scale-110' : 'opacity-40 grayscale'}`}>ðŸ‡¨ðŸ‡³</button>
                            <button onClick={() => setLang('ms')} className={`text-2xl transition-opacity ${lang === 'ms' ? 'opacity-100 scale-110' : 'opacity-40 grayscale'}`}>ðŸ‡²ðŸ‡¾</button>
                            <button onClick={() => setLang('en')} className={`text-2xl transition-opacity ${lang === 'en' ? 'opacity-100 scale-110' : 'opacity-40 grayscale'}`}>ðŸ‡¬ðŸ‡§</button>
                        </div>
                    </div>
                </div>
            );

            return (
                <div className="max-w-[1920px] mx-auto p-4 md:p-8 pb-24 fade-in font-sans">
                    <div className="h-1 bg-gradient-to-r from-blue-600 via-indigo-500 to-yellow-500 mb-6 rounded-full shadow-lg"></div>
                    <header className="relative z-30 flex flex-col xl:flex-row justify-between items-center gap-6 mb-8">
                        <div className="flex items-center gap-4 w-full">
                            <div className="w-16 h-16 rounded-xl overflow-hidden border border-zinc-700 cursor-pointer bg-zinc-900 shrink-0 shadow-lg shadow-black/40" onClick={() => userRole === 'admin' && logoInputRef.current.click()}>
                                {appLogo ? <img src={appLogo} className="w-full h-full object-cover"/> : <div className="bg-zinc-900 w-full h-full flex items-center justify-center"><i className="fa-solid fa-shield-halved text-yellow-500 text-3xl"></i></div>}
                                <input type="file" ref={logoInputRef} className="hidden" accept="image/*" onChange={handleLogoFile}/>
                            </div>
                            <div className="flex-1">
                                <h1 className="text-2xl font-black text-white tracking-tight uppercase leading-none mb-1">{leagueName}</h1>
                                <div className="flex flex-wrap items-center gap-3 mt-1 text-zinc-500 font-bold">
                                    <span className={`px-2 py-0.5 rounded text-[10px] font-bold border tracking-widest ${userRole==='admin'?'bg-emerald-900/50 text-emerald-400 border-emerald-500/30 shadow-lg':'bg-blue-900/50 text-blue-400 border-blue-500/30'}`}>{userRole.toUpperCase()}</span>
                                    {userRole === 'admin' && (
                                        <button onClick={() => toggleM('cloud', 1)} className={`px-2 py-0.5 rounded flex items-center gap-1 transition-all border text-[10px] font-bold ${isCloudConnected ? 'bg-indigo-900/40 text-indigo-400 border-indigo-500/30' : 'bg-zinc-800 text-zinc-500 border-zinc-700'}`}>
                                            <i className={`fa-solid fa-cloud ${isCloudConnected ? 'animate-pulse' : ''}`}></i> {cloudStatus || "Local"}
                                        </button>
                                    )}
                                    <button onClick={() => toggleM('share', 1)} className="hover:text-white transition-colors"><i className="fa-solid fa-qrcode text-sm"></i></button>
                                    <button onClick={() => setUserRole(null)} className="hover:text-red-400 transition-colors"><i className="fa-solid fa-right-from-bracket"></i></button>
                                </div>
                            </div>
                        </div>
                        {userRole === 'admin' && (
                            <div className="grid grid-cols-4 sm:flex gap-2 w-full">
                                <div className="col-span-4 flex gap-2 overflow-x-auto no-scrollbar pb-1">
                                    <button onClick={() => toggleM('finance', 1)} className="flex-1 min-w-[80px] px-2 py-3 bg-yellow-600 rounded-xl font-bold text-[10px] shadow-lg uppercase active:scale-95 transition-all flex flex-col items-center justify-center gap-1 whitespace-nowrap"><i className="fa-solid fa-sack-dollar text-lg"></i>{t('nav', 'finance')}</button>
                                    <button onClick={openAttendanceModal} className="flex-1 min-w-[80px] px-2 py-3 bg-emerald-700 rounded-xl font-bold text-[10px] shadow-lg uppercase active:scale-95 transition-all flex flex-col items-center justify-center gap-1 whitespace-nowrap"><i className="fa-solid fa-calendar-check text-lg"></i>{t('nav', 'att')}</button>
                                    <button onClick={() => { toggleM('coach', 1); setCoachView('list'); }} className="flex-1 min-w-[80px] px-2 py-3 bg-blue-800 rounded-xl font-bold text-[10px] shadow-lg uppercase active:scale-95 transition-all flex flex-col items-center justify-center gap-1 whitespace-nowrap"><i className="fa-solid fa-user-tie text-lg"></i>{t('nav', 'coach')}</button>
                                    <button onClick={() => toggleM('school', 1)} className="flex-1 min-w-[80px] px-2 py-3 bg-zinc-800 rounded-xl font-bold text-[10px] border border-zinc-700 active:scale-95 shadow-lg uppercase flex flex-col items-center justify-center gap-1 whitespace-nowrap"><i className="fa-solid fa-school text-lg"></i>{t('nav', 'school')}</button>
                                    <button onClick={() => toggleM('data', 1)} className="flex-1 min-w-[80px] px-2 py-3 bg-indigo-800 rounded-xl font-bold text-[10px] shadow-lg uppercase active:scale-95 transition-all flex flex-col items-center justify-center gap-1 whitespace-nowrap"><i className="fa-solid fa-cloud-arrow-up text-lg"></i>{t('nav', 'data')}</button>
                                    <button onClick={handleRegister} className="flex-1 min-w-[80px] px-2 py-3 bg-white text-black rounded-xl font-black text-[10px] active:scale-95 shadow-xl uppercase tracking-tighter shadow-white/5 flex flex-col items-center justify-center gap-1 whitespace-nowrap"><i className="fa-solid fa-user-plus text-lg"></i>{t('nav', 'reg')}</button>
                                </div>
                            </div>
                        )}
                    </header>

                    <div className="mb-8 space-y-4">
                        <input className="w-full bg-zinc-900 border border-zinc-800 rounded-2xl py-4 px-6 outline-none focus:border-indigo-500 text-lg shadow-xl text-white placeholder-zinc-700 font-bold" placeholder={t('filter', 'search')} value={searchTerm} onChange={e => setSearchTerm(e.target.value)} />
                        <div className="flex gap-2 overflow-x-auto no-scrollbar pb-1">
                             {[t('common', 'all'), ...teams].map(team => (
                                <button key={team} onClick={() => setSelectedTeam(team)} className={`px-4 py-2 rounded-xl border font-bold whitespace-nowrap transition-all ${selectedTeam === team ? 'bg-yellow-500 text-black border-yellow-500 shadow-lg' : 'bg-zinc-900 text-zinc-500 border-zinc-800'}`}>{team}</button>
                            ))}
                        </div>
                    </div>

                    <div className="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 2xl:grid-cols-6 gap-4">
                        {filteredTrainees.map(t => (
                            <div key={t.id} className="bg-zinc-900 rounded-3xl border border-zinc-800 overflow-hidden flex flex-col group hover:border-zinc-500 shadow-xl transition-all relative">
                                <div className="h-32 relative overflow-hidden">
                                    <img src={getOptimizedImageUrl(t.image)} className="w-full h-full object-cover transition-transform group-hover:scale-110 duration-700" onError={e => e.target.src = DEFAULT_IMAGE}/>
                                    <div className="absolute inset-0 bg-gradient-to-t from-zinc-900 via-transparent opacity-80"></div>
                                    <span className="absolute top-3 left-3 bg-yellow-500 text-black text-[10px] font-black px-1.5 rounded shadow-lg">{getPositionCode(t.primaryPosition)}</span>
                                    <div className="absolute bottom-3 left-4 right-4 truncate leading-tight font-black uppercase text-white drop-shadow-md">{t.name}</div>
                                    <button onClick={(e)=>{e.stopPropagation(); handleSystemShare(t);}} className="absolute bottom-2 right-2 w-7 h-7 bg-white/10 backdrop-blur-md rounded-full flex items-center justify-center text-white hover:bg-emerald-600 transition-all border border-white/20 shadow-lg z-20 active:scale-90"><i className="fa-solid fa-share-nodes text-[10px]"></i></button>
                                </div>
                                <div className="p-3 flex-1 flex flex-col">
                                    <div className="grid grid-cols-3 gap-1 mb-2">
                                        {['pace', 'shooting', 'passing'].map(s => <div key={s} className="bg-black/30 p-1 rounded-xl flex flex-col items-center border border-zinc-800/50 shadow-inner font-black uppercase tracking-tighter"><span className="text-zinc-600 text-[8px]">{s.slice(0,3)}</span><span className={`text-xs ${getGradeColor(getStatGrade(t.stats?.[s]))}`}>{getStatGrade(t.stats?.[s])}</span></div>)}
                                    </div>
                                    {t.coachComment && <div className="mb-2 px-1"><p className="text-[9px] text-zinc-500 truncate italic"><i className="fa-solid fa-comment-dots mr-1"></i> {t.coachComment}</p></div>}
                                    <div className="mt-auto pt-3 border-t border-zinc-800/50 flex justify-between items-center">
                                        <div className={`w-2.5 h-2.5 rounded-full ${getAttendanceColor(t.attendance || 0)}`}></div>
                                        {userRole === 'admin' && (
                                            <div className="flex gap-1">
                                                <button onClick={() => handleEdit(t)} className="w-7 h-7 rounded-full bg-zinc-800 text-zinc-400 flex items-center justify-center active:scale-90 transition-transform"><i className="fa-solid fa-pen text-xs"></i></button>
                                                <button onClick={() => deleteTrainee(t.id)} className="w-7 h-7 rounded-full bg-red-900/20 text-red-500 flex items-center justify-center active:scale-90 transition-transform shadow-lg shadow-red-900/10"><i className="fa-solid fa-trash-can text-xs"></i></button>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>
                        ))}
                    </div>

                    {modals.coach && (
                        <div className="fixed inset-0 z-[600] bg-black/90 backdrop-blur-md flex items-center justify-center p-4 fade-in" onClick={() => toggleM('coach', 0)}>
                            <div className="bg-zinc-900 border border-zinc-800 w-full max-w-lg h-[85vh] rounded-[2.5rem] p-6 flex flex-col shadow-2xl shadow-black" onClick={e => e.stopPropagation()}>
                                <div className="flex justify-between items-center mb-6 shrink-0 font-black"><h2 className="text-xl flex items-center gap-2 text-white uppercase font-bold"><i className="fa-solid fa-user-tie text-blue-500"></i> {t('coach', 'title')}</h2><button onClick={() => toggleM('coach', 0)} className="text-zinc-500 hover:text-white transition-colors"><i className="fa-solid fa-xmark text-2xl text-zinc-500"></i></button></div>
                                <div className="flex bg-zinc-950 p-1 rounded-2xl mb-6 border border-zinc-800 shrink-0 shadow-inner">
                                    {['list', 'attendance', 'finance'].map(v => <button key={v} onClick={() => setCoachView(v)} className={`flex-1 py-2.5 text-xs font-bold rounded-xl transition-all ${coachView === v ? 'bg-blue-600 text-white shadow-lg' : 'text-zinc-500'}`}>{t('coach', v === 'attendance' ? 'att' : (v === 'finance' ? 'fin' : 'list'))}</button>)}
                                </div>
                                <div className="flex-1 overflow-y-auto pr-1 no-scrollbar space-y-4">
                                    {coachView === 'finance' && (
                                        <>
                                            <div className="bg-zinc-950 p-4 rounded-3xl border border-zinc-800 flex justify-between items-center mb-2 sticky top-0 z-10 backdrop-blur-lg shadow-lg">
                                                <input type="month" className="bg-zinc-900 text-white px-3 py-1.5 rounded-xl border border-zinc-700 text-sm outline-none focus:border-blue-500" value={financeMonth} onChange={e => setFinanceMonth(e.target.value)}/>
                                                <div className="text-right leading-none font-black uppercase tracking-tighter"><p className="text-[10px] text-zinc-500 mb-1">{t('coach', 'total')}</p><p className="text-2xl text-emerald-400 font-black">RM {payrollData.total}</p></div>
                                            </div>
                                            {payrollData.list.map(c => (
                                                <div key={c.id} className="bg-zinc-800 p-5 rounded-3xl border border-zinc-700 flex flex-col gap-4 shadow-lg shadow-black/20">
                                                    <div className="flex justify-between items-center">
                                                        <div className="flex-1 leading-tight uppercase font-black">
                                                            <div className="flex items-center gap-2 font-bold text-white text-lg leading-none">{c.name}<button onClick={() => setExpandedCoachId(expandedCoachId === c.id ? null : c.id)} className="text-[10px] font-black text-zinc-400 bg-zinc-900 px-3 py-1 rounded-full border border-zinc-700 active:scale-95 transition-transform">{t('coach', 'details')}</button></div>
                                                            <p className="text-xs text-zinc-500 mt-2 font-bold leading-none">{t('coach', 'sessions')}: {c.sessions} x RM{c.rate}</p>
                                                        </div>
                                                        <div className="text-right font-black uppercase tracking-widest leading-none">
                                                            <p className="text-xl text-white leading-none mb-2">RM {c.amount}</p>
                                                            <button onClick={() => toggleCoachPayment(c.id)} className={`text-[10px] px-3 py-1 rounded-full transition-all font-black shadow-lg ${c.isPaid?'bg-emerald-600 text-white shadow-emerald-900/20':'bg-zinc-900 border border-zinc-700 text-zinc-500 shadow-none'}`}>{c.isPaid ? t('common', 'paid') : t('common', 'unpaid')}</button>
                                                        </div>
                                                    </div>
                                                    {expandedCoachId === c.id && (
                                                        <div className="bg-black/40 p-4 rounded-2xl space-y-3 border border-zinc-700/30 fade-in max-h-64 overflow-y-auto no-scrollbar shadow-inner">
                                                            {(c.details && c.details.length > 0) ? c.details.map((d, i) => (
                                                                <div key={i} className="flex justify-between items-center text-[12px] border-b border-zinc-800/50 pb-3 last:border-0 last:pb-0 font-bold uppercase tracking-tighter">
                                                                    <div className="flex flex-col tracking-tighter leading-tight">
                                                                        <span className="text-zinc-200">{d.date}</span>
                                                                        <span className="text-blue-400 text-[10px] uppercase font-black">{d.school || 'Unknown'}</span>
                                                                    </div>
                                                                    <button onClick={() => removeCoachRecord(c.id, d.date, d.school)} className="w-8 h-8 rounded-xl bg-red-900/20 text-red-500 flex items-center justify-center hover:bg-red-900/50 active:scale-90 transition-all shadow-lg shadow-black/30 border border-red-900/30"><i className="fa-solid fa-trash-can text-[11px]"></i></button>
                                                                </div>
                                                            )) : <p className="text-center text-zinc-600 text-[10px] italic py-4 font-black">{t('noData')}</p>}
                                                        </div>
                                                    )}
                                                </div>
                                            ))}
                                        </>
                                    )}
                                    {coachView === 'list' && (
                                        <div className="space-y-4 font-black uppercase tracking-tighter">
                                            <div className="bg-zinc-950 p-5 rounded-[2.5rem] border border-zinc-800 mb-2 shadow-xl shadow-black/20">
                                                <div className="grid grid-cols-2 gap-3 mb-4 leading-none"><input className="bg-zinc-900 border border-zinc-700 rounded-xl px-4 py-3 text-sm text-white focus:border-blue-500 outline-none" placeholder={t('common', 'name')} value={coachForm.name} onChange={e => setCoachForm({...coachForm, name: e.target.value})} /><input className="bg-zinc-900 border border-zinc-700 rounded-xl px-4 py-3 text-sm text-white font-mono focus:border-blue-500 outline-none" placeholder={t('common', 'phone')} value={coachForm.phone} onChange={e => setCoachForm({...coachForm, phone: e.target.value})} /></div>
                                                <button onClick={handleRegisterCoach} className="w-full py-4 bg-blue-600 hover:bg-blue-500 text-white text-sm font-black rounded-2xl active:scale-95 transition-all shadow-lg shadow-blue-600/20 uppercase tracking-widest leading-none">{t('coach', 'reg')}</button>
                                            </div>
                                            {coaches.map(c => <div key={c.id} className="bg-zinc-800 p-5 rounded-3xl border border-zinc-700 flex justify-between items-center shadow-lg shadow-black/20 leading-none"><div><p className="font-bold text-white text-lg tracking-widest leading-none mb-1">{c.name}</p><p className="text-xs text-zinc-500 font-bold uppercase">{c.role} â€¢ RM{c.rate}</p></div><button onClick={() => updateData({coaches: coaches.filter(coach => coach.id !== c.id)})} className="w-10 h-10 rounded-full bg-red-900/20 text-red-500 flex items-center justify-center active:scale-90 transition-transform shadow-lg shadow-red-900/10 border border-red-900/20"><i className="fa-solid fa-trash-can text-sm"></i></button></div>)}
                                        </div>
                                    )}
                                    {coachView === 'attendance' && (
                                        <div className="space-y-4">
                                            <div className="bg-zinc-950 p-4 rounded-3xl border border-zinc-800 mb-4 sticky top-0 z-10 flex gap-3 shadow-lg shadow-black/30"><input type="date" className="flex-1 bg-zinc-900 text-white px-4 py-2 rounded-2xl border border-zinc-700 font-bold outline-none uppercase" value={coachAttDate} onChange={e => setCoachAttDate(e.target.value)}/><select className="flex-1 bg-zinc-900 text-white px-4 py-2 rounded-2xl border border-zinc-700 text-sm font-bold uppercase" value={coachAttSchool} onChange={e => setCoachAttSchool(e.target.value)}>{teams.map(t => <option key={t} value={t}>{t}</option>)}</select></div>
                                            {coaches.map(c => {
                                                const isPresent = (c.attendanceHistory || []).some(h => h.date === coachAttDate && h.school === coachAttSchool);
                                                return <div key={c.id} onClick={() => toggleCoachAttendance(c.id)} className={`flex items-center justify-between p-5 rounded-3xl border cursor-pointer transition-all ${isPresent ? 'bg-emerald-900/30 border-emerald-500 shadow-lg shadow-emerald-900/10' : 'bg-zinc-800/50 border-zinc-700 opacity-60'}`}><div className="flex items-center gap-4"><div className={`w-6 h-6 rounded-lg flex items-center justify-center border ${isPresent ? 'bg-emerald-500 border-emerald-500 text-black' : 'border-zinc-600'}`}>{isPresent && <i className="fa-solid fa-check text-sm"></i>}</div><div className="leading-tight font-black uppercase tracking-widest"><p className="text-white text-lg">{c.name}</p><p className="text-[10px] text-zinc-500">{c.role}</p></div></div></div>;
                                            })}
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {modals.school && (
                        <div className="fixed inset-0 z-[600] bg-black/90 backdrop-blur-md flex items-center justify-center p-4 fade-in" onClick={() => toggleM('school', 0)}>
                            <div className="bg-zinc-900 border border-zinc-800 w-full max-w-md rounded-[2.5rem] p-8 flex flex-col shadow-2xl shadow-black" onClick={e => e.stopPropagation()}>
                                <div className="flex justify-between items-center mb-6 shrink-0 font-black font-bold uppercase tracking-widest leading-none"><h2 className="text-xl text-white">{t('school', 'title')}</h2><button onClick={() => toggleM('school', 0)} className="text-zinc-500 hover:text-white transition-colors"><i className="fa-solid fa-xmark text-2xl text-zinc-500"></i></button></div>
                                <div className="space-y-3 flex-1 overflow-y-auto pr-1 no-scrollbar max-h-[50vh] mb-8">
                                    {teams.map(team => (
                                        <div key={team} className="bg-zinc-800 p-4 rounded-2xl border border-zinc-700 flex justify-between items-center group shadow-lg uppercase font-black leading-none">
                                            {renamingTeam.original === team ? (
                                                <div className="flex gap-2 w-full"><input autoFocus className="flex-1 bg-zinc-950 px-4 py-2 rounded-xl text-sm text-white focus:border-indigo-500 outline-none shadow-inner" value={renamingTeam.current} onChange={e => setRenamingTeam({...renamingTeam, current: e.target.value})} onKeyDown={e => e.key==='Enter' && handleRenameTeam(team)}/><button onClick={() => handleRenameTeam(team)} className="bg-emerald-600 text-white px-4 py-2 rounded-xl active:scale-90 shadow-lg leading-none"><i className="fa-solid fa-check"></i></button></div>
                                            ) : (
                                                <><span className="font-bold text-zinc-100 uppercase tracking-widest">{team}</span><div className="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity"><button onClick={() => setRenamingTeam({original: team, current: team})} className="p-2 text-zinc-500 hover:text-white transition-colors"><i className="fa-solid fa-pen text-xs"></i></button><button onClick={() => handleDeleteTeam(team)} className="p-2 text-zinc-500 hover:text-red-500 transition-colors"><i className="fa-solid fa-trash text-xs"></i></button></div></>
                                            )}
                                        </div>
                                    ))}
                                </div>
                                <button onClick={handleAddTeam} className="w-full py-5 bg-white text-zinc-900 rounded-[2rem] font-black uppercase tracking-widest flex items-center justify-center gap-2 active:scale-95 shadow-2xl leading-none"><i className="fa-solid fa-plus text-lg"></i> {t('school', 'add')}</button>
                            </div>
                        </div>
                    )}

                    {modals.trainee && (
                        <div className="fixed inset-0 z-[600] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 fade-in" onClick={() => toggleM('trainee', 0)}>
                            <div className="bg-zinc-900 border border-zinc-800 w-full max-w-lg rounded-[2.5rem] p-8 overflow-y-auto max-h-[90vh] shadow-2xl shadow-black font-black uppercase tracking-tighter" onClick={e => e.stopPropagation()}>
                                <div className="flex justify-between items-center mb-8 shrink-0 font-black text-white uppercase tracking-tighter leading-none font-bold"><h2 className="text-2xl">{t('player', 'title')}</h2><button onClick={() => toggleM('trainee', 0)} className="text-zinc-500 hover:text-white transition-colors"><i className="fa-solid fa-xmark text-2xl"></i></button></div>
                                <div className="space-y-6">
                                    <div className="flex flex-col sm:flex-row items-center gap-8 font-black uppercase leading-none">
                                        <div className="w-32 h-32 bg-zinc-800 rounded-[2.5rem] border-2 border-zinc-700 cursor-pointer shadow-2xl flex items-center justify-center overflow-hidden shrink-0 shadow-black" onClick={() => fileInputRef.current.click()}>
                                            {formData.image ? <img src={formData.image} className="w-full h-full object-cover"/> : <i className="fa-solid fa-camera text-3xl text-zinc-600"></i>}
                                            <input type="file" ref={fileInputRef} className="hidden" accept="image/*" onChange={handleTraineeFile}/>
                                        </div>
                                        <div className="flex-1 w-full space-y-4">
                                            <input className="w-full bg-zinc-950 border border-zinc-800 rounded-2xl px-6 py-3.5 font-bold text-white focus:border-indigo-500 outline-none transition-all shadow-inner font-black uppercase text-sm" placeholder={t('common', 'name')} value={formData.name || ''} onChange={e => setFormData({...formData, name: e.target.value})}/>
                                            <select className="w-full bg-zinc-950 border border-zinc-800 rounded-2xl px-6 py-3.5 text-zinc-300 text-sm outline-none font-black shadow-inner uppercase" value={formData.team} onChange={e => setFormData({...formData, team: e.target.value})}>
                                                <option value="">{t('common', 'school')}</option>
                                                {teams.map(t => <option key={t} value={t}>{t}</option>)}
                                            </select>
                                        </div>
                                    </div>
                                    <div className="space-y-2">
                                        <div className="flex justify-between items-center"><label className="text-[10px] text-zinc-500 font-bold uppercase tracking-widest ml-2">{t('common', 'comment')}</label><button onClick={mockAI} className="text-[10px] bg-indigo-900/50 text-indigo-400 px-2 py-0.5 rounded border border-indigo-500/30 flex items-center gap-1 hover:bg-indigo-900 hover:text-white transition-colors">{aiLoading ? <i className="fa-solid fa-spinner fa-spin"></i> : <i className="fa-solid fa-wand-magic-sparkles"></i>} {t('common', 'generate')}</button></div>
                                        <textarea className="w-full bg-zinc-950 border border-zinc-800 rounded-2xl px-6 py-3.5 font-bold text-white focus:border-indigo-500 outline-none transition-all shadow-inner text-xs h-24 resize-none leading-relaxed" placeholder="..." value={formData.coachComment || ''} onChange={e => setFormData({...formData, coachComment: e.target.value})}></textarea>
                                    </div>
                                    <div className="grid grid-cols-2 gap-4 uppercase font-black text-[10px] tracking-widest">
                                        {Object.keys(formData.stats || {}).map(s => (
                                            <div key={s} className="bg-zinc-800/50 p-4 rounded-3xl border border-zinc-700/50 shadow-inner">
                                                <div className="flex justify-between mb-3 text-zinc-500 tracking-widest leading-none font-black"><span>{t('stats', s)}</span><span className="text-white bg-zinc-700 px-2.5 py-0.5 rounded-lg leading-none">{formData.stats?.[s] || 50}</span></div>
                                                <input type="range" className="w-full h-1.5 bg-zinc-700 rounded-lg appearance-none cursor-pointer" value={formData.stats?.[s] || 50} min="0" max="99" onChange={e => setFormData({...formData, stats: {...formData.stats, [s]: parseInt(e.target.value)}})}/>
                                            </div>
                                        ))}
                                    </div>
                                    <button onClick={handleSaveTrainee} className="w-full py-5 bg-white text-zinc-900 rounded-[2rem] font-black text-xl shadow-2xl active:scale-[0.98] transition-all mt-4 uppercase tracking-tighter leading-none">{t('common', 'save')}</button>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {modals.attendance && (<div className="fixed inset-0 z-[80] flex items-center justify-center p-4 bg-black/90 backdrop-blur-sm fade-in"><div className="bg-zinc-900 w-full max-w-lg rounded-2xl border border-zinc-800 shadow-2xl p-6 max-h-[90vh] overflow-y-auto flex flex-col"><div className="flex justify-between items-center mb-4"><h2 className="text-xl font-bold text-white flex items-center gap-2"><i className="fa-solid fa-calendar-check text-emerald-500"></i> {t('att', 'title')}</h2><div className="flex items-center gap-2"><input type="date" className="bg-zinc-800 text-white text-xs px-2 py-1 rounded border border-zinc-600 focus:border-emerald-500 outline-none" value={attendanceDate} onChange={(e) => setAttendanceDate(e.target.value)} /><button onClick={() => toggleM('attendance', 0)}><i className="fa-solid fa-xmark text-xl text-zinc-500 hover:text-white"></i></button></div></div>
                    <div className="flex bg-zinc-950 rounded-lg p-1 mb-4 border border-zinc-700">
                        <button onClick={() => setAttTab('trainees')} className={`flex-1 py-2 text-xs font-bold rounded ${attTab === 'trainees' ? 'bg-emerald-600 text-white' : 'text-zinc-500'}`}>{t('att', 'tabT')}</button>
                        <button onClick={() => setAttTab('coaches')} className={`flex-1 py-2 text-xs font-bold rounded ${attTab === 'coaches' ? 'bg-blue-600 text-white' : 'text-zinc-500'}`}>{t('att', 'tabC')}</button>
                    </div>
                    <div className="bg-zinc-950 p-4 rounded-xl border border-zinc-800 mb-4"><label className="text-zinc-400 text-xs font-bold block mb-2">{t('att', 'paste')}</label><textarea className="w-full bg-black border border-zinc-700 rounded-lg p-3 text-xs text-white h-20 mb-2 focus:border-emerald-500 outline-none" placeholder={t('attPlaceholder')} value={importText} onChange={e => setImportText(e.target.value)}></textarea><button onClick={parseImportText} className="w-full py-2 bg-zinc-800 hover:bg-zinc-700 text-emerald-400 border border-emerald-900/30 rounded-lg text-xs font-bold">{t('attPasteDesc')}</button></div>
                    <div className="mb-2 px-1"><input className="w-full bg-black/50 border border-zinc-700 rounded-lg text-xs px-2 py-1.5 text-white focus:border-emerald-500 outline-none" placeholder={t('att', 'search')} value={attendanceSearchTerm} onChange={e => setAttendanceSearchTerm(e.target.value)} /></div>
                    <div className="flex justify-between items-center mb-2 px-1"><span className="text-xs text-zinc-500">Selected: {attTab === 'trainees' ? attendanceList.length : coachAttendanceList.length}</span><button onClick={toggleAllAttendanceStatus} className="text-xs text-indigo-400 hover:text-indigo-300 font-bold border border-indigo-500/30 px-2 py-1 rounded">{t('att', 'toggle')}</button></div>
                    <div className="flex-1 overflow-y-auto space-y-2 mb-4 pr-1">{attendanceFiltered.map(item => (<div key={item.id} onClick={() => toggleAttendance(item.id)} className={`flex items-center justify-between p-3 rounded-xl border cursor-pointer transition-all ${(attTab === 'trainees' ? attendanceList.includes(item.id) : coachAttendanceList.includes(item.id)) ? 'bg-emerald-900/20 border-emerald-500/50' : 'bg-zinc-800/50 border-zinc-700'}`}><div className="flex items-center gap-3"><div className={`w-5 h-5 rounded-full flex items-center justify-center border ${(attTab === 'trainees' ? attendanceList.includes(item.id) : coachAttendanceList.includes(item.id)) ? 'bg-emerald-500 border-emerald-500' : 'border-zinc-500'}`}>{(attTab === 'trainees' ? attendanceList.includes(item.id) : coachAttendanceList.includes(item.id)) && <i className="fa-solid fa-check text-black text-xs"></i>}</div><div><p className="text-sm font-bold text-white">{item.name}</p><p className="text-[10px] text-zinc-500">{item.team || item.role}</p></div></div></div>))}</div>
                    <div className="flex gap-2"><button onClick={submitAttendance} className="flex-1 py-3 bg-emerald-600 hover:bg-emerald-500 text-white font-bold rounded-xl shadow-lg shadow-emerald-900/20">{t('att', 'save')}</button><button onClick={handleExportAttendanceExcel} className="px-4 py-3 bg-green-700 hover:bg-green-600 text-white font-bold rounded-xl shadow-lg flex items-center gap-2" title={t('att', 'excel')}><i className="fa-solid fa-file-csv"></i></button><button onClick={handleWhatsappShare} className="px-4 py-3 bg-[#25D366] hover:bg-[#1da851] text-white font-bold rounded-xl shadow-lg" title={t('attWhatsapp')}><i className="fa-brands fa-whatsapp text-xl"></i></button></div></div></div>)}

                    {modals.finance && (<div className="fixed inset-0 z-[80] flex items-center justify-center p-4 bg-black/90 backdrop-blur-sm fade-in"><div className="bg-zinc-900 w-full max-w-lg rounded-2xl border border-yellow-600 shadow-2xl p-6 max-h-[90vh] overflow-y-auto flex flex-col"><div className="flex justify-between items-center mb-4"><h2 className="text-xl font-bold text-white flex items-center gap-2"><i className="fa-solid fa-sack-dollar text-yellow-500"></i> {t('fin', 'title')}</h2><div className="flex items-center gap-2"><input type="month" className="bg-zinc-800 text-white text-xs px-2 py-1 rounded border border-zinc-600 focus:border-yellow-500 outline-none" value={financeMonth} onChange={(e) => setFinanceMonth(e.target.value)} /><button onClick={() => toggleM('finance', 0)}><i className="fa-solid fa-xmark text-xl text-zinc-500 hover:text-white"></i></button></div></div><div className="bg-yellow-900/20 border border-yellow-800 p-3 rounded-xl mb-4 flex justify-between items-center relative group"><div className="text-xs text-yellow-200"><p className="font-bold">{BANK_INFO.bankName}</p><p className="font-mono text-yellow-400 text-sm my-0.5">{BANK_INFO.accNum}</p><p className="text-[10px] opacity-70">{BANK_INFO.holder}</p></div><button onClick={copyBankInfo} className="bg-yellow-700/50 hover:bg-yellow-600 text-white px-3 py-1.5 rounded-lg text-xs font-bold transition-all flex items-center gap-1"><i className="fa-regular fa-copy"></i> {t('fin', 'copy')}</button></div><div className="grid grid-cols-2 gap-3 mb-4"><div className="bg-emerald-900/30 border border-emerald-800 p-3 rounded-xl flex flex-col items-center"><span className="text-[10px] text-emerald-400 uppercase">{t('fin', 'total')}</span><span className="text-xl font-bold text-white">RM {financeSummary.total}</span><span className="text-[10px] text-zinc-400">({financeSummary.paidCount} pax)</span></div><div className="bg-red-900/30 border border-red-800 p-3 rounded-xl flex flex-col items-center"><span className="text-[10px] text-red-400 uppercase">{t('fin', 'pending')}</span><span className="text-xl font-bold text-white">RM {financeSummary.pending}</span><span className="text-[10px] text-zinc-400">({filteredTrainees.length - financeSummary.paidCount} pax)</span></div></div><div className="mb-2 px-1"><input className="w-full bg-black/50 border border-zinc-700 rounded-lg text-xs px-2 py-1.5 text-white focus:border-yellow-500 outline-none" placeholder={t('fin', 'search')} value={financeSearchTerm} onChange={e => setFinanceSearchTerm(e.target.value)} /></div><div className="flex justify-between items-center mb-2 px-1"><span className="text-xs text-zinc-500">Selected: {financeFiltered.length}</span><button onClick={toggleAllFeeStatus} className="text-xs text-indigo-400 hover:text-indigo-300 font-bold border border-indigo-500/30 px-2 py-1 rounded">{t('fin', 'toggle')}</button></div><div className="flex gap-2 mb-4"><div className="flex-1 flex justify-between items-center bg-zinc-950 p-2 rounded-lg border border-zinc-800"><span className="text-xs text-zinc-400 pl-2">{t('fin', 'fee')}</span><input type="number" className="w-20 bg-black text-white text-right text-sm px-2 py-1 rounded border border-zinc-700 focus:border-yellow-500 outline-none" value={monthlyFee} onChange={e => setMonthlyFee(parseInt(e.target.value) || 0)} /></div><select className="w-1/3 bg-zinc-950 border border-zinc-800 rounded-lg text-white text-xs px-2 outline-none" value={msgTemplate} onChange={(e) => setMsgTemplate(e.target.value)}><option value="gentle">ðŸŒ¸ {t('msgTemplates', 'gentle')}</option><option value="friendly">ðŸ¤ {t('msgTemplates', 'friendly')}</option><option value="soft">ðŸƒ {t('msgTemplates', 'soft')}</option><option value="formal">ðŸ‘” {t('msgTemplates', 'formal')}</option></select></div><div className="flex-1 overflow-y-auto space-y-2 mb-4 pr-1">{financeFiltered.map(trainee => { const isPaid = trainee.feeHistory && trainee.feeHistory[financeMonth]; return (<div key={trainee.id} className="flex items-center justify-between p-3 rounded-xl border border-zinc-700 bg-zinc-800/30"><div className="flex items-center gap-3"><div className={`w-8 h-8 rounded-full flex items-center justify-center font-bold text-xs ${isPaid ? 'bg-emerald-600 text-white' : 'bg-red-900/50 text-red-500 border border-red-800'}`}>{isPaid ? <i className="fa-solid fa-check"></i> : "RM"}</div><div><p className="text-sm font-bold text-white">{trainee.name}</p><p className="text-[10px] text-zinc-500">{trainee.team}</p></div></div><div className="flex items-center gap-2">{!isPaid && (<button onClick={() => sendFeeReminder(trainee)} className="w-8 h-8 rounded-full bg-[#25D366]/20 hover:bg-[#25D366] text-[#25D366] hover:text-white border border-[#25D366]/50 flex items-center justify-center transition-all" title={t('finRemind')}><i className="fa-brands fa-whatsapp"></i></button>)}<button onClick={() => toggleFeeStatus(trainee.id)} className={`px-3 py-1.5 rounded-lg text-xs font-bold transition-all border ${isPaid ? 'bg-emerald-600 border-emerald-500 text-white' : 'bg-transparent border-zinc-600 text-zinc-400 hover:border-yellow-500 hover:text-yellow-500'}`}>{isPaid ? t('common', 'paid') : t('common', 'unpaid')}</button></div></div>); })}</div><button onClick={exportFinanceExcel} className="w-full py-3 bg-zinc-800 hover:bg-zinc-700 text-white font-bold rounded-xl border border-zinc-600 flex items-center justify-center gap-2"><i className="fa-solid fa-file-invoice-dollar"></i> {t('fin', 'export')}</button></div></div>)}
                    {modals.share && (<div className="fixed inset-0 z-[6000] bg-black/90 backdrop-blur-sm flex items-center justify-center p-6 fade-in" onClick={() => toggleM('share', 0)}><div className="bg-zinc-900 border border-zinc-800 w-full max-w-sm rounded-[2.5rem] p-8 text-center shadow-2xl shadow-black" onClick={e => e.stopPropagation()}><div className="w-20 h-20 bg-zinc-800 rounded-3xl mx-auto mb-6 flex items-center justify-center border-2 border-zinc-700 shadow-xl overflow-hidden leading-none">{appLogo ? <img src={appLogo} className="w-full h-full object-cover"/> : <i className="fa-solid fa-shield-halved text-yellow-500 text-4xl"></i>}</div><h2 className="text-2xl font-black text-white mb-2 tracking-tight uppercase tracking-widest leading-none">CFC YOUTH ACADEMY</h2><p className="text-zinc-500 text-sm mb-8 leading-relaxed px-4">ä½¿ç”¨æµè§ˆå™¨â€œæ·»åŠ åˆ°ä¸»å±å¹•â€å®‰è£… App</p><div className="bg-white p-4 rounded-[2rem] mb-8 w-fit mx-auto shadow-2xl"><img src={`https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=${encodeURIComponent(shareUrl)}&margin=10`} className="w-48 h-48 rounded-lg" alt="QR"/></div><button onClick={() => { safeCopy(shareUrl, t('alerts', 'linkCopied')); }} className="w-full py-4 bg-zinc-100 text-zinc-900 rounded-2xl font-black transition-all active:scale-95 flex items-center justify-center gap-2 uppercase text-sm tracking-widest shadow-xl"><i className="fa-solid fa-link"></i> {t('share', 'copy')}</button></div></div>)}
                    {modals.cloud && (<div className="fixed inset-0 z-[80] flex items-center justify-center p-4 bg-black/90 backdrop-blur-sm fade-in"><div className="bg-zinc-900 w-full max-w-sm rounded-2xl border border-emerald-700 shadow-2xl p-6"><div className="flex justify-between items-center mb-4"><h2 className="text-xl font-bold text-white flex items-center gap-2"><i className="fa-solid fa-cloud text-emerald-500"></i> {t('cloud', 'setup')}</h2><button onClick={() => toggleM('cloud', 0)}><i className="fa-solid fa-xmark text-zinc-500 hover:text-white"></i></button></div><div className="space-y-4"><p className="text-sm text-zinc-400 leading-relaxed">{t('cloudDesc')}</p><div className="bg-black p-3 rounded-lg border border-zinc-700"><label className="text-xs text-zinc-500 block mb-1 font-bold">{t('cloud', 'key')}</label><input className="w-full bg-transparent text-white outline-none font-mono text-sm" placeholder="X-Master-Key" value={cloudConfig.key} onChange={e => setCloudConfig({...cloudConfig, key: e.target.value})} /></div><div className="bg-black p-3 rounded-lg border border-zinc-700"><label className="text-xs text-zinc-500 block mb-1 font-bold">{t('cloud', 'bin')}</label><input className="w-full bg-transparent text-white outline-none font-mono text-sm" placeholder="Bin ID" value={cloudConfig.binId} onChange={e => setCloudConfig({...cloudConfig, binId: e.target.value})} /></div><div className="border-t border-zinc-800 pt-2 mt-2"><button onClick={createCloudBin} className="w-full py-2 bg-zinc-800 hover:bg-zinc-700 text-emerald-400 text-xs font-bold rounded-lg border border-emerald-900/30 mb-3">{t('cloudCreate')}</button></div>
                    <div className="pt-2 mt-2 border-t border-zinc-700"><label className="text-sm text-blue-400 font-bold mb-2 block flex items-center gap-2"><i className="fa-solid fa-image"></i> {t('cloud', 'imageCloud')}</label><p className="text-xs text-zinc-500 mb-2">{t('imgCloudDesc')}</p><div className="bg-black p-3 rounded-lg border border-zinc-700 mb-2"><label className="text-xs text-zinc-500 block mb-1 font-bold">{t('cloud', 'name')}</label><input className="w-full bg-transparent text-white outline-none font-mono text-sm" placeholder="e.g. dxyz..." value={imgConfig.cloudName} onChange={e => setImgConfig({...imgConfig, cloudName: e.target.value})} /></div><div className="bg-black p-3 rounded-lg border border-zinc-700 mb-2"><label className="text-xs text-zinc-500 block mb-1 font-bold">{t('cloud', 'preset')}</label><input className="w-full bg-transparent text-white outline-none font-mono text-sm" placeholder="e.g. cfc_preset" value={imgConfig.uploadPreset} onChange={e => setImgConfig({...imgConfig, uploadPreset: e.target.value})} /></div><div className="flex gap-2"><button onClick={testCloudinary} className="flex-1 py-2 bg-zinc-700 hover:bg-zinc-600 text-white text-xs font-bold rounded-lg border border-zinc-600">{t('cloud', 'imgTest')}</button><button onClick={saveImgConfig} className="flex-1 py-2 bg-blue-900/50 hover:bg-blue-800 text-blue-400 text-xs font-bold rounded-lg border border-blue-900/30">{t('cloud', 'saveImg')}</button></div></div><button onClick={handleConnectCloud} className="w-full py-3 bg-emerald-600 hover:bg-emerald-500 text-white font-bold rounded-xl shadow-lg transition-transform active:scale-95 mt-2">{t('cloud', 'connect')}</button></div></div></div>)}
                    {modals.data && (<div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/90 backdrop-blur-sm fade-in"><div className="bg-zinc-900 w-full max-w-md rounded-2xl border border-zinc-800 shadow-2xl p-6"><div className="flex justify-between items-center mb-4"><h2 className="text-lg font-bold text-white flex items-center gap-2"><i className="fa-solid fa-cloud-arrow-up text-indigo-500"></i> {t('backupTools')}</h2><button onClick={() => toggleM('data', 0)}><i className="fa-solid fa-xmark text-zinc-500 hover:text-white"></i></button></div><div className="space-y-4"><div className="bg-zinc-950 p-4 rounded-xl border border-zinc-800 relative group overflow-hidden"><div className="absolute top-0 right-0 p-2 opacity-20"><i className="fab fa-google-drive text-6xl text-white"></i></div><h3 className="text-white font-bold mb-2 flex items-center gap-2 z-10 relative"><i className="fa-solid fa-cloud-upload-alt text-emerald-500"></i> {t('backup', 'drive')}</h3><p className="text-zinc-500 text-xs mb-3 relative z-10">{t('backup', 'desc')}</p><button onClick={handleBackupToDrive} className="w-full py-3 bg-emerald-700 hover:bg-emerald-600 text-white rounded-xl font-bold text-sm shadow-lg transition flex items-center justify-center gap-2 relative z-10 border border-emerald-500"><i className="fab fa-google-drive"></i> {t('common', 'save')}</button></div><div className="bg-zinc-950 p-4 rounded-xl border border-zinc-800"><h3 className="text-zinc-300 font-bold mb-2 flex items-center gap-2"><i className="fa-solid fa-file-import text-indigo-500"></i> {t('backup', 'restore')}</h3><p className="text-zinc-500 text-xs mb-3">{t('backup', 'desc')}</p><div className="relative group"><button className="w-full py-3 bg-zinc-800 hover:bg-zinc-700 text-indigo-400 border border-indigo-900/50 rounded-xl font-bold text-sm shadow-lg transition flex items-center justify-center gap-2 cursor-pointer" onClick={() => backupInputRef.current.click()}><i className="fa-solid fa-folder-open"></i> {t('backup', 'select')}</button><input type="file" ref={backupInputRef} className="hidden" accept=".json" onChange={handleImportFile} /></div></div></div><p className="text-center text-zinc-600 text-xs mt-6">{t('backup', 'safe')}</p></div></div>)}
                    {modals.cropper && (<div className="fixed inset-0 z-[10000] bg-black flex flex-col items-center justify-center p-4 font-black"><h3 className="text-white mb-8 tracking-[0.2em] uppercase text-xl text-center font-bold">Crop Image</h3><div className="max-w-full max-h-[60vh] bg-zinc-900 rounded-[2.5rem] overflow-hidden mb-10 shadow-2xl border border-zinc-800 shadow-black"><img ref={cropperImageRef} src={tempImage} style={{maxWidth: '100%'}} /></div><div className="flex gap-4 w-full max-w-sm"><button onClick={handleCropConfirm} className="flex-[2] py-5 bg-emerald-600 rounded-3xl text-white shadow-xl text-lg uppercase tracking-widest active:scale-95 transition-transform font-black leading-none">Confirm</button><button onClick={() => {setIsCropperOpen(false); setTempImage(null);}} className="flex-1 py-5 bg-red-600 rounded-3xl text-white shadow-lg uppercase active:scale-95 transition-transform font-black leading-none">Cancel</button></div></div>)}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
